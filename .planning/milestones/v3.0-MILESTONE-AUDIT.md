---
milestone: v3.0
audited: 2026-02-17
status: tech_debt
scores:
  requirements: 13/13
  phases: 4/5 verified (Phase 21 missing VERIFICATION.md)
  integration: 8/10 flows complete
  flows: 8/10 (2 have issues)
gaps: []
tech_debt:
  - phase: 22-module-migration
    items:
      - "Connection leak in search_chunks_hybrid: connect_ragnar_store() opens DuckDB connection that is never closed (R/db.R:710)"
      - "Section hint not encoded into ragnar origin for PDF chunks — fallback to chunks table prefix lookup works but is fragile"
  - phase: 20-foundation-connection-safety
    items:
      - "Dead code: with_ragnar_store() defined but never called (R/_ragnar.R:296)"
      - "Dead code: register_ragnar_cleanup() defined but never called (R/_ragnar.R:349)"
      - "check_ragnar_version() removed in Phase 23 (ragnar became hard dependency) — FNDTN-03 intent satisfied differently"
  - phase: 21-store-lifecycle
    items:
      - "Missing VERIFICATION.md — phase was not formally verified (summaries confirm completion)"
  - phase: 22-module-migration
    items:
      - "6 human verification items deferred (per-notebook isolation, migration modal, async re-index, paper delete, section filtering)"
---

# Milestone v3.0 Audit Report: Ragnar RAG Overhaul

**Audited:** 2026-02-17
**Status:** tech_debt (all requirements met, no critical blockers, accumulated debt)

## Phase Verification Summary

| Phase | Name | Verification | Status | Score |
|-------|------|-------------|--------|-------|
| 20 | Foundation & Connection Safety | 20-VERIFICATION.md | PASSED | 4/4 |
| 21 | Store Lifecycle | **MISSING** | Unverified | — |
| 22 | Module Migration | 22-VERIFICATION.md | human_needed | 4/4 automated |
| 23 | Legacy Code Removal | 23-01-VERIFICATION.md | PASSED | 6/6 |
| 24 | Integration Testing & Cleanup | 24-VERIFICATION.md | PASSED | 4/4 |

### Phase 21: Missing Verification

Phase 21 has no VERIFICATION.md file. Both plans (21-01, 21-02) have SUMMARY.md files confirming completion:
- 21-01: 5 lifecycle functions added (ensure_ragnar_store, check_store_integrity, delete_notebook_store, find_orphaned_stores, rebuild_notebook_store)
- 21-02: Corruption detection UI, rebuild modal, orphan cleanup button

Evidence from downstream phases confirms Phase 21 outputs are wired and functional.

### Phase 22: Human Verification Deferred

6 items require manual runtime verification:
1. Per-notebook retrieval isolation (upload PDF, chat, verify correct store)
2. Notebook switch triggers correct store
3. Migration modal appearance and button disabled state
4. Async re-index with Stop cancellation
5. Paper removal deletes chunks from ragnar store
6. Section-targeted synthesis retrieval

## Requirements Coverage

| Requirement | Phase | Status | Evidence |
|-------------|-------|--------|----------|
| FNDTN-01: Deterministic per-notebook paths | 20 | SATISFIED | `get_notebook_ragnar_path()` verified in Phase 20 |
| FNDTN-02: Section_hint metadata round-trip | 20 | SATISFIED | `encode/decode_origin_metadata()` verified |
| FNDTN-03: App checks ragnar version | 20→23 | SATISFIED (modified) | Originally version check; Phase 23 made ragnar hard dependency, removing need for conditional check |
| TEST-02: Connection lifecycle management | 20 | SATISFIED | `on.exit()` and `session$onSessionEnded()` patterns verified |
| LIFE-01: Store auto-created on first content | 21 | SATISFIED | `ensure_ragnar_store()` confirmed in both module handlers |
| LIFE-02: Store deleted with notebook | 21 | SATISFIED | `delete_notebook_store()` called from `delete_notebook()` in db.R |
| LIFE-03: User can rebuild index | 21 | SATISFIED | Rebuild modal with progress in both modules |
| LIFE-04: Corruption detection and prompt | 21 | SATISFIED | `check_store_integrity()` on notebook open, modal on failure |
| LEGC-01: No ragnar_available() branches | 23 | SATISFIED | Zero grep results confirmed |
| LEGC-02: No legacy cosine similarity | 23 | SATISFIED | Zero grep results confirmed |
| LEGC-03: Shared store deleted on startup | 24 | SATISFIED | `data/serapeum.ragnar.duckdb` absent, deletion logic in app.R |
| LEGC-04: digest dependency removed | 23 | SATISFIED | `rlang::hash()` replaces `digest::digest()` |
| TEST-01: Integration tests cover full workflow | 24 | SATISFIED | 3 tests, 14 assertions, all passing |

**Score: 13/13 requirements satisfied**

## Cross-Phase Integration

### E2E Flow Status

| # | Flow | Status | Notes |
|---|------|--------|-------|
| 1 | PDF Upload | COMPLETE | Per-notebook store via ensure_ragnar_store |
| 2 | Abstract Embed | COMPLETE | encode_origin_metadata → insert → mark_as_ragnar_indexed |
| 3 | Migration Flow | COMPLETE | Both modules detect missing store, async re-index |
| 4 | Chat/RAG | FUNCTIONAL WITH LEAK | Results correct; store connection never closed in search_chunks_hybrid |
| 5 | Section-targeted Synthesis | PARTIAL | PDF chunks lack section_hint in ragnar origin; fallback works |
| 6 | Paper Delete | COMPLETE | delete_abstract_chunks_from_ragnar wired |
| 7 | Notebook Delete | COMPLETE | DB cascade → file deletion wired |
| 8 | Corruption Recovery | COMPLETE | Integrity check → modal → rebuild → healthy |
| 9 | Legacy Cleanup | COMPLETE | Startup detection → deletion → deferred toast |
| 10 | Orphan Cleanup | COMPLETE | Settings button → find_orphaned_stores → deletion |

### Integration Issues

**Issue 1: Connection Leak in search_chunks_hybrid (Medium)**
- `R/db.R:710` — `connect_ragnar_store()` opens DuckDB connection, never disconnected
- Every `rag_query()` or `generate_conclusions_preset()` call leaks a connection
- Fix: Add `on.exit(DBI::dbDisconnect(store@con, shutdown=TRUE), add=TRUE)` or use `with_ragnar_store()`

**Issue 2: Section Hint Missing from PDF Ragnar Origins (Low-Medium)**
- `chunk_with_ragnar()` produces plain `"filename#page=N"` origins without section_hint encoding
- `search_chunks_hybrid` falls back to content-prefix lookup in `chunks` table for section filtering
- Fix: Call `encode_origin_metadata()` when inserting PDF chunks into ragnar store

**Issue 3: Dead Code (Low)**
- `with_ragnar_store()` (R/_ragnar.R:296) — 0 callers
- `register_ragnar_cleanup()` (R/_ragnar.R:349) — 0 callers
- These were designed in Phase 20 but Phase 22 modules adopted different patterns

## Tech Debt Summary

| Item | Severity | Phase | Recommendation |
|------|----------|-------|----------------|
| Connection leak in search_chunks_hybrid | Medium | 22 | Fix in next milestone (add on.exit cleanup) |
| Section hint not in PDF ragnar origins | Low-Medium | 22 | Fix in next milestone (encode section_hint) |
| Dead code: with_ragnar_store, register_ragnar_cleanup | Low | 20 | Remove or adopt in next milestone |
| Phase 21 missing VERIFICATION.md | Low | 21 | Accept — downstream phases confirm functionality |
| 6 human verification items deferred | Low | 22 | Manual UAT before public release |

**Total: 5 tech debt items across 3 phases. No critical blockers.**

## Verdict

All 13 requirements are satisfied. All 5 phases have completed plans with summaries. 8/10 E2E flows are fully complete; 2 have non-blocking issues (connection leak, partial section filtering). The milestone goal — "Replace the legacy embedding/retrieval system with ragnar as the sole RAG backend, using per-notebook vector stores for clean isolation and optimal retrieval" — is achieved.

**Recommendation:** Proceed with milestone completion. Track connection leak and section hint encoding as first items in next milestone.

---
*Audited: 2026-02-17*
*Auditor: Claude (gsd-audit-milestone)*
