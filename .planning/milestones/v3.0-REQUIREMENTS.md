# Requirements Archive: v3.0 Ragnar RAG Overhaul

**Archived:** 2026-02-17
**Status:** SHIPPED

---

## v3.0 Requirements

Requirements for ragnar RAG overhaul. All 13 requirements satisfied.

### Store Foundation

- [x] **FNDTN-01**: Per-notebook ragnar store paths use deterministic `data/ragnar/{notebook_id}.duckdb` convention — Phase 20
- [x] **FNDTN-02**: Section_hint metadata is encoded in ragnar's origin field and decoded on retrieval — Phase 20
- [x] **FNDTN-03**: App checks ragnar version on startup and warns if incompatible — Phase 20 (later simplified: ragnar became hard dependency in Phase 23, removing need for conditional check)

### Store Lifecycle

- [x] **LIFE-01**: Ragnar store is created automatically on first PDF upload or abstract embed for a notebook — Phase 21
- [x] **LIFE-02**: Ragnar store file is deleted when its notebook is deleted — Phase 21
- [x] **LIFE-03**: User can re-build a notebook's search index via a "Re-build Index" button — Phase 21
- [x] **LIFE-04**: Corrupted or missing ragnar store is detected on connect and user is prompted to re-build — Phase 21

### Legacy Removal

- [x] **LEGC-01**: All `ragnar_available()` conditional branches are removed — ragnar is the sole RAG path — Phase 23
- [x] **LEGC-02**: Legacy cosine similarity search and manual `get_embeddings()` calls are removed — Phase 23
- [x] **LEGC-03**: Shared `data/serapeum.ragnar.duckdb` store is deleted on app startup if per-notebook stores exist — Phase 24
- [x] **LEGC-04**: digest package dependency is removed (replaced by rlang::hash) — Phase 23

### Testing & Reliability

- [x] **TEST-01**: Integration tests cover upload PDF -> chunk -> embed -> query with per-notebook stores — Phase 24
- [x] **TEST-02**: Ragnar store connections use explicit `on.exit()` cleanup and `session$onSessionEnded()` lifecycle management — Phase 20

## Traceability

| Requirement | Phase | Status |
|-------------|-------|--------|
| FNDTN-01 | Phase 20 | SATISFIED |
| FNDTN-02 | Phase 20 | SATISFIED |
| FNDTN-03 | Phase 20/23 | SATISFIED (modified approach) |
| TEST-02 | Phase 20 | SATISFIED |
| LIFE-01 | Phase 21 | SATISFIED |
| LIFE-02 | Phase 21 | SATISFIED |
| LIFE-03 | Phase 21 | SATISFIED |
| LIFE-04 | Phase 21 | SATISFIED |
| (Module Migration) | Phase 22 | SATISFIED |
| LEGC-01 | Phase 23 | SATISFIED |
| LEGC-02 | Phase 23 | SATISFIED |
| LEGC-04 | Phase 23 | SATISFIED |
| TEST-01 | Phase 24 | SATISFIED |
| LEGC-03 | Phase 24 | SATISFIED |

**Coverage:** 13/13 requirements satisfied

## Future Requirements (Carried Forward)

### Store Management
- **MGMT-01**: Per-notebook ragnar store file size visible in UI
- **MGMT-02**: Health check on app startup detects corrupted stores with non-blocking toast
- **MGMT-03**: Last-indexed timestamp displayed per notebook

### Advanced RAG
- **ARAG-01**: Incremental re-embedding — only re-embed changed/new content
- **ARAG-02**: Export/import notebook with ragnar store for portability
- **ARAG-03**: Parallel re-embedding during re-build for faster processing

## Out of Scope (Validated)

| Feature | Reason | Outcome |
|---------|--------|---------|
| Cross-notebook search | Contradicts per-notebook isolation goal | Correct — isolation is core benefit |
| Manual store path configuration | Support burden, broken paths | Correct — deterministic paths work well |
| Shared store with namespace filtering | Defeats isolation, corruption breaks all notebooks | Correct — per-notebook is cleaner |
| Real-time background re-indexing | PDFs are immutable after upload, no clear trigger | Correct — on-demand is sufficient |
| Migration script for shared store | User decided to delete and re-embed fresh | Correct — clean start preferred |
| Ragnar version pinning per notebook | Over-engineering, single version app-wide is sufficient | Correct — renv handles versioning |

---
*Requirements defined: 2026-02-16*
*Archived: 2026-02-17 after v3.0 milestone completion*
