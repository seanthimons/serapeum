---
phase: 27-research-question-generator
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - R/rag.R
  - R/mod_search_notebook.R
  - R/mod_document_notebook.R
autonomous: true

must_haves:
  truths:
    - "User sees a Research Questions button in the search notebook preset panel"
    - "User clicks Research Questions and receives 5-7 numbered questions (or 3-4 for small notebooks) each with a 2-3 sentence rationale citing specific papers by author/year"
    - "Research question output renders as a numbered markdown list in the chat panel with the AI-generated content disclaimer"
  artifacts:
    - path: "R/rag.R"
      provides: "generate_research_questions() function"
      contains: "generate_research_questions"
    - path: "R/mod_search_notebook.R"
      provides: "Research Questions button and observeEvent handler"
      contains: "btn_research_questions"
    - path: "R/mod_document_notebook.R"
      provides: "Updated disclaimer check for research_questions preset_type"
      contains: "research_questions"
  key_links:
    - from: "R/mod_search_notebook.R"
      to: "R/rag.R"
      via: "observeEvent calls generate_research_questions()"
      pattern: "generate_research_questions\\("
    - from: "R/mod_search_notebook.R"
      to: "chat message renderer"
      via: "preset_type = research_questions triggers AI disclaimer"
      pattern: "research_questions"
    - from: "R/mod_document_notebook.R"
      to: "chat message renderer"
      via: "disclaimer check widened to include research_questions"
      pattern: "research_questions"
---

<objective>
Add a Research Questions synthesis preset to the search notebook that generates gap-grounded, PICO-informed research questions from the notebook's papers.

Purpose: Researchers can derive structured research questions from their collected papers, grounded in identified gaps and citing specific papers by author/year.
Output: Working Research Questions button in search notebook preset panel, generating numbered markdown questions with inline rationales.
</objective>

<execution_context>
@/home/sean/.claude/get-shit-done/workflows/execute-plan.md
@/home/sean/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@/home/sean/Documents/serapeum/.planning/PROJECT.md
@/home/sean/Documents/serapeum/.planning/ROADMAP.md
@/home/sean/Documents/serapeum/.planning/STATE.md
@/home/sean/Documents/serapeum/.planning/phases/27-research-question-generator/27-CONTEXT.md
@/home/sean/Documents/serapeum/.planning/phases/27-research-question-generator/27-RESEARCH.md
@/home/sean/Documents/serapeum/R/rag.R
@/home/sean/Documents/serapeum/R/mod_search_notebook.R
@/home/sean/Documents/serapeum/R/mod_document_notebook.R
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create generate_research_questions() in rag.R</name>
  <files>R/rag.R</files>
  <action>
Add a new function `generate_research_questions()` after `generate_conclusions_preset()` (after line ~393). Clone the structure of `generate_conclusions_preset()` with these specific changes:

**Function signature:**
```r
generate_research_questions <- function(con, config, notebook_id, notebook_type = "search", session_id = NULL)
```

**Key differences from generate_conclusions_preset:**

1. **Early return for small notebooks:** Query `SELECT COUNT(*) FROM abstracts WHERE notebook_id = ?`. If count < 2, return early with message: "At least 2 papers are needed to identify research gaps and generate research questions."

2. **Paper metadata query:** Query `SELECT id, title, authors, year FROM abstracts WHERE notebook_id = ?`. Parse authors JSON with `jsonlite::fromJSON()`, format as "LastName et al. (Year)" for >2 authors, "A & B (Year)" for 2, single name for 1. Build a `paper_list_text` string with one line per paper: `- Author (Year): "Title"`.

3. **RAG retrieval:** Use `search_chunks_hybrid()` with query = `"research gaps limitations future work methodology population understudied contradictions"` and limit = 15. For search notebooks, NO section_filter (abstracts lack section structure). Include the same fallback chain as conclusions (hybrid -> direct DB).

4. **System prompt:** Use the exact prompt from 27-RESEARCH.md "Complete Prompt Structure" section. Key elements: gap analyst role, PICO-invisible adaptive framing, 2-3 sentence rationales with author/year citations, grouped by gap type, scaling rules (2-3 papers -> 3-4 questions, 5+ papers -> 5-7 questions). Include the paper count in the system prompt scaling instruction so the LLM knows the collection size.

5. **User prompt:** Format as:
```
===== PAPER METADATA =====
{paper_list_text}

===== RETRIEVED CONTENT =====
{context from build_context()}
===== END SOURCES =====

This collection contains {paper_count} papers. Analyze the research above and generate research questions that address identified gaps.
```

6. **Cost logging:** Use category `"research_questions"` (not `"conclusion_synthesis"`).

7. **Error handling:** Same tryCatch pattern as conclusions. Return error string on failure.

Do NOT add this to `generate_preset()` — per user decision, this is a separate function.
  </action>
  <verify>
Grep for `generate_research_questions` in R/rag.R confirms function exists. Check that it contains: `search_chunks_hybrid`, `build_context`, `format_chat_messages`, `chat_completion`, `log_cost`, `paper_list_text`, and the scaling instruction text.
  </verify>
  <done>
`generate_research_questions()` exists in rag.R as a standalone function that: retrieves chunks via hybrid search with limit=15, queries paper metadata from abstracts table, constructs a gap-analysis prompt with PICO-invisible framing, includes paper count scaling rules, logs cost under "research_questions" category, and returns markdown string.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire Research Questions button and fix disclaimer in UI modules</name>
  <files>R/mod_search_notebook.R, R/mod_document_notebook.R</files>
  <action>
**mod_search_notebook.R — three changes:**

1. **Add button to preset bar (near line 252):** After the `uiOutput(ns("conclusions_btn_ui"))` line, add:
```r
uiOutput(ns("research_questions_btn_ui"))
```

2. **Add renderUI for the button (after the conclusions_btn_ui renderUI around line 565-578):** Clone the conclusions button renderUI pattern:
```r
output$research_questions_btn_ui <- renderUI({
  if (isTRUE(rag_available())) {
    actionButton(ns("btn_research_questions"), "Research Questions",
                 class = "btn-sm btn-outline-primary",
                 icon = icon("lightbulb"))
  } else {
    tags$button(
      class = "btn btn-sm btn-outline-primary disabled",
      disabled = "disabled",
      title = "Synthesis unavailable - re-index this notebook first",
      icon("lightbulb"), " Research Questions"
    )
  }
})
```

3. **Add observeEvent handler (after the conclusions handler around line 2312-2344):** Clone the conclusions handler pattern from 27-RESEARCH.md "Handler Wiring" section. Key details:
- Guard: `req(!is_processing())` and `req(has_api_key())`
- User message: `content = "Generate: Research Questions"`, `preset_type = "research_questions"`
- Call: `generate_research_questions(con(), cfg, nb_id, notebook_type = "search", session_id = session$token)`
- Assistant message: same `preset_type = "research_questions"`
- Error handling: same tryCatch with `classify_api_error` pattern as conclusions handler

4. **Fix disclaimer check (line 2233):** Change:
```r
is_synthesis <- !is.null(msg$preset_type) && identical(msg$preset_type, "conclusions")
```
To:
```r
is_synthesis <- !is.null(msg$preset_type) && msg$preset_type %in% c("conclusions", "research_questions")
```

**mod_document_notebook.R — one change:**

5. **Fix disclaimer check (line 600):** Same change as above — widen `identical(msg$preset_type, "conclusions")` to `msg$preset_type %in% c("conclusions", "research_questions")`. This ensures if research questions are ever exposed in document notebooks, the disclaimer works correctly.
  </action>
  <verify>
1. Grep for `btn_research_questions` in mod_search_notebook.R — should appear in UI output, renderUI, and observeEvent.
2. Grep for `research_questions` in both mod_search_notebook.R and mod_document_notebook.R — should appear in disclaimer checks.
3. Grep for `generate_research_questions` in mod_search_notebook.R — should appear in the observeEvent handler.
  </verify>
  <done>
Search notebook has a "Research Questions" button in the preset panel that: enables/disables based on rag_available(), calls generate_research_questions() on click, adds user and assistant messages with preset_type "research_questions", and triggers the AI-generated content disclaimer. Both mod_search_notebook.R and mod_document_notebook.R disclaimer checks accept "research_questions" as a synthesis preset type.
  </done>
</task>

</tasks>

<verification>
1. `grep -n "generate_research_questions" R/rag.R` — function definition exists
2. `grep -n "btn_research_questions" R/mod_search_notebook.R` — button wired in UI, renderUI, and handler
3. `grep -n "research_questions" R/mod_search_notebook.R R/mod_document_notebook.R` — disclaimer checks widened in both files
4. `grep -n "paper_list_text\|PAPER METADATA" R/rag.R` — paper metadata enrichment present in prompt
5. `grep -n "log_cost.*research_questions" R/rag.R` — cost logging uses correct category
</verification>

<success_criteria>
- generate_research_questions() exists as a standalone function in rag.R (NOT inside generate_preset())
- Function queries abstracts table for paper count and metadata (authors, year, title)
- Function returns early with message if < 2 papers
- Prompt includes PICO-invisible adaptive framing, gap-type grouping, scaling rules, and citation format instructions
- RAG query uses gap-focused terms with limit=15
- Research Questions button visible in search notebook preset panel
- Click triggers LLM call and renders numbered markdown in chat
- AI-generated content disclaimer appears on research questions output
- Cost logged under "research_questions" category
</success_criteria>

<output>
After completion, create `.planning/phases/27-research-question-generator/27-01-SUMMARY.md`
</output>
