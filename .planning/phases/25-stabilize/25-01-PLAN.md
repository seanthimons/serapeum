---
phase: 25-stabilize
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app.R
  - R/mod_search_notebook.R
  - R/cost_tracking.R
  - R/api_openrouter.R
autonomous: true

must_haves:
  truths:
    - "User sees seed paper as the first result in abstract search results for seed-discovery notebooks"
    - "User sees only one modal/toast when removing an abstract or blocking a journal (no duplicates)"
    - "User sees accurate cost tracking for non-default models after each LLM request"
    - "User sees correct paper count reflecting only newly-added papers after a search refresh"
    - "User can dismiss duplicate toast notifications (PR 112 landed)"
    - "User can collapse keywords panel to save vertical space (PR 115 landed)"
  artifacts:
    - path: "app.R"
      provides: "Seed paper insertion at notebook creation + pricing observer at startup"
      contains: "create_abstract.*seed"
    - path: "R/mod_search_notebook.R"
      provides: "Seed paper pinned to row 1 in papers_data + correct paper count notification"
      contains: "seed_paper_id"
    - path: "R/cost_tracking.R"
      provides: "Accurate pricing for all OpenRouter models"
      contains: "update_model_pricing"
  key_links:
    - from: "app.R"
      to: "R/db.R create_abstract"
      via: "insert seed paper into abstracts table at notebook creation"
      pattern: "create_abstract.*seed"
    - from: "R/mod_search_notebook.R"
      to: "search_filters JSON"
      via: "read seed_paper_id from notebook filters to pin seed to row 1"
      pattern: "seed_paper_id"
    - from: "app.R"
      to: "R/cost_tracking.R update_model_pricing"
      via: "startup observer fetches live model pricing"
      pattern: "update_model_pricing"
---

<objective>
Land pending PRs (112, 115) and fix all four bugs (BUGF-01 through BUGF-04) on the clean base.

Purpose: Resolve all user-facing bugs so the app behaves correctly — seed papers appear, modals don't duplicate, costs are accurate, and paper counts are correct.
Output: Bug-free app.R, mod_search_notebook.R, and cost_tracking.R with PRs 112 and 115 merged.
</objective>

<execution_context>
@C:/Users/sxthi/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/sxthi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/25-stabilize/25-RESEARCH.md
@.planning/phases/25-stabilize/25-CONTEXT.md
@app.R
@R/mod_search_notebook.R
@R/cost_tracking.R
@R/api_openrouter.R
@R/db.R
</context>

<tasks>

<task type="auto">
  <name>Task 1: Land pending PRs 112 and 115</name>
  <files>app.R, R/mod_search_notebook.R</files>
  <action>
Per user decision: land all pending PRs FIRST in a single merge pass before fixing bugs.

1. Merge PR 115 (collapsible keywords panel — UIPX-02):
   - `gh pr merge 115 --squash --delete-branch`
   - This is a clean minimal change to mod_search_notebook.R UI only

2. Review and merge PR 112 (duplicate toast fix — BUGF-02 / UIPX-01):
   - Before merging, audit PR 112's coverage: verify it applies the reactiveValues observer tracking pattern to ALL observe({lapply(...)}) sites in mod_search_notebook.R, not just a subset
   - Check that it covers: paper delete, block journal, unblock journal observers, and network deletion in app.R
   - If coverage is complete: `gh pr merge 112 --squash --delete-branch`
   - If coverage is missing sites: merge what it has, then add the missing observer deduplication in Task 2

3. After merging both PRs, pull main to get the clean base:
   - `git checkout main && git pull`
   - Then create the feature branch for bug fixes: `git checkout -b feature/25-stabilize`
  </action>
  <verify>
`git log --oneline -5` shows both PR squash commits on main.
`gh pr list --state open` no longer shows PRs 112 or 115.
Feature branch `feature/25-stabilize` is checked out and up to date with main.
  </verify>
  <done>PRs 112 and 115 are merged to main. Feature branch created on clean base.</done>
</task>

<task type="auto">
  <name>Task 2: Fix BUGF-01, BUGF-03, BUGF-04</name>
  <files>app.R, R/mod_search_notebook.R, R/cost_tracking.R</files>
  <action>
Fix three bugs on the clean base (after PRs are landed). Read each file FIRST to find exact line numbers — research line numbers may have shifted after PR merges.

**BUGF-01 — Seed paper visibility (per user decision: pin seed as first result):**

Part A — In `app.R`, inside `observeEvent(discovery_request(), ...)`, AFTER the loop that inserts citing/cited papers into abstracts (and before the navigate/notification):
- Insert the seed paper itself into the abstracts table if not already present
- Use `req$seed_paper` to get the seed paper object
- Check if it already exists: `SELECT id FROM abstracts WHERE notebook_id = ? AND paper_id = ?` using `seed$paper_id` (OpenAlex work ID, NOT DOI)
- If not found, call `create_abstract(con, nb_id, seed$paper_id, seed$title, seed$authors, seed$abstract, seed$year, seed$venue, seed$pdf_url, keywords = seed$keywords, work_type = seed$work_type, cited_by_count = seed$cited_by_count, referenced_works_count = seed$referenced_works_count, fwci = seed$fwci, doi = seed$doi)`
- Match on `paper_id` field (OpenAlex work ID), NOT DOI

Part B — In `R/mod_search_notebook.R`, in the `papers_data` reactive:
- After fetching papers via `list_abstracts()`, read the notebook's `search_filters` JSON
- Extract `seed_paper_id` from the filters
- If `seed_paper_id` is present and matches a row in papers, move that row to position 1 (regardless of sort order)
- Use `rbind(papers[seed_idx, ], papers[-seed_idx, ])` pattern
- Handle edge cases: seed_paper_id is NULL/NA, papers is empty, seed not found in results

**BUGF-03 — Cost tracking pricing coverage (per user decision: fix pricing coverage, NOT refresh mechanism):**

In `app.R` server function, after `effective_config` is initialized, add a one-time observer:
- When API key becomes available, call `list_chat_models(api_key)` to get live pricing
- Pass the result to `update_model_pricing()` to populate `pricing_env$MODEL_PRICING`
- Also handle embedding models if `list_embedding_models()` exists
- Wrap in tryCatch — pricing fetch failure should NOT block app startup
- Use `bindEvent(effective_config(), once = TRUE)` pattern
- Read `list_chat_models()` in `R/api_openrouter.R` first to confirm exact column names for pricing data

**BUGF-04 — Paper count after refresh (per user decision: fix count to update correctly):**

In `R/mod_search_notebook.R`, in `do_search_refresh()`:
- Find the notification that shows "Loaded N papers"
- The current count includes papers already in the notebook (duplicates that were skipped)
- Track a `newly_added` counter in the insert loop — increment only when a paper is actually inserted (not when it's skipped as duplicate)
- Change notification to show: "Added {newly_added} new papers ({total} total in notebook)" or similar
- If 0 papers were newly added, show "No new papers found" instead
  </action>
  <verify>
1. Read `app.R` and confirm seed paper insertion code exists in discovery_request handler
2. Read `R/mod_search_notebook.R` and confirm papers_data pins seed to row 1
3. Read `R/mod_search_notebook.R` and confirm do_search_refresh shows newly_added count
4. Read `app.R` and confirm pricing observer calls update_model_pricing at startup
5. Run `"C:\Program Files\R\R-4.5.1\bin\Rscript.exe" -e "testthat::test_dir('tests/testthat')"` — all tests pass
  </verify>
  <done>
BUGF-01: Seed paper is inserted into abstracts at notebook creation and pinned to row 1 in papers_data.
BUGF-03: Live model pricing is fetched at startup via list_chat_models() and fed to update_model_pricing().
BUGF-04: Search refresh notification shows count of newly-added papers, not raw API response count.
  </done>
</task>

</tasks>

<verification>
1. All four BUGF requirements addressed: seed paper visible (01), single modal (02 via PR 112), accurate pricing (03), correct count (04)
2. Both UIPX PRs landed: duplicate toasts (01 via PR 112), collapsible keywords (02 via PR 115)
3. All tests pass
4. No regressions introduced by PR merges
</verification>

<success_criteria>
- PRs 112 and 115 merged to main
- Seed paper appears as first result in seed-discovery notebook abstract search
- Cost tracking shows accurate prices for all models (not just 7 hardcoded ones)
- Paper count notification reflects only newly-added papers after refresh
- All existing tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/25-stabilize/25-01-SUMMARY.md`
</output>
