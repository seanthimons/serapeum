---
phase: 25-stabilize
plan: 02
type: execute
wave: 2
depends_on: ["25-01"]
files_modified:
  - R/db.R
  - R/_ragnar.R
  - R/mod_citation_network.R
  - www/custom.css
autonomous: true

must_haves:
  truths:
    - "Ragnar store connections in search_chunks_hybrid are closed after use — no Windows file-lock errors block store rebuild"
    - "Section_hint is encoded in newly-indexed PDF origins for accurate section-filtered retrieval"
    - "Dead code (with_ragnar_store, register_ragnar_cleanup) is removed"
    - "Citation network tooltip stays within graph container bounds and doesn't overlap side panel"
    - "Citation network renders with correct background color that works with all themes and colorblind-safe palettes"
  artifacts:
    - path: "R/db.R"
      provides: "Connection leak fix in search_chunks_hybrid"
      contains: "on.exit.*dbDisconnect"
    - path: "R/_ragnar.R"
      provides: "section_hint encoding in insert_chunks_to_ragnar + dead code removed"
      contains: "encode_origin_metadata"
    - path: "R/mod_citation_network.R"
      provides: "Tooltip smart repositioning JS"
      contains: "tooltip"
    - path: "www/custom.css"
      provides: "Theme-aware network background color"
      contains: "citation-network-container"
  key_links:
    - from: "R/db.R search_chunks_hybrid"
      to: "DBI::dbDisconnect"
      via: "on.exit cleanup for self-opened ragnar stores"
      pattern: "own_store.*on\\.exit"
    - from: "R/_ragnar.R insert_chunks_to_ragnar"
      to: "encode_origin_metadata"
      via: "conditional section_hint encoding when column present in chunks"
      pattern: "section_hint.*encode_origin"
    - from: "www/custom.css"
      to: "R/mod_citation_network.R"
      via: "CSS background + JS tooltip repositioning for citation network"
      pattern: "citation-network-container"
---

<objective>
Resolve tech debt (connection leak, section_hint pipeline gap, dead code) and polish the citation network UI (tooltip containment, background color).

Purpose: Make the app connection-safe and visually polished — the reliable foundation required before adding synthesis features in Phases 26-28.
Output: Leak-free db.R, clean _ragnar.R, polished citation network with theme-aware background and contained tooltips.
</objective>

<execution_context>
@C:/Users/sxthi/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/sxthi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/25-stabilize/25-RESEARCH.md
@.planning/phases/25-stabilize/25-CONTEXT.md
@.planning/phases/25-stabilize/25-01-SUMMARY.md
@R/db.R
@R/_ragnar.R
@R/mod_citation_network.R
@www/custom.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix connection leak, encode section_hint, remove dead code (DEBT-01, DEBT-02, DEBT-03)</name>
  <files>R/db.R, R/_ragnar.R</files>
  <action>
Read both files first to find exact current line numbers.

**DEBT-01 — Fix connection leak in search_chunks_hybrid (per user decision: fresh approach, fix however is cleanest):**

In `R/db.R`, function `search_chunks_hybrid`:
- Find where `store` is assigned via `connect_ragnar_store(ragnar_store_path)`
- Add ownership tracking: `own_store <- is.null(ragnar_store)` BEFORE the store assignment
- After the store assignment, add cleanup for self-opened stores only:
  ```r
  if (!is.null(store) && own_store) {
    on.exit(
      tryCatch(DBI::dbDisconnect(store@con, shutdown = TRUE), error = function(e) NULL),
      add = TRUE
    )
  }
  ```
- CRITICAL: Only close stores that search_chunks_hybrid opened itself. If caller passes a ragnar_store argument, the caller owns the lifecycle — do NOT close it.

**DEBT-01 Audit — Check other ragnar callers (per user decision: audit all, log new issues for any leaks found, don't fix them):**
- Read `R/rag.R` to verify `rag_query()` and `generate_conclusions_preset()` call patterns
- Read `R/_ragnar.R` for `ensure_ragnar_store()` usage
- Read `R/mod_search_notebook.R` for the ensure_ragnar_store() block around line 1993
- Document findings: if secondary leaks are found (e.g., ensure_ragnar_store() in mod_search_notebook.R), note them in the SUMMARY for logging as new issues — do NOT fix them in this task

**DEBT-02 — Encode section_hint in PDF ragnar origins (per user decision: new PDFs only, existing keep current origins):**

In `R/_ragnar.R`, function `insert_chunks_to_ragnar`:
- Find where `ragnar_chunks$origin` is assigned from `chunks$origin`
- BEFORE that assignment, add conditional section_hint encoding:
  ```r
  if ("section_hint" %in% names(chunks)) {
    chunks$origin <- vapply(seq_len(nrow(chunks)), function(i) {
      encode_origin_metadata(
        chunks$origin[i],
        section_hint = chunks$section_hint[i],
        doi = NULL,
        source_type = "pdf"
      )
    }, character(1))
  }
  ```
- Guard with `"section_hint" %in% names(chunks)` so abstract indexing paths (which don't have section_hint) are unaffected
- Verify that `encode_origin_metadata` is defined in the same file or imported

**DEBT-03 — Remove dead code (per user decision: delete immediately, no evaluation):**

In `R/_ragnar.R`:
- Delete `with_ragnar_store()` function completely (including roxygen docstring)
- Delete `register_ragnar_cleanup()` function completely (including roxygen docstring)
- Research confirmed zero callers for both functions

**Light dead code sweep (per user decision: remove obviously dead code encountered along the way):**
- While reading R/db.R and R/_ragnar.R for the above tasks, note any other obviously dead functions
- Remove them and list all removals for the PR description
- Do NOT do a comprehensive codebase-wide sweep
  </action>
  <verify>
1. Read `R/db.R search_chunks_hybrid` and confirm `own_store` + `on.exit` pattern exists
2. Read `R/_ragnar.R insert_chunks_to_ragnar` and confirm section_hint encoding with guard
3. Grep for `with_ragnar_store` and `register_ragnar_cleanup` — zero results confirms deletion
4. Run `"C:\Program Files\R\R-4.5.1\bin\Rscript.exe" -e "testthat::test_dir('tests/testthat')"` — all tests pass
  </verify>
  <done>
DEBT-01: search_chunks_hybrid closes self-opened ragnar store connections via on.exit. Audit findings documented.
DEBT-02: insert_chunks_to_ragnar encodes section_hint into origin metadata for new PDFs when section_hint column is present.
DEBT-03: with_ragnar_store() and register_ragnar_cleanup() deleted. Any other obviously dead code removed and listed.
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix tooltip containment and network background color (UIPX-03, UIPX-04)</name>
  <files>R/mod_citation_network.R, www/custom.css</files>
  <action>
Read both files first to understand current tooltip and background implementations.

**UIPX-04 — Network background color (per user decision: light neutral for all themes, colorblind-safe):**

In `www/custom.css`:
- Find the `.citation-network-container` background-color rule (currently `#1a1a2e`)
- Replace with light neutral grey: `background-color: #e8e8ee;`
- Add dark mode variant:
  ```css
  [data-bs-theme="dark"] .citation-network-container {
    background-color: #1e1e2e;
  }
  ```
- The chosen colors provide good contrast with ALL viridis-family palettes (viridis, magma, plasma, inferno, cividis) which are colorblind-safe by design

**UIPX-03 — Tooltip smart repositioning (per user decision: flip direction dynamically to stay within graph container):**

In `R/mod_citation_network.R`, add JS-based tooltip repositioning. visNetwork renders `.vis-tooltip` as a positioned div. The approach:

1. Find where the visNetwork is rendered (likely `visNetworkOutput` or `renderVisNetwork`)
2. Add a JS snippet (via `htmlwidgets::onRender` or visNetwork's `events` parameter) that:
   - Uses a MutationObserver on the network container to detect when `.vis-tooltip` appears
   - When tooltip is visible, read its bounding rect and the container's bounding rect
   - If tooltip extends past the right edge: shift left so it stays within container
   - If tooltip extends past the bottom: shift up
   - If tooltip extends past the left: shift right
   - Apply the corrected position via inline style
3. Alternative approach if MutationObserver is complex: use CSS `max-width` + `overflow-wrap` for content containment, combined with `right: 0` when tooltip is near right edge. However, JS is more reliable for true boundary detection.

Key implementation notes:
- The tooltip's default position is set by vis.js based on node position — we're adjusting AFTER vis.js positions it
- Use `requestAnimationFrame` to ensure the tooltip has been rendered before measuring
- The container boundary is the `.citation-network-container` div, NOT the viewport
- Keep the tooltip within the graph container to avoid overlapping the side panel
  </action>
  <verify>
1. Read `www/custom.css` and confirm `.citation-network-container` uses `#e8e8ee` with dark mode variant `#1e1e2e`
2. Read `R/mod_citation_network.R` and confirm tooltip repositioning JS is present
3. Run `"C:\Program Files\R\R-4.5.1\bin\Rscript.exe" -e "testthat::test_dir('tests/testthat')"` — all tests pass
  </verify>
  <done>
UIPX-03: Tooltip repositioning JS detects container boundaries and flips direction to keep tooltip within graph bounds.
UIPX-04: Network background is #e8e8ee (light mode) / #1e1e2e (dark mode) — neutral grey that works with all colorblind-safe viridis palettes.
  </done>
</task>

</tasks>

<verification>
1. DEBT-01: search_chunks_hybrid has on.exit cleanup for self-opened stores; audit findings documented
2. DEBT-02: insert_chunks_to_ragnar conditionally encodes section_hint in origins for new PDFs
3. DEBT-03: with_ragnar_store and register_ragnar_cleanup are deleted (zero grep results)
4. UIPX-03: Tooltip stays within graph container bounds via JS repositioning
5. UIPX-04: Network background is theme-aware neutral grey
6. All tests pass
7. No regressions from any changes
</verification>

<success_criteria>
- No ragnar connection leaks in search_chunks_hybrid (on.exit cleanup verified in code)
- section_hint encoded in PDF ragnar origins for new PDFs
- Dead code removed (with_ragnar_store, register_ragnar_cleanup)
- Citation network tooltip contained within graph bounds
- Citation network background is #e8e8ee (light) / #1e1e2e (dark)
- All existing tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/25-stabilize/25-02-SUMMARY.md`
</output>
