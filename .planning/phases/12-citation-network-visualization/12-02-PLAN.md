---
phase: 12-citation-network-visualization
plan: 02
type: execute
wave: 2
depends_on: ["12-01"]
files_modified:
  - R/mod_citation_network.R
  - app.R
  - www/custom.css
autonomous: false

must_haves:
  truths:
    - "User can generate a citation network from sidebar 'New Network' button with seed paper search"
    - "User can generate a citation network from seeded paper search result cards"
    - "User can click a node to see full paper details in side panel"
    - "User can click 'Explore from here' to rebuild network around selected paper"
    - "User can toggle citation direction, adjust depth slider, and set node cap"
    - "User sees progressive graph building as API data arrives"
    - "User can save a network with a name and see it in sidebar"
    - "User can reload a saved network instantly (pre-computed positions, no physics)"
    - "User can delete a saved network from sidebar without confirmation"
    - "User sees always-visible legend (color = year range, size = citation count)"
    - "User can pan, zoom, and interact with the network graph smoothly"
  artifacts:
    - path: "R/mod_citation_network.R"
      provides: "Full citation network Shiny module (UI + server)"
      exports: ["mod_citation_network_ui", "mod_citation_network_server"]
      min_lines: 300
    - path: "app.R"
      provides: "Sidebar integration, view routing, network entry points"
      contains: "mod_citation_network"
    - path: "www/custom.css"
      provides: "Network-specific styles (legend, side panel, tooltips)"
      contains: "citation-network"
  key_links:
    - from: "R/mod_citation_network.R"
      to: "R/citation_network.R"
      via: "fetch_citation_network, build_network_data, compute_layout_positions"
      pattern: "fetch_citation_network|build_network_data"
    - from: "R/mod_citation_network.R"
      to: "R/db.R"
      via: "save_network, load_network, list_networks, delete_network"
      pattern: "save_network|load_network"
    - from: "app.R"
      to: "R/mod_citation_network.R"
      via: "mod_citation_network_ui/server calls"
      pattern: "mod_citation_network"
    - from: "R/mod_citation_network.R"
      to: "visNetwork"
      via: "visNetworkOutput, renderVisNetwork, visNetworkProxy"
      pattern: "visNetwork"
---

<objective>
Build the interactive citation network visualization module with all UI controls, sidebar integration, progressive loading, and graph persistence.

Purpose: This is the user-facing feature -- the interactive network graph with controls, side panel, and sidebar integration. Consumes all data layer functions from plan 01.
Output: Complete mod_citation_network.R module, app.R integration, CSS styles
</objective>

<execution_context>
@C:/Users/sxthi/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/sxthi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-citation-network-visualization/12-RESEARCH.md
@.planning/phases/12-citation-network-visualization/12-CONTEXT.md
@.planning/phases/12-citation-network-visualization/12-01-SUMMARY.md
@R/mod_citation_network.R
@R/citation_network.R
@R/db.R
@app.R
@www/custom.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Citation network Shiny module</name>
  <files>R/mod_citation_network.R, www/custom.css</files>
  <action>
Create `R/mod_citation_network.R` with `mod_citation_network_ui(id)` and `mod_citation_network_server(id, con_r, config_r, network_id_r, network_trigger)`.

**UI Layout (mod_citation_network_ui):**

Use a full-width layout with the graph taking the main area and a collapsible side panel on the right.

Top controls bar (horizontal row):
- Direction toggle: radioButtons with choices "Forward" (papers citing seed), "Backward" (papers seed cites), "Both" -- default "both"
- Depth slider: sliderInput 1-3 with default 1, step 1
- Node cap slider: sliderInput 25-200 with default 100, step 25
- "Build Network" button (btn-primary) -- triggers fetch
- "Save Network" button (btn-outline-success) -- triggers save modal

Main content area (side by side):
- Left (col-8 to col-12, expands when side panel hidden): visNetworkOutput for the graph
- Right (col-4, conditional): side panel for paper details on node click

**Graph configuration (in renderVisNetwork):**
- visPhysics: solver = "forceAtlas2Based", forceAtlas2Based = list(gravitationalConstant = -50, springLength = 200), stabilization = list(iterations = 200) for initial build. When loading saved graph: physics disabled, stabilization disabled (per research pitfall 6)
- visEdges: arrows = "to" (directional arrows per user decision), color = list(color = "#cccccc", highlight = "#666666"), smooth = list(type = "continuous")
- visNodes: font = list(size = 0) (no labels by default per user decision)
- visInteraction: hover = TRUE, tooltipDelay = 200, navigationButtons = TRUE (pan/zoom controls)
- visEvents: click event to capture selected node ID via Shiny.onInputChange, hoverNode event to highlight connected edges
- visLayout: randomSeed = 42 for reproducibility during initial build

**Legend panel (always visible, per user decision):**
- Position: bottom-left overlay on graph area
- Content: color gradient bar showing year range (min year -- max year) with viridis colors, node size examples (small = few citations, large = many citations)
- Implement as a div overlay positioned absolute within the graph container, styled with CSS
- Use htmlwidgets::onRender() to inject a custom legend div into the visNetwork container, OR use visLegend() if it supports custom HTML

**Side panel (on node click):**
- Shows: title, authors (parsed from JSON), year, journal/venue, DOI as clickable link (https://doi.org/{doi}), citation count
- Abstract: fetch from OpenAlex API on click (NOT stored in network_nodes per research pitfall 3). Use a single API call: build_openalex_request("works/{paper_id}") to get full work details including abstract
- "Explore from here" button: rebuilds network with clicked paper as new seed, keeping current direction/depth/node_limit settings
- "Close" button to hide side panel

**Progressive loading:**
- When "Build Network" is clicked, start with seed node only (renderVisNetwork with single node)
- Use shiny::observe() with invalidateLater() or a reactive pattern to progressively add nodes
- The fetch_citation_network function from plan 01 has a progress_callback -- wire this to update a progress indicator AND to call visNetworkProxy %>% visUpdateNodes() / visUpdateEdges() to add nodes/edges progressively as each hop completes
- Show a small progress badge near the graph showing "Loading... {n}/{total} papers"

**Save flow:**
- "Save Network" button opens modalDialog prompting for network name (textInput)
- On save: call compute_layout_positions() to get current node positions from igraph, then save_network() to persist
- After save, trigger sidebar refresh so new network appears in sidebar list

**Load flow (when network_id_r changes to a saved network):**
- Call load_network() from db.R
- Build visNetwork with pre-computed positions (nodes$x, nodes$y from DB)
- Disable physics (visNodes(physics = FALSE), visPhysics(stabilization = FALSE)) for instant render
- Populate controls (direction, depth, node_limit) from saved metadata

**Graph background:** Use dark background (#1a1a2e or similar dark blue-gray) which provides best contrast with viridis/magma palettes (Claude's discretion item). Set via visNetwork(...) %>% visOptions(... ) or CSS on the container.

**CSS additions to www/custom.css:**
- `.citation-network-legend` -- positioned absolute, bottom-left, semi-transparent background, padding, rounded corners, z-index above graph
- `.citation-network-side-panel` -- right panel styling, scrollable, border-left
- `.citation-network-controls` -- top control bar styling
- `.citation-network-container` -- relative positioning for legend overlay
  </action>
  <verify>
Source the module file without errors:
```r
source("R/mod_citation_network.R")
stopifnot(is.function(mod_citation_network_ui))
stopifnot(is.function(mod_citation_network_server))
```
Check that www/custom.css contains citation-network styles.
  </verify>
  <done>
mod_citation_network.R implements full interactive network visualization with:
- Controls for direction/depth/node cap
- visNetwork graph with force-directed layout, directional arrows, viridis colors
- Star-shaped seed node with gold border ring
- Hover tooltips (title, authors, year, citations)
- Click side panel with full paper details and "Explore from here"
- Progressive loading via visNetworkProxy
- Save/load with pre-computed positions and physics disabled on reload
- Always-visible legend panel
- Dark background for palette contrast
  </done>
</task>

<task type="auto">
  <name>Task 2: App integration -- sidebar, routing, entry points</name>
  <files>app.R, R/mod_settings.R</files>
  <action>
**Modify app.R sidebar** to add network entry points and saved network list:

1. **Sidebar buttons section** (after existing "Explore Topics" button):
   - Add: `actionButton("new_network", "Citation Network", class = "btn-outline-danger", icon = icon("project-diagram"))` -- this is the "New Network" entry point from sidebar

2. **Sidebar network list section** (after notebook list, before session cost):
   - Add a new section header: `div(class = "text-muted small fw-semibold mb-2 mt-3", "NETWORKS")`
   - Render saved networks from `list_networks(con)` using the same pattern as notebook_list
   - Each network entry: actionLink with network icon + network name, click sets current_view to "network" and sets a `current_network` reactiveVal
   - Delete: each network entry has a small "x" button that calls delete_network() immediately (no confirmation dialog per user decision), then refreshes the list

3. **View routing in output$main_content**:
   - Add `if (view == "network") { return(mod_citation_network_ui("citation_network")) }` alongside existing view checks
   - Add `if (view == "new_network") { ... }` for the new network creation flow

4. **New network flow** (when "new_network" sidebar button is clicked):
   - Show a modal dialog with a mini seed paper search (similar to mod_seed_discovery's search)
   - User types a paper title/DOI, searches OpenAlex, selects a result
   - On selection: set current_view to "network", pass the selected paper's OpenAlex ID to the network module

5. **Seeded paper search integration** (entry from existing search results):
   - In mod_search_notebook.R or mod_seed_discovery.R, add a "Network" icon button on result cards (per user decision). When clicked, sends the paper_id to network module
   - This can be deferred to a follow-up if too complex -- at minimum, the sidebar "New Network" entry point must work

6. **Module initialization in server**:
   - Add `current_network <- reactiveVal(NULL)` alongside current_notebook
   - Add `network_refresh <- reactiveVal(0)` for sidebar list refresh
   - Initialize module: `mod_citation_network_server("citation_network", con_r, effective_config, reactive(current_network()), network_refresh)`

7. **Network selection handlers**:
   - Observe clicks on saved network links in sidebar
   - Set current_network() and current_view("network")

**Modify R/mod_settings.R** to add palette toggle:
- Add a selectInput for colorblind palette choice in settings: choices = c("Viridis" = "viridis", "Magma" = "magma", "Plasma" = "plasma", "Inferno" = "inferno", "Cividis" = "cividis")
- Save to settings DB using existing save_db_setting() pattern with key "network_palette"
- Load saved preference on module init
- The network module reads this setting to apply the chosen palette
  </action>
  <verify>
Start the app. Verify:
1. "Citation Network" button appears in sidebar
2. Clicking it opens seed paper search modal
3. Saved networks appear in NETWORKS section of sidebar
4. Clicking a saved network loads the graph view
5. Delete button on saved network removes it from sidebar
6. Settings page shows palette selector
  </verify>
  <done>
App.R integrates citation network module with:
- "Citation Network" sidebar button opening seed paper search modal
- NETWORKS section in sidebar showing saved graphs
- Delete on saved networks (no confirmation dialog)
- View routing to citation_network view
- Palette preference in Settings page persisted to DB
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Human verification of complete citation network feature</name>
  <action>
User verifies the full citation network feature end-to-end by testing all interaction paths.
  </action>
  <what-built>
Complete citation network visualization feature:
- Sidebar "Citation Network" button with seed paper search
- Interactive force-directed graph with viridis color mapping, star-shaped seed node
- Hover tooltips, click side panel with paper details
- Direction/depth/node cap controls
- Progressive graph building
- Save/load networks with instant reload
- Saved networks in sidebar
- Palette toggle in settings
  </what-built>
  <how-to-verify>
1. Start the app: open browser to localhost
2. Click "Citation Network" in sidebar
3. Search for a well-known paper (e.g., "attention is all you need")
4. Select a result -- network should start building progressively
5. Verify:
   - Nodes appear and settle into position
   - Seed node is star-shaped with gold border
   - Node colors show year gradient (cool to warm)
   - Hovering a node highlights edges and shows tooltip (title, authors, year, citations)
   - Clicking a node opens side panel with full details
   - "Explore from here" rebuilds network around clicked paper
   - Direction/depth/node cap sliders work and rebuild the graph
   - Legend is visible showing color = year, size = citation count
6. Save the network with a name
7. Verify it appears in sidebar NETWORKS section
8. Click away (e.g., to Settings), then click the saved network -- should reload instantly without physics jitter
9. Delete the saved network -- should disappear from sidebar immediately
10. Go to Settings -- verify palette selector exists
11. Change palette, rebuild a network -- colors should change
  </how-to-verify>
  <verify>User confirms all interaction paths work correctly</verify>
  <done>User has approved the citation network visualization feature</done>
  <resume-signal>Type "approved" or describe any issues</resume-signal>
</task>

</tasks>

<verification>
- Network module renders without JavaScript errors
- Graph loads within 5 seconds for depth=1 networks (per success criteria)
- Node cap limits graph to specified maximum
- Saved graphs reload with pre-computed positions (no re-stabilization)
- Sidebar shows saved networks alongside notebooks
- Palette toggle in settings affects graph colors
- Pan/zoom works smoothly without browser lag
</verification>

<success_criteria>
- User can generate a citation network graph from sidebar with one click flow
- User can click a node to view paper details in side panel
- Network graphs limited to user-specified node cap (default 100)
- Saved graphs appear as first-class sidebar objects
- Graph interactions (pan, zoom, hover, click) are smooth
- Colorblind-friendly palettes with settings toggle
</success_criteria>

<output>
After completion, create `.planning/phases/12-citation-network-visualization/12-02-SUMMARY.md`
</output>
