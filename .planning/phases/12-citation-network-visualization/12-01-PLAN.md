---
phase: 12-citation-network-visualization
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - migrations/006_create_citation_networks.sql
  - R/citation_network.R
  - R/db.R
autonomous: true

must_haves:
  truths:
    - "Citation network tables exist in DuckDB with proper CASCADE deletes"
    - "BFS citation fetcher traverses 1-3 hops with citation-count pruning and node cap"
    - "Cycle detection prevents infinite loops in citation graph traversal"
    - "Network CRUD functions can save, load, list, and delete networks with node/edge data"
    - "Saved node positions are stored and retrieved for instant reload"
  artifacts:
    - path: "migrations/006_create_citation_networks.sql"
      provides: "Three-table schema: citation_networks, network_nodes, network_edges"
      contains: "ON DELETE CASCADE"
    - path: "R/citation_network.R"
      provides: "BFS citation fetcher with pruning, year-to-color mapping, node sizing"
      exports: ["fetch_citation_network", "map_year_to_color", "build_network_data"]
    - path: "R/db.R"
      provides: "Network CRUD: save_network, load_network, list_networks, delete_network"
      exports: ["save_network", "load_network", "list_networks", "delete_network"]
  key_links:
    - from: "R/citation_network.R"
      to: "R/api_openalex.R"
      via: "get_citing_papers() and get_cited_papers()"
      pattern: "get_citing_papers|get_cited_papers"
    - from: "R/citation_network.R"
      to: "R/db.R"
      via: "save_network() for persistence"
      pattern: "save_network"
    - from: "migrations/006_create_citation_networks.sql"
      to: "R/db_migrations.R"
      via: "run_pending_migrations() auto-applies on startup"
      pattern: "006_create_citation_networks"
---

<objective>
Build the citation network data layer: database schema, BFS citation fetcher with depth/breadth limits, and network CRUD operations.

Purpose: Provides the data foundation that the UI module (plan 02) will consume. Without this, there is no graph data to visualize.
Output: Migration file, citation_network.R utility module, network DB functions in db.R
</objective>

<execution_context>
@C:/Users/sxthi/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/sxthi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-citation-network-visualization/12-RESEARCH.md
@.planning/phases/12-citation-network-visualization/12-CONTEXT.md
@R/api_openalex.R
@R/db.R
@R/db_migrations.R
@migrations/005_add_doi_column.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Database migration for citation network tables</name>
  <files>migrations/006_create_citation_networks.sql</files>
  <action>
Create migration file `migrations/006_create_citation_networks.sql` with three tables following the existing migration pattern (NNN_description.sql, semicolon-separated statements).

**citation_networks table:**
- `id` VARCHAR PRIMARY KEY (UUID, consistent with create_notebook pattern)
- `name` VARCHAR NOT NULL (user-provided name)
- `seed_paper_id` VARCHAR NOT NULL (OpenAlex Work ID like "W123456")
- `seed_paper_title` VARCHAR NOT NULL (for sidebar display without join)
- `direction` VARCHAR NOT NULL (one of: 'forward', 'backward', 'both')
- `depth` INTEGER NOT NULL (1-3 hops)
- `node_limit` INTEGER NOT NULL (25-200)
- `palette` VARCHAR DEFAULT 'viridis' (colorblind palette choice)
- `created_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP
- `updated_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP

**network_nodes table:**
- `network_id` VARCHAR NOT NULL
- `paper_id` VARCHAR NOT NULL (OpenAlex Work ID)
- `is_seed` BOOLEAN DEFAULT FALSE
- `title` VARCHAR NOT NULL
- `authors` VARCHAR (JSON array string)
- `year` INTEGER
- `venue` VARCHAR
- `doi` VARCHAR (bare format)
- `cited_by_count` INTEGER DEFAULT 0
- `x_position` DOUBLE (pre-computed igraph layout)
- `y_position` DOUBLE
- PRIMARY KEY (network_id, paper_id)
- FOREIGN KEY (network_id) REFERENCES citation_networks(id) ON DELETE CASCADE

Do NOT store abstract text in network_nodes (per research pitfall 3 -- fetch on click from OpenAlex API instead to avoid memory bloat).

**network_edges table:**
- `network_id` VARCHAR NOT NULL
- `from_paper_id` VARCHAR NOT NULL
- `to_paper_id` VARCHAR NOT NULL
- PRIMARY KEY (network_id, from_paper_id, to_paper_id)
- FOREIGN KEY (network_id) REFERENCES citation_networks(id) ON DELETE CASCADE

Add indexes:
- `idx_network_nodes_network_id` ON network_nodes(network_id)
- `idx_network_edges_network_id` ON network_edges(network_id)
  </action>
  <verify>
Start the app with `"C:\Program Files\R\R-4.5.1\bin\Rscript.exe" -e "source('app.R')"` and check console for "[migration] Applied migration 6: create citation networks". Verify tables exist by querying DuckDB.
  </verify>
  <done>Migration 006 auto-applies on app startup. Three tables exist with correct columns, foreign keys, CASCADE deletes, and indexes.</done>
</task>

<task type="auto">
  <name>Task 2: BFS citation fetcher and network CRUD functions</name>
  <files>R/citation_network.R, R/db.R</files>
  <action>
**Create R/citation_network.R** with these functions:

1. **`fetch_citation_network(seed_paper_id, email, api_key, direction, depth, node_limit, progress_callback)`**
   - BFS traversal using existing `get_citing_papers()` and `get_cited_papers()` from api_openalex.R
   - `direction`: "forward" calls get_citing_papers, "backward" calls get_cited_papers, "both" calls both
   - `depth`: 1-3 hops from seed. At each hop, fetch citations for papers found in previous hop
   - `node_limit`: 25-200. When total discovered papers exceed limit, keep the most-cited papers (sort by cited_by_count DESC, keep top N)
   - Use a `visited` set (character vector of paper_ids) for cycle detection -- skip any paper_id already in the set
   - Use `per_page = 200` for OpenAlex API calls (maximum allowed) to minimize API calls
   - At each depth level, before expanding to next hop, prune to keep only top papers by citation count (BFS with citation-count pruning per research recommendation)
   - `progress_callback`: optional function(message, fraction) called after each API batch to support progressive UI updates
   - Returns list with: `nodes` (data.frame with id, title, authors, year, venue, doi, cited_by_count, is_seed), `edges` (data.frame with from, to)
   - Handle API errors gracefully with tryCatch -- return partial results if some hops fail

2. **`map_year_to_color(years, palette)`**
   - Maps publication years to viridis color palette
   - `palette`: one of "viridis", "magma", "plasma", "inferno", "cividis" (default "viridis")
   - Normalize years to 0-1 range, map to viridis(100, option = palette)
   - Handle single-year edge case (division by zero) -- return middle palette color for all nodes (per research pitfall 7)
   - Handle NA years -- assign a neutral gray (#999999)
   - Returns character vector of hex colors

3. **`compute_node_sizes(cited_by_counts)`**
   - Apply sqrt() transform to citation counts (per research recommendation for power-law distribution)
   - Scale result to range 10-50 (visNetwork node value range for reasonable display)
   - Handle zero citations: sqrt(0) = 0, minimum size should be 10

4. **`build_network_data(nodes_df, edges_df, palette, seed_paper_id)`**
   - Takes raw nodes/edges from fetch_citation_network
   - Adds visNetwork-specific columns: `color` (from map_year_to_color), `value` (from compute_node_sizes), `shape` (star for seed, dot for others per user decision), `borderWidth` (5 for seed, 1 for others), `color.border` ("#FFD700" gold for seed ring)
   - Adds `title` column with HTML tooltip: "<b>{paper_title}</b><br>Authors: {authors}<br>Year: {year}<br>Citations: {cited_by_count}" (per user decision: hover shows tooltip with paper details)
   - Adds `label` column as NA (no labels by default per user decision, labels on hover handled by visNetwork settings)
   - Returns list(nodes = nodes_df, edges = edges_df) ready for visNetwork

5. **`compute_layout_positions(nodes_df, edges_df)`**
   - Uses igraph::graph_from_data_frame() to build graph
   - Computes Fruchterman-Reingold layout with igraph::layout_with_fr()
   - Scales coordinates by 800x for vis.js coordinate system (per research pitfall 5)
   - Returns nodes_df with x and y columns added

**Add to R/db.R** (append at bottom):

6. **`save_network(con, id, name, seed_paper_id, seed_paper_title, direction, depth, node_limit, palette, nodes_df, edges_df)`**
   - Insert into citation_networks table
   - Bulk insert nodes into network_nodes (use dbWriteTable with append=TRUE after formatting data.frame)
   - Bulk insert edges into network_edges
   - Uses uuid::UUIDgenerate() for id if NULL (consistent with create_notebook pattern)

7. **`load_network(con, network_id)`**
   - Query citation_networks for metadata
   - Query network_nodes for all nodes (including x_position, y_position)
   - Query network_edges for all edges
   - Return list(metadata = ..., nodes = ..., edges = ...) or NULL if not found

8. **`list_networks(con)`**
   - Query citation_networks ORDER BY updated_at DESC
   - Return data.frame with id, name, seed_paper_title, created_at

9. **`delete_network(con, network_id)`**
   - DELETE FROM citation_networks WHERE id = ? (CASCADE handles nodes/edges)

10. **`update_network_positions(con, network_id, nodes_df)`**
    - UPDATE network_nodes SET x_position = ?, y_position = ? for each node
    - Called when saving layout positions after graph stabilization
  </action>
  <verify>
Run the following R test script to verify:
```r
source("R/citation_network.R")
source("R/db.R")
# Test map_year_to_color
colors <- map_year_to_color(c(2018, 2020, 2022), "viridis")
stopifnot(length(colors) == 3, all(grepl("^#", colors)))
# Test single-year edge case
single <- map_year_to_color(c(2020, 2020, 2020), "viridis")
stopifnot(length(unique(single)) == 1)
# Test compute_node_sizes
sizes <- compute_node_sizes(c(0, 100, 10000))
stopifnot(all(sizes >= 10), all(sizes <= 50))
# Test network CRUD
con <- get_db_connection("data/test_networks.duckdb")
id <- save_network(con, NULL, "Test Net", "W123", "Test Paper", "both", 1, 100, "viridis",
  data.frame(paper_id="W123", is_seed=TRUE, title="Test", authors="[]", year=2020, venue="J", doi=NA, cited_by_count=50, x_position=0, y_position=0),
  data.frame(from_paper_id=character(0), to_paper_id=character(0)))
nets <- list_networks(con)
stopifnot(nrow(nets) == 1)
loaded <- load_network(con, id)
stopifnot(!is.null(loaded), nrow(loaded$nodes) == 1)
delete_network(con, id)
stopifnot(nrow(list_networks(con)) == 0)
close_db_connection(con)
unlink("data/test_networks.duckdb")
cat("All tests passed!\n")
```
  </verify>
  <done>
fetch_citation_network performs BFS with cycle detection, depth limits, and citation-count pruning. map_year_to_color handles viridis palettes including single-year edge case. compute_node_sizes applies sqrt transform. build_network_data prepares visNetwork-ready data with star seed node, tooltips, and directional arrows. Network CRUD (save, load, list, delete) works correctly with CASCADE deletes.
  </done>
</task>

</tasks>

<verification>
- Migration 006 creates three tables with ON DELETE CASCADE
- `fetch_citation_network()` respects node_limit and depth parameters
- Cycle detection prevents duplicate nodes in graph
- `map_year_to_color()` produces valid hex colors for all palettes including edge cases
- Network can be saved and loaded with identical node/edge data
- Deleting a network cascades to remove all nodes and edges
</verification>

<success_criteria>
- Migration file exists and auto-applies on app startup
- R/citation_network.R exports all 5 functions
- R/db.R exports all 5 network CRUD functions
- All functions handle edge cases (empty results, single node, API errors)
- No abstracts stored in network_nodes (memory optimization)
</success_criteria>

<output>
After completion, create `.planning/phases/12-citation-network-visualization/12-01-SUMMARY.md`
</output>
