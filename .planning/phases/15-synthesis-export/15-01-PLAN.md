---
phase: 15-synthesis-export
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - R/utils_export.R
  - R/mod_document_notebook.R
  - R/mod_search_notebook.R
autonomous: true
must_haves:
  truths:
    - "User can download chat conversation as Markdown file from document notebook"
    - "User can download chat conversation as Markdown file from search notebook"
    - "User can download chat conversation as HTML file from document notebook"
    - "User can download chat conversation as HTML file from search notebook"
    - "Exported file contains full conversation with user and assistant messages"
    - "Exported file includes timestamps for each message"
    - "Exported HTML file opens in any browser with readable formatting"
  artifacts:
    - path: "R/utils_export.R"
      provides: "Chat export formatters (Markdown and HTML)"
      exports: ["format_chat_as_markdown", "format_chat_as_html"]
    - path: "R/mod_document_notebook.R"
      provides: "Download buttons and handlers for document notebook chat"
      contains: "download_chat_md"
    - path: "R/mod_search_notebook.R"
      provides: "Download buttons and handlers for search notebook chat"
      contains: "download_chat_md"
  key_links:
    - from: "R/mod_document_notebook.R"
      to: "R/utils_export.R"
      via: "format_chat_as_markdown and format_chat_as_html calls in downloadHandler"
      pattern: "format_chat_as_(markdown|html)"
    - from: "R/mod_search_notebook.R"
      to: "R/utils_export.R"
      via: "format_chat_as_markdown and format_chat_as_html calls in downloadHandler"
      pattern: "format_chat_as_(markdown|html)"
---

<objective>
Add chat export functionality to both document and search notebooks, allowing users to download conversations as Markdown (.md) or HTML (.html) files.

Purpose: Completes the v2.0 Discovery Workflow milestone by enabling researchers to save and share synthesis outputs from their chat conversations with the AI assistant.
Output: R/utils_export.R utility file, updated chat UIs with export dropdown buttons, working download handlers in both notebook modules.
</objective>

<execution_context>
@C:/Users/sxthi/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/sxthi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15-synthesis-export/15-RESEARCH.md

@R/utils_citation.R (Phase 14 export utility pattern reference)
@R/mod_document_notebook.R (document notebook - add export UI + handlers)
@R/mod_search_notebook.R (search notebook - add export UI + handlers, has Phase 14 downloadHandler patterns)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create chat export formatters and add timestamps to messages</name>
  <files>R/utils_export.R, R/mod_document_notebook.R, R/mod_search_notebook.R</files>
  <action>
  1. Create R/utils_export.R with two exported functions:

  format_chat_as_markdown(messages, notebook_name = NULL):
  - Accept list of message objects (each with role, content, timestamp fields)
  - Generate Markdown string with:
    - Header: "# Chat Export" and optional notebook name subtitle
    - Export date: "Exported: YYYY-MM-DD HH:MM:SS"
    - Horizontal rule separator
    - For each message: "### User" or "### Assistant" header, timestamp line in italics ("*YYYY-MM-DD HH:MM:SS*"), blank line, then content, blank line, horizontal rule
  - If messages list is empty, return "# Chat Export\n\nNo messages in this conversation."
  - If timestamp is NULL on a message, omit the timestamp line (graceful degradation for any old messages)

  format_chat_as_html(messages, notebook_name = NULL):
  - Call format_chat_as_markdown() to get markdown content
  - Convert to HTML body using commonmark::markdown_html(markdown_content, extensions = TRUE, smart = TRUE)
  - Wrap in standalone HTML document template with:
    - DOCTYPE html, lang="en", charset UTF-8, viewport meta
    - Title: "Chat Export" or notebook name if provided
    - Embedded CSS (no external dependencies): system font stack, max-width 800px centered, light background (#f8f9fa), h3 headers colored (#333), pre/code blocks styled with monospace font and light background, hr styled as light separator
    - The HTML body content from commonmark conversion
  - Return complete HTML string

  2. Add timestamp field to message creation in BOTH modules:

  In R/mod_document_notebook.R — find the two places messages are appended (around lines 370-384 in send handler, and lines 399-414 in handle_preset function):
  - Change: list(role = "user", content = user_msg)
  - To: list(role = "user", content = user_msg, timestamp = Sys.time())
  - Change: list(role = "assistant", content = response)
  - To: list(role = "assistant", content = response, timestamp = Sys.time())
  - Also in handle_preset: same pattern for the "Generate: Label" user message and the preset response

  In R/mod_search_notebook.R — find the send handler (around lines 1791-1812):
  - Change: list(role = "user", content = user_msg)
  - To: list(role = "user", content = user_msg, timestamp = Sys.time())
  - Change: list(role = "assistant", content = response)
  - To: list(role = "assistant", content = response, timestamp = Sys.time())

  Note: Existing message rendering code (output$messages) reads only $role and $content, so adding $timestamp does NOT break rendering — R lists silently ignore extra fields.
  </action>
  <verify>
  Run: "C:\Program Files\R\R-4.5.1\bin\Rscript.exe" -e "source('R/utils_export.R'); msgs <- list(list(role='user', content='Hello', timestamp=Sys.time()), list(role='assistant', content='Hi there', timestamp=Sys.time())); cat(format_chat_as_markdown(msgs)); cat('---HTML---\n'); cat(substr(format_chat_as_html(msgs), 1, 500))"

  Verify: Markdown output shows headers, timestamps, content. HTML output starts with DOCTYPE and contains styled body.
  </verify>
  <done>
  R/utils_export.R exists with format_chat_as_markdown() and format_chat_as_html() functions. Both modules append timestamp to every new message. Formatter handles empty messages, missing timestamps, and Unicode content.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add export download buttons and handlers to both notebook chat UIs</name>
  <files>R/mod_document_notebook.R, R/mod_search_notebook.R</files>
  <action>
  1. In R/mod_document_notebook.R UI (mod_document_notebook_ui):
  - In the right card's card_header (around line 29), add an "Export Chat" dropdown button AFTER the existing preset buttons div.
  - Use the same btn-group pattern from Phase 14 (see mod_search_notebook.R lines 55-65):
    div(
      class = "btn-group btn-group-sm",
      tags$button(
        class = "btn btn-outline-secondary dropdown-toggle",
        `data-bs-toggle` = "dropdown",
        icon("download"), " Export"
      ),
      tags$ul(
        class = "dropdown-menu",
        tags$li(downloadLink(ns("download_chat_md"), class = "dropdown-item", icon("file-lines"), " Markdown (.md)")),
        tags$li(downloadLink(ns("download_chat_html"), class = "dropdown-item", icon("file-code"), " HTML (.html)"))
      )
    )
  - The card_header already has class "d-flex justify-content-between align-items-center flex-wrap gap-2" so the new dropdown will flow naturally.

  2. In R/mod_document_notebook.R Server (mod_document_notebook_server):
  - Add two downloadHandler outputs (place after the messages rendering, before the send handler):

    output$download_chat_md <- downloadHandler(
      filename = function() { paste0("chat-", Sys.Date(), ".md") },
      content = function(file) {
        msgs <- messages()
        md_content <- format_chat_as_markdown(msgs)
        con_file <- file(file, "wb")
        writeBin(charToRaw(md_content), con_file)
        close(con_file)
      }
    )

    output$download_chat_html <- downloadHandler(
      filename = function() { paste0("chat-", Sys.Date(), ".html") },
      content = function(file) {
        msgs <- messages()
        html_content <- format_chat_as_html(msgs)
        con_file <- file(file, "wb")
        writeBin(charToRaw("\xEF\xBB\xBF"), con_file)  # UTF-8 BOM
        writeBin(charToRaw(html_content), con_file)
        close(con_file)
      }
    )

  3. In R/mod_search_notebook.R UI (mod_search_notebook_ui):
  - In the offcanvas chat panel header (around line 186-194), add an export dropdown BEFORE the close button.
  - The offcanvas-header has the title and close button. Add between them:
    div(
      class = "d-flex align-items-center gap-2 ms-auto",
      div(
        class = "btn-group btn-group-sm",
        tags$button(
          class = "btn btn-outline-secondary dropdown-toggle",
          `data-bs-toggle` = "dropdown",
          icon("download")
        ),
        tags$ul(
          class = "dropdown-menu dropdown-menu-end",
          tags$li(downloadLink(ns("download_chat_md"), class = "dropdown-item", icon("file-lines"), " Markdown (.md)")),
          tags$li(downloadLink(ns("download_chat_html"), class = "dropdown-item", icon("file-code"), " HTML (.html)"))
        )
      ),
      tags$button(
        type = "button",
        class = "btn-close",
        `data-bs-dismiss` = "offcanvas",
        `aria-label` = "Close"
      )
    )
  - Remove the existing standalone close button (line 189-194) since it is now inside the new div.

  4. In R/mod_search_notebook.R Server (mod_search_notebook_server):
  - Add the same two downloadHandler outputs (place near the existing download_bibtex/download_csv handlers around line 433, for logical grouping):

    Same pattern as document notebook above (downloadHandler for download_chat_md and download_chat_html).

  Use writeBin with charToRaw pattern (not writeLines) for reliable UTF-8 on Windows. Add UTF-8 BOM only for HTML files (browsers auto-detect with meta charset, but BOM ensures compatibility). Markdown files do NOT get BOM (editors handle UTF-8 natively).
  </action>
  <verify>
  1. Run the Shiny app: "C:\Program Files\R\R-4.5.1\bin\Rscript.exe" -e "shiny::runApp(port=3838)" and verify:
     - Document notebook: "Export" dropdown appears in chat card header next to preset buttons
     - Search notebook: Download icon button appears in offcanvas chat header
     - Both dropdowns show "Markdown (.md)" and "HTML (.html)" options
  2. Send a test message in each chat, then click each export option:
     - .md file downloads with conversation content, timestamps, role headers
     - .html file downloads, opens in browser with styled formatting
  3. Test edge case: export with zero messages — should get "No messages" placeholder content
  </verify>
  <done>
  Both notebook modules have Export Chat dropdown buttons. Clicking Markdown or HTML triggers file download. Downloaded files contain full conversation with timestamps and role labels. HTML file renders correctly in any browser with embedded CSS styling. Empty conversations export gracefully with placeholder text.
  </done>
</task>

</tasks>

<verification>
1. R/utils_export.R exists and both functions are callable
2. commonmark package loads without error
3. Document notebook chat header shows Export dropdown with two options
4. Search notebook offcanvas header shows Export dropdown with two options
5. Markdown export contains: header, timestamps, role labels (User/Assistant), message content
6. HTML export contains: DOCTYPE, embedded CSS, formatted conversation, UTF-8 meta tag
7. Both formats handle empty conversation (zero messages) gracefully
8. Unicode characters (accents, special chars) render correctly in both formats
9. Timestamps appear on newly sent messages in both modules
</verification>

<success_criteria>
- User can download chat as .md from document notebook
- User can download chat as .md from search notebook
- User can download chat as .html from document notebook
- User can download chat as .html from search notebook
- Exported files show full conversation with User/Assistant labels and timestamps
- HTML file opens in browser with readable, styled formatting
- Empty chat exports produce valid files with placeholder content
</success_criteria>

<output>
After completion, create `.planning/phases/15-synthesis-export/15-01-SUMMARY.md`
</output>
