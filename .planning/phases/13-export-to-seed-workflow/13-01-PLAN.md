---
phase: 13-export-to-seed-workflow
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - R/mod_search_notebook.R
  - app.R
  - R/mod_seed_discovery.R
autonomous: true

must_haves:
  truths:
    - "User can click 'Use as Seed' button from abstract detail view"
    - "User navigates to seed discovery view with DOI pre-filled"
    - "Seed discovery auto-triggers paper lookup when DOI is pre-filled"
    - "User's current search notebook persists when navigating away and back"
    - "User sees consistent search notebook UI for seeded search results (same filters, sorting)"
  artifacts:
    - path: "R/mod_search_notebook.R"
      provides: "'Use as Seed' button in detail_actions and seed_request reactive return"
      contains: "use_as_seed"
    - path: "app.R"
      provides: "Reactive bridge wiring seed_request to discovery navigation with pre_fill_doi"
      contains: "pre_fill_doi"
    - path: "R/mod_seed_discovery.R"
      provides: "pre_fill_doi parameter acceptance and auto-lookup trigger"
      contains: "pre_fill_doi"
  key_links:
    - from: "R/mod_search_notebook.R"
      to: "app.R"
      via: "seed_request reactive return value"
      pattern: "seed_request\\("
    - from: "app.R"
      to: "R/mod_seed_discovery.R"
      via: "pre_fill_doi reactiveVal passed as parameter"
      pattern: "pre_fill_doi"
    - from: "app.R"
      to: "app.R"
      via: "observeEvent on seed_request sets current_view('discover') and pre_fill_doi"
      pattern: "current_view.*discover"
---

<objective>
Add "Use as Seed" button to abstract detail view and wire cross-module communication so clicking it navigates to seed discovery with the paper's DOI pre-filled and auto-looked-up.

Purpose: Creates fluid discovery workflows where users can seamlessly transition from viewing a paper to discovering its citation relationships, without manually copying DOIs.

Output: Modified mod_search_notebook.R (button + reactive return), modified app.R (bridge wiring), modified mod_seed_discovery.R (pre-fill acceptance + auto-lookup).
</objective>

<execution_context>
@C:/Users/sxthi/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/sxthi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/13-export-to-seed-workflow/13-RESEARCH.md
@R/mod_search_notebook.R
@R/mod_seed_discovery.R
@app.R
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add "Use as Seed" button and seed_request reactive return to mod_search_notebook</name>
  <files>R/mod_search_notebook.R</files>
  <action>
Two changes to mod_search_notebook.R:

**1. Add "Use as Seed" button to detail_actions output (line ~858):**

The current `output$detail_actions` renderUI only shows a close button. Change it to show both a "Use as Seed" button and the close button when a paper is viewed. The "Use as Seed" button should:
- Use `actionButton(ns("use_as_seed"), ...)` with `icon("seedling")` and class `btn-sm btn-outline-success me-1`
- Only appear when the viewed paper has a DOI (check `paper$doi` is not NULL/NA/empty)
- Be placed before the close button in a `div(class = "d-flex gap-1")`

To get the paper's DOI inside `detail_actions`, read `viewed_paper()` to get the paper_id, then look up the paper in `papers_data()` (same pattern as `abstract_detail` renderUI at line ~691).

**2. Add seed_request reactiveVal and observeEvent handler:**

- Add `seed_request <- reactiveVal(NULL)` near the top of the moduleServer block (after line ~226, near other reactiveVals)
- Add an `observeEvent(input$use_as_seed, { ... })` handler that:
  - Gets the current `viewed_paper()` id
  - Looks up the paper in `papers_data()` to get its DOI
  - Sets `seed_request(list(doi = paper$doi))` with the bare DOI value
  - Uses `ignoreInit = TRUE`

**3. Return the seed_request reactive:**

The function currently has no explicit return. Add `return(seed_request)` as the last line inside the `moduleServer()` block (before the closing `})` of moduleServer).

Note: The existing call in app.R line 859 `mod_search_notebook_server("search_notebook", ...)` does not capture a return value. Task 2 will update app.R to capture this.
  </action>
  <verify>
Search mod_search_notebook.R for:
- `use_as_seed` appears in both UI output and observeEvent
- `seed_request <- reactiveVal(NULL)` exists
- `return(seed_request)` exists at end of moduleServer
  </verify>
  <done>
"Use as Seed" button appears in abstract detail view for papers with DOI. Clicking it sets a seed_request reactive with the paper's DOI. Module returns seed_request reactive.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire reactive bridge in app.R and add pre_fill_doi to mod_seed_discovery</name>
  <files>app.R, R/mod_seed_discovery.R</files>
  <action>
**Changes to app.R:**

1. **Create pre_fill_doi reactiveVal** near line ~179 (after `current_view` and `current_notebook` declarations):
   ```r
   pre_fill_doi <- reactiveVal(NULL)
   ```

2. **Capture seed_request return from search notebook** at line ~859. Change:
   ```r
   mod_search_notebook_server("search_notebook", con_r, current_notebook, effective_config, notebook_refresh)
   ```
   To:
   ```r
   search_seed_request <- mod_search_notebook_server("search_notebook", con_r, current_notebook, effective_config, notebook_refresh)
   ```

3. **Pass pre_fill_doi to seed discovery module** at line ~862. Change:
   ```r
   discovery_request <- mod_seed_discovery_server("seed_discovery", reactive(con), config_file_r)
   ```
   To:
   ```r
   discovery_request <- mod_seed_discovery_server("seed_discovery", reactive(con), config_file_r, pre_fill_doi)
   ```

4. **Add observeEvent to wire the bridge** after the search notebook server call (after the new line ~859), before the existing `observeEvent(discovery_request(), ...)` block:
   ```r
   # Wire "Use as Seed" from search notebook to seed discovery
   observeEvent(search_seed_request(), {
     req <- search_seed_request()
     if (is.null(req)) return()

     # Navigate to seed discovery view
     current_view("discover")
     current_notebook(NULL)

     # Pre-fill DOI in seed discovery module
     pre_fill_doi(req$doi)

     # Clear the request to prevent re-trigger
     search_seed_request(NULL)
   }, ignoreInit = TRUE)
   ```

   Note: `search_seed_request(NULL)` resets via the reactive returned by the module. However, since `seed_request` is a reactiveVal inside mod_search_notebook, calling `search_seed_request(NULL)` from app.R won't work because the return is the reactive itself, not a setter. Instead, do NOT reset it from app.R. The module will handle its own state. Remove the `search_seed_request(NULL)` line. To prevent re-trigger, use `pre_fill_doi` as a one-shot: the seed discovery module should consume and clear it.

**Changes to R/mod_seed_discovery.R:**

1. **Add pre_fill_doi parameter** to function signature (line ~38). Change:
   ```r
   mod_seed_discovery_server <- function(id, con, config) {
   ```
   To:
   ```r
   mod_seed_discovery_server <- function(id, con, config, pre_fill_doi = NULL) {
   ```

2. **Add observeEvent to handle pre_fill_doi** inside the moduleServer block (after the `seed_paper <- reactiveVal(NULL)` line, around line ~44):
   ```r
   # Handle pre-filled DOI from "Use as Seed" button
   if (!is.null(pre_fill_doi)) {
     observeEvent(pre_fill_doi(), {
       doi <- pre_fill_doi()
       if (is.null(doi) || nchar(doi) == 0) return()

       # Pre-fill the DOI input
       updateTextInput(session, "doi_input", value = doi)

       # Auto-trigger lookup - reuse existing lookup logic
       # Get config values
       cfg <- config()
       email <- get_db_setting(con(), "openalex_email") %||%
                get_setting(cfg, "openalex", "email")
       api_key <- get_setting(cfg, "openalex", "api_key")

       if (is.null(email) || nchar(email) == 0) {
         showNotification(
           "OpenAlex email not configured. Please go to Settings.",
           type = "warning", duration = 5
         )
         return()
       }

       # Fetch paper automatically
       withProgress(message = "Looking up seed paper...", {
         paper <- tryCatch({
           get_paper(doi, email, api_key)
         }, error = function(e) {
           showNotification(
             paste("Error fetching paper:", e$message),
             type = "error", duration = 5
           )
           NULL
         })

         if (!is.null(paper)) {
           seed_paper(paper)
           showNotification("Seed paper loaded!", type = "message", duration = 3)
         } else {
           showNotification("Paper not found for this DOI.", type = "error", duration = 5)
         }
       })

       # Clear pre_fill_doi to prevent re-trigger on navigation
       pre_fill_doi(NULL)
     }, ignoreInit = TRUE)
   }
   ```

   Important: The `pre_fill_doi(NULL)` call works because `pre_fill_doi` is a reactiveVal from app.R passed by reference. Setting it to NULL prevents re-triggering if the user navigates away and back.
  </action>
  <verify>
1. Search app.R for `search_seed_request` and `pre_fill_doi` to confirm bridge wiring
2. Search mod_seed_discovery.R for `pre_fill_doi` parameter and auto-lookup logic
3. Run the app, open a search notebook with papers that have DOIs, click a paper, verify "Use as Seed" button appears, click it, verify navigation to discover view with DOI pre-filled and paper auto-looked-up
  </verify>
  <done>
Clicking "Use as Seed" in search notebook navigates to seed discovery view, DOI is pre-filled, paper is auto-looked-up, and user can immediately choose citation direction and create a new notebook. Original search notebook persists in sidebar and can be navigated back to.
  </done>
</task>

</tasks>

<verification>
1. Start the app and create/open a search notebook with papers
2. Click a paper that has a DOI - verify "Use as Seed" button appears alongside close button
3. Click "Use as Seed" - verify app navigates to seed discovery view
4. Verify DOI input is pre-filled with the paper's DOI
5. Verify paper lookup auto-triggers and paper preview appears
6. Select citation direction and click "Create Notebook with Results"
7. Verify new notebook is created and navigated to
8. Click back to original search notebook in sidebar - verify it still has all its papers and state
9. Test with a paper that has NO DOI - verify "Use as Seed" button does NOT appear
</verification>

<success_criteria>
- "Use as Seed" button visible in abstract detail for papers with DOI
- One click navigates to seed discovery with DOI pre-filled
- Paper auto-looked-up without manual "Look Up" click
- Original notebook preserved and accessible via sidebar
- Seeded search creates notebook with same filters/sorting as keyword search (existing behavior, no changes needed)
</success_criteria>

<output>
After completion, create `.planning/phases/13-export-to-seed-workflow/13-01-SUMMARY.md`
</output>
