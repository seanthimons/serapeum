---
phase: 20-foundation-connection-safety
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - R/_ragnar.R
  - tests/testthat/test-ragnar-helpers.R
autonomous: true

must_haves:
  truths:
    - "get_notebook_ragnar_path('abc-123') returns 'data/ragnar/abc-123.duckdb' without database lookups"
    - "encode_origin_metadata round-trips through decode_origin_metadata preserving section_hint, doi, and source_type"
    - "decode_origin_metadata gracefully returns 'general' section on malformed input"
  artifacts:
    - path: "R/_ragnar.R"
      provides: "Path helper and metadata encode/decode functions"
      contains: "get_notebook_ragnar_path"
    - path: "tests/testthat/test-ragnar-helpers.R"
      provides: "Tests for path and metadata helpers"
      contains: "encode_origin_metadata"
  key_links:
    - from: "R/_ragnar.R"
      to: "tests/testthat/test-ragnar-helpers.R"
      via: "TDD red-green cycle"
      pattern: "get_notebook_ragnar_path|encode_origin_metadata|decode_origin_metadata"
---

<objective>
Implement deterministic path construction and metadata encode/decode for per-notebook ragnar stores using TDD.

Purpose: FNDTN-01 requires notebook IDs to produce deterministic store paths without database lookups. FNDTN-02 requires section_hint metadata to survive round-trip through ragnar's origin field. Both have clear I/O contracts ideal for TDD.
Output: Three tested pure functions in `R/_ragnar.R` — `get_notebook_ragnar_path()`, `encode_origin_metadata()`, `decode_origin_metadata()` — plus comprehensive tests.
</objective>

<execution_context>
@C:/Users/sxthi/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/sxthi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/20-foundation-connection-safety/20-CONTEXT.md
@.planning/phases/20-foundation-connection-safety/20-RESEARCH.md
@R/_ragnar.R
@tests/testthat/test-ragnar.R
</context>

<tasks>

<task type="auto">
  <name>Task 1: RED — Write failing tests for path helper and metadata encode/decode</name>
  <files>tests/testthat/test-ragnar-helpers.R</files>
  <action>
Create new test file `tests/testthat/test-ragnar-helpers.R` with failing tests for three functions. These functions DO NOT exist yet — tests must fail.

**get_notebook_ragnar_path(notebook_id):**
- `get_notebook_ragnar_path("48fb8820-fbc0-4e75-bf46-92c6dae1db0b")` returns `"data/ragnar/48fb8820-fbc0-4e75-bf46-92c6dae1db0b.duckdb"`
- `get_notebook_ragnar_path("simple-id")` returns `"data/ragnar/simple-id.duckdb"`
- `get_notebook_ragnar_path(NULL)` throws error
- `get_notebook_ragnar_path("")` throws error

**encode_origin_metadata(base_origin, section_hint, doi, source_type):**
- `encode_origin_metadata("paper.pdf#page=5", section_hint="conclusion", doi="10.1234/abc", source_type="pdf")` returns string containing all four values separated by pipe `|`
- `encode_origin_metadata("paper.pdf#page=1")` uses defaults: section_hint="general", source_type="pdf", doi omitted
- Result always starts with base_origin
- Result contains `section=`, `type=` key-value pairs

**decode_origin_metadata(origin):**
- Round-trip: `decode_origin_metadata(encode_origin_metadata("paper.pdf#page=5", "conclusion", "10.1234/abc", "pdf"))` returns list with `base_origin="paper.pdf#page=5"`, `section_hint="conclusion"`, `doi="10.1234/abc"`, `source_type="pdf"`
- Handles missing DOI: encode without doi, decode returns `NA_character_` for doi
- Graceful fallback: `decode_origin_metadata("just-a-plain-string")` returns `section_hint="general"`, `base_origin="just-a-plain-string"`
- Graceful fallback: `decode_origin_metadata("")` returns `section_hint="general"`
- Handles pipe in DOI edge case (unlikely but test): DOIs contain `/` and `.` but not `|`, so standard DOIs parse correctly
  </action>
  <verify>Run `"C:\Program Files\R\R-4.5.1\bin\Rscript.exe" -e "testthat::test_file('tests/testthat/test-ragnar-helpers.R')"` — ALL tests must FAIL (functions don't exist yet).</verify>
  <done>Test file exists with 8+ test cases covering path helper, encode, decode, round-trip, and error handling. All tests fail because functions are not yet implemented.</done>
</task>

<task type="auto">
  <name>Task 2: GREEN — Implement path helper and metadata encode/decode functions</name>
  <files>R/_ragnar.R</files>
  <action>
Add three functions to the TOP of `R/_ragnar.R` (before existing functions), under a new section header:

**`get_notebook_ragnar_path(notebook_id)`:**
- Validate: stop if NULL, NA, or empty string
- Return `file.path("data", "ragnar", paste0(notebook_id, ".duckdb"))`
- No database lookups — pure string construction
- Per user decision: notebooks.id IS already UUID, no new column needed

**`encode_origin_metadata(base_origin, section_hint = "general", doi = NULL, source_type = "pdf")`:**
- Per user decision: human-readable pipe-delimited format with `=` key-value pairs
- Format: `{base_origin}|section={section_hint}|doi={doi}|type={source_type}`
- Omit `doi=` pair entirely when doi is NULL or empty (not `doi=NA`)
- Per user decision: validate on write only — check that section_hint and source_type are non-empty strings
- Three fields encoded per user decision: section_hint + DOI + source_type

**`decode_origin_metadata(origin)`:**
- Split on `|` delimiter
- First element is always base_origin
- Parse remaining elements as `key=value` pairs
- Extract `section`, `doi`, `type` keys
- Return named list: `list(base_origin, section_hint, doi, source_type)`
- Per user decision: on decode failure, treat chunk as "general" (no section targeting)
- Wrap in tryCatch — on ANY error, return fallback list with `section_hint = "general"` and NAs for doi/source_type
- Per user decision: trust format on read (no validation), only graceful fallback on parse failure
  </action>
  <verify>Run `"C:\Program Files\R\R-4.5.1\bin\Rscript.exe" -e "testthat::test_file('tests/testthat/test-ragnar-helpers.R')"` — ALL tests must PASS.</verify>
  <done>All three functions implemented in `R/_ragnar.R`. All tests pass. Path construction is deterministic without DB lookups. Metadata survives round-trip encode/decode. Malformed input gracefully falls back to "general" section.</done>
</task>

</tasks>

<verification>
1. `get_notebook_ragnar_path("any-uuid-here")` returns `"data/ragnar/any-uuid-here.duckdb"` — deterministic, no DB lookups (FNDTN-01)
2. `decode_origin_metadata(encode_origin_metadata(...))` preserves all three metadata fields (FNDTN-02)
3. `decode_origin_metadata("garbage")` returns `section_hint = "general"` without error (graceful degradation)
4. All existing tests in `tests/testthat/test-ragnar.R` still pass (no regression)
</verification>

<success_criteria>
- get_notebook_ragnar_path produces deterministic paths from notebook IDs
- Metadata encode/decode round-trips section_hint, DOI, and source_type
- Malformed origin strings gracefully fall back to "general" section
- All tests pass (new and existing)
</success_criteria>

<output>
After completion, create `.planning/phases/20-foundation-connection-safety/20-01-SUMMARY.md`
</output>
