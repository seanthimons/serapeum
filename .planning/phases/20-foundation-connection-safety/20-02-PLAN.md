---
phase: 20-foundation-connection-safety
plan: 02
type: execute
wave: 2
depends_on: ["20-01"]
files_modified:
  - R/_ragnar.R
  - app.R
autonomous: true

must_haves:
  truths:
    - "App creates data/ragnar/ directory on startup before any ragnar operations"
    - "Ragnar version is checked lazily on first RAG use and result is cached for the session"
    - "Connection helper closes ragnar store on error via on.exit() cleanup"
    - "Session cleanup hook closes active ragnar store when browser tab closes"
  artifacts:
    - path: "R/_ragnar.R"
      provides: "Version check and connection lifecycle helpers"
      contains: "check_ragnar_version"
    - path: "R/_ragnar.R"
      provides: "Connection helper with on.exit cleanup"
      contains: "with_ragnar_store"
    - path: "app.R"
      provides: "Eager directory creation on startup"
      contains: "data/ragnar"
  key_links:
    - from: "R/_ragnar.R"
      to: "app.R"
      via: "Directory must exist before store operations"
      pattern: "dir\\.create.*data.*ragnar"
    - from: "R/_ragnar.R check_ragnar_version"
      to: "session$userData"
      via: "Session-level version cache"
      pattern: "session\\$userData\\$ragnar_version"
    - from: "R/_ragnar.R with_ragnar_store"
      to: "on.exit"
      via: "Guaranteed cleanup on error or early return"
      pattern: "on\\.exit.*close"
---

<objective>
Add ragnar version checking, connection lifecycle helpers, and eager directory creation for per-notebook ragnar stores.

Purpose: FNDTN-03 requires version compatibility checks. TEST-02 requires explicit on.exit() cleanup and session$onSessionEnded() lifecycle management. The data/ragnar/ directory must exist before any store operations.
Output: `check_ragnar_version()`, `with_ragnar_store()`, and `register_ragnar_cleanup()` functions in `R/_ragnar.R`, plus directory creation in `app.R`.
</objective>

<execution_context>
@C:/Users/sxthi/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/sxthi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/20-foundation-connection-safety/20-CONTEXT.md
@.planning/phases/20-foundation-connection-safety/20-RESEARCH.md
@.planning/phases/20-foundation-connection-safety/20-01-SUMMARY.md
@R/_ragnar.R
@app.R
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add version check and connection lifecycle helpers to _ragnar.R</name>
  <files>R/_ragnar.R</files>
  <action>
Add three new functions to `R/_ragnar.R` after the path/metadata functions added in Plan 01.

**`check_ragnar_version(session = NULL)`:**
Per user decisions (all locked):
- Lazy check on first RAG use, NOT at startup
- Cache result in `session$userData$ragnar_version_checked`
- If cached, return cached value immediately
- Check if ragnar is installed with `requireNamespace("ragnar", quietly = TRUE)`
- If not installed: `message("[ragnar] Package not installed - RAG features disabled")`, return FALSE
- If installed: get version with `as.character(packageVersion("ragnar"))`
- Minimum required version: `"0.3.0"`
- Use `compareVersion(installed, minimum)` — if installed < minimum, warn and return FALSE
- If installed >= minimum (comparison >= 0): return TRUE
- Per user decision: warn but allow use (don't block RAG on incompatible version)
- Per pitfall 4 from research: allow patch updates (0.3.1, 0.3.2 etc), only warn on major/minor differences
- Add `# TODO: This could be replaced by renv version pinning` comment per user decision
- Cache result in session if session provided

**`with_ragnar_store(path, expr_fn, session = NULL)`:**
A connection helper that opens a ragnar store, runs a function, and guarantees cleanup.
- Opens store with `ragnar::ragnar_store_connect(path)`
- Sets `on.exit()` with `add = TRUE` to close store on ANY exit (error or normal return)
- Add `# TODO: This aggressive cleanup could be relaxed to selective cleanup later` per user decision
- Calls `expr_fn(store)` passing the open store
- On connection error: show global notification via `shiny::showNotification()` per user decision (toast/banner, not inline)
- Returns result of `expr_fn(store)` on success, NULL on error
- Per user decision: auto-retry on next feature use (no manual reconnect needed) — this is implicit because the function creates a fresh connection each call

**`register_ragnar_cleanup(session, store_rv)`:**
Per user decisions:
- Takes a Shiny session and a `reactiveVal` holding the active store
- Registers `session$onSessionEnded()` callback to close the store
- Per user decision: close connections on browser tab close
- Wraps close in tryCatch to ignore already-closed stores
- This is a helper that modules will call during initialization (Phase 21-22 will use it)
  </action>
  <verify>
Run `"C:\Program Files\R\R-4.5.1\bin\Rscript.exe" -e "for (f in list.files('R', pattern='\\.R$', full.names=TRUE)) source(f); cat('All R files sourced successfully\n')"` — all R files source without error.
Run `"C:\Program Files\R\R-4.5.1\bin\Rscript.exe" -e "testthat::test_file('tests/testthat/test-ragnar-helpers.R')"` — existing tests from Plan 01 still pass.
Run `"C:\Program Files\R\R-4.5.1\bin\Rscript.exe" -e "testthat::test_file('tests/testthat/test-ragnar.R')"` — existing ragnar tests still pass.
  </verify>
  <done>Three lifecycle functions added to _ragnar.R: lazy cached version check, connection-with-cleanup helper, session cleanup registration. All functions have #TODO markers per user decisions. All existing tests pass.</done>
</task>

<task type="auto">
  <name>Task 2: Add eager data/ragnar/ directory creation to app.R startup</name>
  <files>app.R</files>
  <action>
Per user decision: `data/ragnar/` directory created eagerly on app startup.

In `app.R`, after the database initialization line (`db_path <- get_setting(...)`) and before the UI definition, add directory creation:

```r
# Create ragnar store directory for per-notebook stores (v3.0)
ragnar_dir <- file.path("data", "ragnar")
if (!dir.create(ragnar_dir, showWarnings = FALSE, recursive = TRUE)) {
  if (!dir.exists(ragnar_dir)) {
    stop("Failed to create ", ragnar_dir, " directory. Check permissions and disk space.")
  }
}
```

Per research pitfall 5: do NOT just use `dir.create(..., showWarnings = FALSE)` silently. Check return value. Fail fast with clear message if creation fails. Use `recursive = TRUE` to create parent `data/` if needed.

Per user decision: `data/` directory is already gitignored — no .gitignore changes needed.
  </action>
  <verify>
Run `"C:\Program Files\R\R-4.5.1\bin\Rscript.exe" -e "source('app.R')"` does not error on the directory creation (app will fail later due to missing Shiny server, that's fine — the directory creation line must not error).
Verify `data/ragnar/` directory exists after running.
  </verify>
  <done>App startup creates `data/ragnar/` directory eagerly with proper error handling. Directory exists on disk. Fail-fast behavior on permission/disk errors.</done>
</task>

</tasks>

<verification>
1. `check_ragnar_version(session)` returns TRUE for ragnar 0.3.0+, caches in session$userData (FNDTN-03)
2. `with_ragnar_store()` opens, executes, and closes store — on.exit guarantees cleanup (TEST-02)
3. `register_ragnar_cleanup()` registers session$onSessionEnded callback (TEST-02)
4. `data/ragnar/` directory exists after app startup (store path convention)
5. All #TODO markers present per user decisions (version pinning, aggressive cleanup)
6. All existing tests pass (no regression)
</verification>

<success_criteria>
- Version check is lazy (not at startup), cached per session, warns but doesn't block
- Connection helper uses on.exit() for guaranteed cleanup on error
- Session cleanup hook registered via session$onSessionEnded()
- data/ragnar/ directory created eagerly on app startup with proper error handling
- #TODO markers present for future refinement per user decisions
</success_criteria>

<output>
After completion, create `.planning/phases/20-foundation-connection-safety/20-02-SUMMARY.md`
</output>
