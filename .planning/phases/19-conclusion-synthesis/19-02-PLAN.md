---
phase: 19-conclusion-synthesis
plan: 02
type: execute
wave: 2
depends_on: ["19-01"]
files_modified:
  - R/mod_document_notebook.R
  - R/mod_search_notebook.R
autonomous: false
user_setup: []

must_haves:
  truths:
    - "User receives synthesis of conclusions across papers from document notebook"
    - "User receives synthesis of conclusions across papers from search notebook"
    - "All synthesis output shows prominent AI-generated content disclaimer"
    - "Synthesis aggregates research positions with citations to source papers"
    - "Synthesis proposes future research directions based on identified gaps"
  artifacts:
    - path: "R/mod_document_notebook.R"
      provides: "Conclusions preset button and handler with disclaimer rendering"
      contains: "btn_conclusions"
    - path: "R/mod_search_notebook.R"
      provides: "Conclusions preset button in offcanvas chat with disclaimer rendering"
      contains: "btn_conclusions"
  key_links:
    - from: "R/mod_document_notebook.R"
      to: "R/rag.R"
      via: "handle_preset calls generate_conclusions_preset"
      pattern: "generate_conclusions_preset"
    - from: "R/mod_search_notebook.R"
      to: "R/rag.R"
      via: "observeEvent calls generate_conclusions_preset"
      pattern: "generate_conclusions_preset"
    - from: "R/mod_document_notebook.R"
      to: "message rendering"
      via: "Disclaimer banner prepended to synthesis responses"
      pattern: "alert-warning.*AI-Generated"
---

<objective>
Add conclusion synthesis preset buttons to both document and search notebook UIs with AI disclaimer banners.

Purpose: Complete the user-facing feature so researchers can trigger conclusion synthesis from either notebook type and see clearly-labeled AI-generated output with prominent disclaimers.

Output: "Conclusions" preset button in document notebook card header, "Conclusions" preset button in search notebook chat offcanvas, AI disclaimer banners on synthesis responses in both modules.
</objective>

<execution_context>
@C:/Users/sxthi/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/sxthi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/19-conclusion-synthesis/19-RESEARCH.md
@.planning/phases/19-conclusion-synthesis/19-01-SUMMARY.md

@R/mod_document_notebook.R
@R/mod_search_notebook.R
@R/rag.R
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Conclusions preset to both notebook modules with AI disclaimers</name>
  <files>
    R/mod_document_notebook.R
    R/mod_search_notebook.R
  </files>
  <action>
**Document Notebook (R/mod_document_notebook.R):**

1. Add "Conclusions" button to the preset button group in the UI (around line 46, after the "Outline" button, before "Slides"):
   ```r
   actionButton(ns("btn_conclusions"), "Conclusions",
                class = "btn-sm btn-outline-success",
                icon = icon("microscope"))
   ```
   Use `btn-outline-success` (green) to visually distinguish synthesis from other presets. Use `microscope` icon for research synthesis.

2. Add observeEvent handler (around line 464, with other preset handlers):
   ```r
   observeEvent(input$btn_conclusions, {
     req(!is_processing())
     req(has_api_key())
     is_processing(TRUE)

     msgs <- messages()
     msgs <- c(msgs, list(list(role = "user", content = "Generate: Conclusion Synthesis", timestamp = Sys.time(), preset_type = "conclusions")))
     messages(msgs)

     nb_id <- notebook_id()
     cfg <- config()

     response <- tryCatch({
       generate_conclusions_preset(con(), cfg, nb_id, notebook_type = "document", session_id = session$token)
     }, error = function(e) {
       sprintf("Error: %s", e$message)
     })

     msgs <- c(msgs, list(list(role = "assistant", content = response, timestamp = Sys.time(), preset_type = "conclusions")))
     messages(msgs)
     is_processing(FALSE)
   })
   ```
   IMPORTANT: Add `preset_type = "conclusions"` to BOTH user and assistant message lists. This is used to detect synthesis responses for disclaimer rendering.

3. Update the message rendering in `output$messages` (around line 337-356) to detect synthesis responses and prepend AI disclaimer:
   In the `lapply(msgs, function(msg) {...})` block, for assistant messages, check if `msg$preset_type` is "conclusions":
   ```r
   } else {
     # Check if this is a synthesis response
     is_synthesis <- !is.null(msg$preset_type) && identical(msg$preset_type, "conclusions")

     content_html <- div(
       class = "bg-white border p-2 rounded chat-markdown",
       style = "max-width: 90%;",
       if (is_synthesis) {
         div(
           class = "alert alert-warning py-2 px-3 mb-2 small",
           role = "alert",
           tags$strong(icon("triangle-exclamation"), " AI-Generated Content"),
           " - Verify all claims against original sources before use."
         )
       },
       HTML(commonmark::markdown_html(msg$content, extensions = TRUE))
     )

     div(class = "d-flex justify-content-start mb-2", content_html)
   }
   ```
   The disclaimer is a Bootstrap `alert-warning` with triangle-exclamation icon, placed ABOVE the synthesis content. Non-dismissible (always visible). Compact size using `py-2 px-3 mb-2 small` classes.

**Search Notebook (R/mod_search_notebook.R):**

4. Add "Conclusions" preset button to the search notebook chat offcanvas header. Currently the offcanvas header (around line 210-234) has just the title "Chat with Abstracts" and download/close buttons. Add a small button group below the header title, inside the offcanvas-body but above the messages area (around line 238-239, before the messages div):
   ```r
   # Preset buttons row (above messages)
   div(
     class = "border-bottom px-3 py-2",
     div(
       class = "btn-group btn-group-sm w-100",
       actionButton(ns("btn_conclusions"), "Conclusions",
                    class = "btn-sm btn-outline-success",
                    icon = icon("microscope"))
     )
   )
   ```
   Place this BEFORE the messages div but INSIDE the offcanvas-body. This gives the search notebook its first preset button.

5. Add the conclusions handler in the search notebook server (around line 1950, before the `return(seed_request)` line):
   ```r
   observeEvent(input$btn_conclusions, {
     req(!is_processing())
     req(has_api_key())
     is_processing(TRUE)

     msgs <- messages()
     msgs <- c(msgs, list(list(role = "user", content = "Generate: Conclusion Synthesis", timestamp = Sys.time(), preset_type = "conclusions")))
     messages(msgs)

     nb_id <- notebook_id()
     cfg <- config()

     response <- tryCatch({
       generate_conclusions_preset(con(), cfg, nb_id, notebook_type = "search", session_id = session$token)
     }, error = function(e) {
       if (inherits(e, "api_error")) {
         show_error_toast(e$message, e$details, e$severity)
       } else {
         err <- classify_api_error(e, "OpenRouter")
         show_error_toast(err$message, err$details, err$severity)
       }
       "Sorry, I encountered an error generating the synthesis."
     })

     msgs <- c(msgs, list(list(role = "assistant", content = response, timestamp = Sys.time(), preset_type = "conclusions")))
     messages(msgs)
     is_processing(FALSE)
   })
   ```
   Note: Use search notebook's error handling pattern (show_error_toast + classify_api_error) which differs from document notebook's simpler sprintf pattern.

6. Update the search notebook message rendering (around line 1882-1898) with the same disclaimer pattern:
   ```r
   } else {
     is_synthesis <- !is.null(msg$preset_type) && identical(msg$preset_type, "conclusions")

     content_html <- div(
       class = "bg-white border p-2 rounded chat-markdown",
       style = "max-width: 90%;",
       if (is_synthesis) {
         div(
           class = "alert alert-warning py-2 px-3 mb-2 small",
           role = "alert",
           tags$strong(icon("triangle-exclamation"), " AI-Generated Content"),
           " - Verify all claims against original sources before use."
         )
       },
       HTML(commonmark::markdown_html(msg$content, extensions = TRUE))
     )

     div(class = "d-flex justify-content-start mb-2", content_html)
   }
   ```

IMPORTANT NOTES:
- The `preset_type` field on message lists is a custom attribute. Standard messages from rag_query won't have it (NULL), so the `!is.null()` check handles backward compatibility.
- Use `identical()` not `==` for safe string comparison (handles NULL, NA).
- Both modules use `notebook_type` parameter to generate_conclusions_preset ("document" vs "search") so the backend knows whether to use section-filtered retrieval.
- The disclaimer text says "Verify all claims against original sources before use" per SYNTH-05 requirement and EU AI Act guidance.
  </action>
  <verify>
    - grep for "btn_conclusions" in R/mod_document_notebook.R confirms button exists
    - grep for "btn_conclusions" in R/mod_search_notebook.R confirms button exists
    - grep for "generate_conclusions_preset" in both module files confirms handler wiring
    - grep for "alert-warning" in both module files confirms disclaimer rendering
    - grep for "AI-Generated Content" in both module files confirms disclaimer text
    - grep for "preset_type.*conclusions" in both module files confirms synthesis detection
    - App starts without errors: `"C:\Program Files\R\R-4.5.1\bin\Rscript.exe" -e "shiny::runApp('.', port=3838)" &` then verify no startup crash
  </verify>
  <done>
    - "Conclusions" button visible in document notebook card header preset group (green outline, microscope icon)
    - "Conclusions" button visible in search notebook chat offcanvas (above messages area)
    - Clicking Conclusions in document notebook triggers generate_conclusions_preset with notebook_type="document"
    - Clicking Conclusions in search notebook triggers generate_conclusions_preset with notebook_type="search"
    - Synthesis responses show AI disclaimer banner above content in both modules
    - Disclaimer is prominent (alert-warning), includes icon, and states "Verify all claims"
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify conclusion synthesis in both notebook types</name>
  <what-built>
    Complete conclusion synthesis feature across both notebook types:
    1. Document notebook: "Conclusions" preset button (green, microscope icon) in chat header alongside existing presets
    2. Search notebook: "Conclusions" preset button in chat offcanvas panel
    3. AI disclaimer banners on all synthesis responses
    4. Section-targeted RAG retrieval for document notebooks (conclusion/limitations/future work sections)
    5. Generic retrieval for search notebooks (abstracts don't have section structure)
  </what-built>
  <how-to-verify>
    1. Open a document notebook with at least one uploaded PDF that has been processed
    2. Click the "Conclusions" button in the chat header
    3. Verify:
       - A "Generate: Conclusion Synthesis" user message appears
       - An AI response appears with "## Research Conclusions" and "## Research Gaps & Future Directions" headers
       - A yellow warning banner appears ABOVE the synthesis text saying "AI-Generated Content - Verify all claims against original sources before use"
    4. Open a search notebook with papers loaded
    5. Click "Chat" button to open the offcanvas chat panel
    6. Click the "Conclusions" button in the chat panel
    7. Verify same behavior: synthesis output with AI disclaimer banner
    8. Verify that regular chat messages (non-synthesis) do NOT show the disclaimer banner
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues</resume-signal>
</task>

</tasks>

<verification>
- SYNTH-01: Conclusions preset button triggers in search notebook chat
- SYNTH-02: Conclusions preset button triggers in document notebook chat
- SYNTH-03: Document notebook synthesis uses section-filtered retrieval (conclusion/limitations/future_work/discussion/late_section)
- SYNTH-04: Output includes Research Conclusions + Research Gaps & Future Directions sections
- SYNTH-05: All synthesis outputs show prominent AI-Generated Content disclaimer
</verification>

<success_criteria>
- Both notebook types have working Conclusions preset buttons
- Synthesis output aggregates research positions with citations
- Synthesis proposes future research directions
- AI disclaimer banner is visible and prominent on all synthesis responses
- Non-synthesis messages render normally without disclaimer
- Cost is logged for all synthesis operations
</success_criteria>

<output>
After completion, create `.planning/phases/19-conclusion-synthesis/19-02-SUMMARY.md`
</output>
