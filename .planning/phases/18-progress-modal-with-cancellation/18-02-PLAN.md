---
phase: 18-progress-modal-with-cancellation
plan: 02
type: execute
wave: 2
depends_on: ["18-01"]
files_modified:
  - R/mod_citation_network.R
autonomous: false

must_haves:
  truths:
    - "User sees progress modal with animated bar and status text during citation network build"
    - "User can click Stop button to cancel citation network build mid-operation"
    - "Cancelled builds display accumulated nodes collected before cancellation"
    - "Progress modal shows updating status messages"
  artifacts:
    - path: "R/mod_citation_network.R"
      provides: "Progress modal with animated bar, JavaScript handler, cancel button, partial result handling"
      contains: "updateBuildProgress"
  key_links:
    - from: "R/mod_citation_network.R cancel button"
      to: "R/interrupt.R"
      via: "signal_interrupt(flag_file) writes 'interrupt' to flag file"
      pattern: "signal_interrupt"
    - from: "R/mod_citation_network.R cancel button"
      to: "R/mod_citation_network.R ExtendedTask"
      via: "network_task$cancel() stops the mirai process"
      pattern: "network_task\\$cancel"
    - from: "R/mod_citation_network.R UI"
      to: "R/mod_citation_network.R server"
      via: "JavaScript updateBuildProgress handler updates modal DOM elements"
      pattern: "updateBuildProgress"
    - from: "R/mod_citation_network.R result handler"
      to: "R/mod_citation_network.R"
      via: "partial=TRUE triggers layout computation and partial notification"
      pattern: "result\\$partial"
---

<objective>
Add polished progress modal with animated bar, JavaScript-driven updates, Stop button with cancel handler, and partial result display to the async citation network build.

Purpose: Plan 01 established the async ExtendedTask + mirai infrastructure with a basic modal. This plan adds the user-facing polish: an animated progress bar with status text, a Stop button that triggers the interrupt flag, and proper handling of partial results when cancelled.

Output: Users see a professional progress modal during builds, can cancel mid-operation and see partial results, and the UI communicates build status clearly.
</objective>

<execution_context>
@C:/Users/sxthi/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/sxthi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/18-progress-modal-with-cancellation/18-RESEARCH.md
@.planning/phases/18-progress-modal-with-cancellation/18-01-SUMMARY.md
@R/mod_citation_network.R
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add progress modal UI, JavaScript handler, cancel button, and partial result notifications</name>
  <files>R/mod_citation_network.R</files>
  <action>
Enhance the basic modal from plan 01 with animated progress bar, JavaScript-driven updates, Stop button with cancel handler, and partial result notification.

**A. Register JavaScript handler in UI function:**

Add to `mod_citation_network_ui`, inside the existing `tagList`, a `tags$script(HTML(...))` block:
```javascript
Shiny.addCustomMessageHandler('updateBuildProgress', function(data) {
  var bar = document.getElementById(data.bar_id);
  if (bar) {
    bar.style.width = data.percent + '%';
    bar.textContent = data.percent + '%';
    bar.setAttribute('aria-valuenow', data.percent);
  }
  var msg = document.getElementById(data.msg_id);
  if (msg) {
    msg.textContent = data.message;
  }
});
```
This is registered once (not per-modal-show), avoiding memory leak pitfall from research.

**B. Enhance the modal in the build_network observeEvent:**

Replace the basic `showModal(modalDialog(...))` from plan 01 with a richer modal:
```r
showModal(modalDialog(
  title = tagList(icon("spinner", class = "fa-spin"), "Building Citation Network"),
  tags$div(
    class = "progress",
    style = "height: 25px;",
    tags$div(
      id = ns("build_progress_bar"),
      class = "progress-bar progress-bar-striped progress-bar-animated",
      role = "progressbar",
      style = "width: 5%;",
      `aria-valuenow` = "5",
      `aria-valuemin` = "0",
      `aria-valuemax` = "100",
      "5%"
    )
  ),
  tags$div(
    id = ns("build_progress_message"),
    class = "text-muted mt-2",
    "Initializing..."
  ),
  footer = actionButton(ns("cancel_build"), "Stop", class = "btn-warning", icon = icon("stop")),
  easyClose = FALSE,
  size = "m"
))
```

**C. Add polling observer after the invoke call** (still inside build_network observeEvent):
```r
poll_count <- reactiveVal(0L)
poller <- observe({
  invalidateLater(2000)  # every 2 seconds
  n <- isolate(poll_count()) + 1L
  poll_count(n)
  # Increment progress bar smoothly: 5% -> ~85% over time
  pct <- min(5 + n * 8, 85)
  session$sendCustomMessage("updateBuildProgress", list(
    bar_id = ns("build_progress_bar"),
    msg_id = ns("build_progress_message"),
    percent = pct,
    message = paste0("Fetching citations (step ", n, ")...")
  ))
})
progress_poller(poller)  # Store in reactiveVal so cancel/result handlers can destroy it
```

**D. Add cancel button handler:**
```r
observeEvent(input$cancel_build, {
  # Signal interrupt to the running mirai process via file flag
  flag_file <- current_interrupt_flag()
  if (!is.null(flag_file)) {
    signal_interrupt(flag_file)
  }

  # Cancel the ExtendedTask
  network_task$cancel()

  # Stop progress poller
  poller <- progress_poller()
  if (!is.null(poller)) {
    poller$destroy()
    progress_poller(NULL)
  }

  # Close modal immediately (don't wait for task return)
  removeModal()

  # Clean up flag
  clear_interrupt_flag(flag_file)
  current_interrupt_flag(NULL)

  showNotification(
    "Network build stopped. Partial results will display if available.",
    type = "warning", duration = 5
  )
})
```

**E. Enhance the result handler** (from plan 01's basic handler) to:
1. Destroy the progress poller: `poller <- progress_poller(); if (!is.null(poller)) { poller$destroy(); progress_poller(NULL) }`
2. Show different notifications for partial vs full results:
   - Partial: `sprintf("Partial network: %d nodes, %d edges (stopped by user)", ...)`  with `type = "message", duration = 8`
   - Full: `sprintf("Network built: %d nodes, %d edges", ...)` with `type = "message"`
  </action>
  <verify>
1. Search for "updateBuildProgress" in R/mod_citation_network.R (must exist in both UI script and server sendCustomMessage).
2. Search for "cancel_build" in R/mod_citation_network.R (must exist as actionButton and observeEvent).
3. Search for "signal_interrupt" in R/mod_citation_network.R (must exist in cancel handler).
4. Search for "progress_poller" in R/mod_citation_network.R (must exist as reactiveVal and be destroyed in both cancel and result handlers).
5. Search for "partial" in R/mod_citation_network.R (must appear in result handler notification logic).
6. Start the app and confirm no startup errors.
  </verify>
  <done>
- Progress modal shows animated bar with spinner title, status text, and Stop button
- JavaScript handler registered once in UI (no memory leak)
- Progress bar increments via polling observer every 2 seconds
- Stop button triggers signal_interrupt + network_task$cancel + modal close
- Progress poller destroyed on both cancel and completion (no leaked observers)
- Partial results show "stopped by user" notification with node/edge counts
- Full results show standard completion notification
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify progress modal, cancel, and partial results</name>
  <what-built>Async citation network build with progress modal, cancel button, and partial results</what-built>
  <how-to-verify>
1. Open the app at http://localhost:3838
2. Navigate to Citation Network tab
3. Select any seed paper and click "Build Network" with depth=2, node_limit=100
4. **Progress modal test:** Verify a modal appears with:
   - Spinner icon and "Building Citation Network" title
   - Animated progress bar that increments
   - Status text updating (e.g., "Fetching citations (step 1)...")
   - A yellow "Stop" button in the footer
   - Modal cannot be dismissed by clicking outside
5. **Full build test:** Let the build complete. Modal should close, network should display, notification should say "Network built: X nodes, Y edges"
6. **Cancel test:** Start another build (depth=2 or depth=3 for longer operation). Click "Stop" partway through.
   - Modal should close immediately
   - Notification should say "Partial network" or "stopped by user"
   - If partial nodes were collected, a partial network should display
7. **UI responsiveness test:** During a build, try interacting with other UI elements. The app should remain responsive (not frozen).
8. **Subsequent build test:** After a cancel, start a new build. It should work normally without leftover state.
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
- Progress modal shows with animated bar, status text, and Stop button
- Cancel button triggers interrupt flag + task cancellation + modal close
- Partial results displayed with distinct notification when cancelled
- Full results displayed with standard notification when completed
- Progress poller destroyed on both cancel and completion
- JavaScript handler registered once (no memory leak)
- App remains responsive during builds
</verification>

<success_criteria>
1. User sees progress modal with animated bar and status text during citation network build
2. User can click Stop to cancel build; modal closes immediately
3. Cancelled builds display partial results (accumulated nodes before cancellation)
4. Progress modal shows updating status messages
5. App UI remains responsive during async build
6. No leaked observers, flag files, or mirai processes after cancel or completion
</success_criteria>

<output>
After completion, create `.planning/phases/18-progress-modal-with-cancellation/18-02-SUMMARY.md`
</output>
