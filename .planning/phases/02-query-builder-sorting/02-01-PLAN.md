---
phase: 02-query-builder-sorting
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - R/mod_search_notebook.R
  - R/db.R
autonomous: true

must_haves:
  truths:
    - "Search results can be sorted by citation count (descending)"
    - "Search results can be sorted by FWCI (descending, nulls at bottom)"
    - "Search results can be sorted by outgoing citation count (descending)"
    - "Search results can be sorted by year (descending, default)"
    - "Papers with missing FWCI display a dash instead of NA"
  artifacts:
    - path: "R/db.R"
      provides: "list_abstracts with sort_by parameter"
      contains: "ORDER BY.*NULLS LAST"
    - path: "R/mod_search_notebook.R"
      provides: "Sort radio buttons in paper list header"
      contains: "sort_by"
  key_links:
    - from: "R/mod_search_notebook.R"
      to: "R/db.R"
      via: "list_abstracts(con(), nb_id, sort_by = input$sort_by)"
      pattern: "list_abstracts.*sort_by"
---

<objective>
Add sort controls to search notebook paper list, enabling users to sort results by citation count, FWCI, outgoing citations, or year.

Purpose: Search results currently display in fixed year-descending order. Researchers need to prioritize papers by impact metrics to find the most relevant work quickly.
Output: Sort radio buttons in paper list header; SQL-backed sorting with NULL handling.
</objective>

<execution_context>
@C:/Users/sxthi/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/sxthi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-query-builder-sorting/02-RESEARCH.md
@R/mod_search_notebook.R
@R/db.R
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add sort_by parameter to list_abstracts and sort UI controls</name>
  <files>R/db.R, R/mod_search_notebook.R</files>
  <action>
**R/db.R — Add sort_by parameter to list_abstracts:**

Find the `list_abstracts` function (line ~591). Change its signature and body to accept an optional `sort_by` parameter:

```r
list_abstracts <- function(con, notebook_id, sort_by = "year") {
  # Validate sort_by against enum to prevent SQL injection
  valid_sorts <- c("cited_by_count", "fwci", "referenced_works_count", "year")
  if (!sort_by %in% valid_sorts) sort_by <- "year"

  order_clause <- switch(sort_by,
    cited_by_count = "cited_by_count DESC NULLS LAST",
    fwci = "fwci DESC NULLS LAST",
    referenced_works_count = "referenced_works_count DESC NULLS LAST",
    year = "year DESC, created_at DESC",
    "year DESC, created_at DESC"
  )

  dbGetQuery(con, sprintf("
    SELECT * FROM abstracts WHERE notebook_id = ? ORDER BY %s
  ", order_clause), list(notebook_id))
}
```

All sort options use `NULLS LAST` so papers with missing metrics sink to bottom. The `year` sort preserves the existing secondary sort by `created_at`.

**R/mod_search_notebook.R — Add sort controls to UI:**

In `mod_search_notebook_ui` (line ~36), inside the `card_body` for the paper list, add sort radio buttons ABOVE the existing filter checkbox (before the `div(class = "mb-2"` that contains `checkboxInput`). Insert:

```r
div(
  class = "mb-2",
  radioButtons(
    ns("sort_by"),
    NULL,
    choices = c(
      "Newest" = "year",
      "Most cited" = "cited_by_count",
      "Impact (FWCI)" = "fwci",
      "Most refs" = "referenced_works_count"
    ),
    selected = "year",
    inline = TRUE
  )
),
```

**R/mod_search_notebook.R — Wire sort_by into papers_data reactive:**

In `papers_data` reactive (line ~292), change:
```r
list_abstracts(con(), nb_id)
```
to:
```r
sort_by <- input$sort_by %||% "year"
list_abstracts(con(), nb_id, sort_by = sort_by)
```

This adds `input$sort_by` as a reactive dependency so changing the sort option re-fetches papers in the new order.

**Important constraints:**
- Do NOT touch any other part of mod_search_notebook.R. These are the only 3 insertion points.
- The `%||%` operator is already available (used elsewhere in the codebase).
- Do NOT persist sort preference to database — it's session-only UI state.
  </action>
  <verify>
1. Run: `"C:\Program Files\R\R-4.5.1\bin\Rscript.exe" -e "source('R/db.R'); cat('list_abstracts has sort_by:', 'sort_by' %in% names(formals(list_abstracts)), '\n')"`
2. Run: `"C:\Program Files\R\R-4.5.1\bin\Rscript.exe" -e "testthat::test_dir('tests/testthat')"` — all existing tests pass
3. Grep for `sort_by` in mod_search_notebook.R — should appear in UI (radioButtons) and server (papers_data reactive)
4. Grep for `NULLS LAST` in db.R — should appear in list_abstracts order clauses
  </verify>
  <done>
- list_abstracts accepts sort_by parameter with 4 valid options and NULLS LAST on all
- Sort radio buttons visible in search notebook paper list header (inline, 4 options)
- Changing sort option re-fetches papers in new order
- All existing tests pass without modification
  </done>
</task>

<task type="auto">
  <name>Task 2: Ensure graceful display of missing metrics</name>
  <files>R/mod_search_notebook.R</files>
  <action>
Verify that `format_citation_metrics` (line ~197) already handles NULL/NA gracefully:
- `cited_by` uses `%||% 0` — shows 0 for missing (GOOD)
- `fwci` checks `!is.null(fwci) && !is.na(fwci)` before displaying — omits when missing (GOOD)
- `refs` uses `%||% 0` — shows 0 for missing (GOOD)

This function already handles missing metrics correctly per the research recommendations. The only issue is papers where ALL metrics are missing should still render cleanly.

**Verify the paper list rendering** (line ~740-770 area) to confirm `format_citation_metrics` is called with correct column names from the papers data frame. Check that `paper$cited_by_count`, `paper$fwci`, and `paper$referenced_works_count` are the actual column names in the abstracts table.

If `format_citation_metrics` already handles all cases correctly: document this in the commit message and move on. No code changes needed if the existing implementation is already correct.

If any edge case is found (e.g., raw "NA" string rendering): fix it with the pattern `value %||% 0` for counts or conditional display for FWCI.
  </action>
  <verify>
1. Grep `format_citation_metrics` calls in mod_search_notebook.R — confirm all pass `paper$cited_by_count`, `paper$fwci`, `paper$referenced_works_count`
2. Grep for raw "NA" display in paper rendering sections — should find none
3. All existing tests still pass
  </verify>
  <done>
- Papers with missing FWCI show no FWCI badge (not "NA")
- Papers with missing citation counts show 0 (not "NA")
- No raw "NA" text appears in rendered paper cards
  </done>
</task>

</tasks>

<verification>
1. Start the app: `"C:\Program Files\R\R-4.5.1\bin\Rscript.exe" app.R`
2. Open a search notebook with papers
3. Sort radio buttons visible above paper list (Newest, Most cited, Impact, Most refs)
4. Click each sort option — papers reorder correctly
5. Papers with missing FWCI show no FWCI badge (not "NA" or blank)
6. Default sort is "Newest" (year descending)
</verification>

<success_criteria>
- Sort controls visible and functional in search notebook
- 4 sort options: year, cited_by_count, fwci, referenced_works_count
- SQL ORDER BY with NULLS LAST on all metric sorts
- No "NA" display for missing metrics
- All existing tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/02-query-builder-sorting/02-01-SUMMARY.md`
</output>
