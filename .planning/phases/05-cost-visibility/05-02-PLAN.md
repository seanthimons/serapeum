---
phase: 05-cost-visibility
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - R/rag.R
  - R/slides.R
  - R/mod_query_builder.R
  - R/mod_document_notebook.R
  - R/_ragnar.R
  - R/mod_cost_tracker.R
  - app.R
autonomous: false
user_setup: []

must_haves:
  truths:
    - "User sees per-request cost displayed after each chat message"
    - "User sees per-request cost displayed after embedding operations"
    - "User sees running session total cost in the sidebar"
    - "User can view cost history over time with daily aggregation"
    - "User can identify which operations consume the most credits"
    - "All existing chat and embedding callers still work correctly"
  artifacts:
    - path: "R/mod_cost_tracker.R"
      provides: "Cost visibility UI module with session total, history table, and trend chart"
      min_lines: 100
    - path: "R/rag.R"
      provides: "Updated chat/embedding calls that capture and log cost"
      contains: "log_cost"
    - path: "R/mod_document_notebook.R"
      provides: "Updated embedding call that captures and logs cost"
      contains: "log_cost"
    - path: "R/slides.R"
      provides: "Updated chat call that captures and logs cost"
      contains: "log_cost"
    - path: "R/mod_query_builder.R"
      provides: "Updated chat call that captures and logs cost"
      contains: "log_cost"
    - path: "app.R"
      provides: "Cost tracker module wired into sidebar and main content"
      contains: "mod_cost_tracker"
  key_links:
    - from: "R/rag.R"
      to: "R/cost_tracking.R"
      via: "log_cost() calls after each API call"
      pattern: "log_cost\\("
    - from: "R/mod_cost_tracker.R"
      to: "R/cost_tracking.R"
      via: "get_session_costs, get_cost_history, get_cost_by_operation"
      pattern: "get_session_costs|get_cost_history"
    - from: "app.R"
      to: "R/mod_cost_tracker.R"
      via: "module server/UI calls"
      pattern: "mod_cost_tracker"
---

<objective>
Update all API callers to handle new return types and log costs, create the cost tracker UI module, and wire it into the app.

Purpose: This connects the backend cost infrastructure (Plan 01) to the user-facing UI, completing all 5 success criteria for Phase 5.

Output: Updated caller files, new mod_cost_tracker.R, updated app.R.
</objective>

<execution_context>
@C:/Users/sxthi/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/sxthi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-cost-visibility/05-01-SUMMARY.md
@R/api_openrouter.R
@R/rag.R
@R/slides.R
@R/mod_query_builder.R
@R/mod_document_notebook.R
@R/_ragnar.R
@R/cost_tracking.R
@app.R
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update all API callers to handle new return types and log costs</name>
  <files>R/rag.R, R/slides.R, R/mod_query_builder.R, R/mod_document_notebook.R, R/_ragnar.R</files>
  <action>
After Plan 01, `chat_completion()` returns `list(content, usage, model, id)` and `get_embeddings()` returns `list(embeddings, usage, model)`. Every caller must be updated.

**IMPORTANT**: Each caller function needs access to `con` (DB connection) and `session_id` to log costs. For functions that don't have these (like rag.R helpers), pass them as parameters or make cost logging optional (log only if con is provided).

**Strategy for cost logging in non-module code**: Add optional `con = NULL` and `session_id = NULL` parameters to rag.R functions. If both are provided, log the cost. If not, skip logging (graceful degradation).

**R/rag.R** has 3 call sites:

1. `get_embeddings()` call (~line 96): Currently `result <- get_embeddings(api_key, embed_model, question)` then uses `result[[1]]`.
   - Change to: `result <- get_embeddings(api_key, embed_model, question)` then use `result$embeddings[[1]]` for the vector.
   - After the call, if `con` and `session_id` are available, call:
     ```r
     if (!is.null(con) && !is.null(session_id)) {
       cost <- estimate_cost(embed_model, result$usage$prompt_tokens %||% 0, 0)
       log_cost(con, "embedding", embed_model, result$usage$prompt_tokens %||% 0, 0,
                result$usage$total_tokens %||% 0, cost, session_id)
     }
     ```

2. `chat_completion()` call in `rag_chat()` (~line 138): Currently assigns response directly.
   - Change to: `result <- chat_completion(api_key, chat_model, messages)` then `response <- result$content`.
   - Log cost similarly.

3. `chat_completion()` call in `generate_content()` (~line 221): Same pattern.
   - Update the function signature of `rag_chat()` and `generate_content()` to accept optional `con = NULL, session_id = NULL` parameters.

**R/slides.R** (~line 279):
- `chat_completion(api_key, model, messages)` returns content string currently.
- Change to: `result <- chat_completion(api_key, model, messages)` then `qmd_content <- result$content`.
- The `generate_slides()` function needs optional `con = NULL, session_id = NULL` params.
- Log cost with operation = "slide_generation".

**R/mod_query_builder.R** (~line 89):
- Inside a Shiny module server, so `con` is available as a reactive.
- Change `chat_completion(api_key, model, ...)` to capture the list result.
- Extract content: `result$content`.
- Log cost with operation = "query_build".
- Generate a session_id from `session$token` (available in Shiny module servers).

**R/mod_document_notebook.R** (~line 249):
- `get_embeddings(api_key, embed_model, batch$content)` currently returns list of vectors.
- Change to capture `result$embeddings` for the vectors.
- Log cost with operation = "embedding" for each batch.
- `con` is available as `con_r()` in the module.

**R/_ragnar.R** (~line 42):
- `get_embeddings(openrouter_api_key, embed_model, texts)` returns list of vectors.
- Change to `result$embeddings`.
- This is a ragnar utility function — make cost logging optional here too.

**For every caller update, preserve existing error handling (tryCatch blocks).** The cost logging should happen INSIDE the tryCatch success path, not outside it.

Also update the call sites in app.R that call `rag_chat()` and `generate_content()` indirectly (through module servers) — these are already handled because the modules pass con. Specifically, check `mod_document_notebook.R` and `mod_search_notebook.R` for calls to `rag_chat()` and pass the session_id.

To get session_id in modules: use `session$token` which is a unique string per Shiny session. Pass it to rag functions.
  </action>
  <verify>
1. Run the app: `"C:\Program Files\R\R-4.5.1\bin\Rscript.exe" -e "shiny::runApp('.')"` — app should start without errors.
2. Check that all modified files source without error:
```r
for (f in list.files("R", pattern = "\\.R$", full.names = TRUE)) source(f)
```
3. In the running app: send a chat message in a document notebook, verify the response still appears (confirms chat_completion return type handled correctly).
4. Check cost_log table has a new row after the chat: `DBI::dbGetQuery(con, "SELECT * FROM cost_log")`
  </verify>
  <done>
- All 5 files updated to handle list return types from chat_completion/get_embeddings
- Cost is logged after every API call (chat, embedding, query_build, slide_generation)
- Existing chat and embedding functionality works exactly as before from the user perspective
- cost_log table accumulates rows as the user interacts
  </done>
</task>

<task type="auto">
  <name>Task 2: Create cost tracker UI module and wire into app</name>
  <files>R/mod_cost_tracker.R, app.R</files>
  <action>
**Create R/mod_cost_tracker.R** — a new Shiny module for cost visibility.

`mod_cost_tracker_ui(id)` returns:
- A bslib `card()` containing:
  1. **Session summary** at top: A `value_box()` (from bslib) showing session total cost formatted as "$0.0000" with the label "Session Cost" and a dollar-sign icon. Use `showcase_layout = "left center"`.
  2. **Recent requests table**: A styled HTML table showing the last 20 cost_log entries for this session. Columns: Time (relative, e.g., "2m ago"), Operation (with icon), Model (shortened), Tokens, Cost. Use `tableOutput()`.
  3. **Cost history section** (collapsible via `<details>`):
     - A bar chart showing daily costs for the last 30 days. Use base R `barplot()` rendered via `plotOutput()` with height="200px". X-axis = date, Y-axis = USD.
     - A summary table below showing cost by operation type (from `get_cost_by_operation()`). Columns: Operation, Requests, Total Cost, Avg Cost.

`mod_cost_tracker_server(id, con_r, session_id_r)` — takes reactive DB connection and reactive session_id:
- `session_total` reactive: Polls `get_session_costs(con, session_id)` every 10 seconds using `reactiveTimer(10000)`. Extracts `attr(result, "total_cost")` for the value box.
- `recent_requests` reactive: Same polling, returns the data frame for the table.
- `cost_history` reactive: Calls `get_cost_history(con, 30)` — refresh on manual trigger or every 60 seconds.
- `cost_by_operation` reactive: Calls `get_cost_by_operation(con, 30)` — same refresh.
- Render the value box, table, and plot outputs.

**For the session cost display in the sidebar** (always visible):
- Add a small inline cost display in the sidebar of app.R, below the notebook list but above the settings/about links.
- Use `textOutput("session_cost_display")` styled as a small muted text like "Session: $0.0012".
- In the server, render this from the cost tracker module's session total.

**In app.R:**

1. Add `mod_cost_tracker_ui("cost_tracker")` as a view option (similar to settings/about). Add a sidebar link:
   ```r
   actionLink("cost_link", label = tagList(icon("dollar-sign"), "Costs"),
              class = "text-muted")
   ```
   Place it next to the settings and about links in the sidebar footer area.

2. Add the inline session cost display in the sidebar, between the `hr()` and the settings/about links:
   ```r
   div(
     class = "d-flex justify-content-between align-items-center mb-2 px-2",
     span(class = "text-muted small", icon("coins"), " Session:"),
     textOutput("session_cost_inline", inline = TRUE) |>
       tagAppendAttributes(class = "text-muted small fw-semibold")
   )
   ```

3. Create session_id in server: `session_id <- session$token`

4. Wire the module server:
   ```r
   mod_cost_tracker_server("cost_tracker", con_r, reactive(session_id))
   ```

5. Add the cost view routing:
   ```r
   observeEvent(input$cost_link, {
     current_view("costs")
     current_notebook(NULL)
   })
   ```
   And in `output$main_content`:
   ```r
   if (view == "costs") {
     return(mod_cost_tracker_ui("cost_tracker"))
   }
   ```

6. Render the inline session cost:
   ```r
   output$session_cost_inline <- renderText({
     # Poll every 10 seconds
     invalidateLater(10000)
     costs <- get_session_costs(con, session_id)
     total <- attr(costs, "total_cost") %||% 0
     sprintf("$%.4f", total)
   })
   ```

**Styling notes:**
- Use bslib card components consistently with existing app style
- Use Font Awesome icons: "dollar-sign" for costs link, "coins" for session display
- Format costs as "$0.0000" (4 decimal places) for per-request, "$0.00" (2 decimal places) for daily totals
- Operation icons: "comment" for chat, "brain" for embedding, "wand-magic-sparkles" for query_build, "presentation" for slide_generation
- Use the app's existing theme (shiny preset, primary #6366f1)
  </action>
  <verify>
1. App starts without errors
2. Navigate to Costs page via sidebar link — page renders with session summary, empty table, and history section
3. Send a chat message in a document notebook, return to Costs page — session total updates, recent requests table shows the entry
4. Session cost display in sidebar shows running total
  </verify>
  <done>
- mod_cost_tracker.R exists with UI and server functions
- Costs link in sidebar navigates to cost tracker view
- Session total displays inline in sidebar and updates every 10 seconds
- Recent requests table shows operation, model, tokens, cost
- Cost history chart shows daily costs for last 30 days
- Cost by operation summary shows which operations cost most
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify complete cost visibility system</name>
  <files>R/mod_cost_tracker.R, app.R</files>
  <action>
Human verification of the complete cost visibility system: API cost capture, database logging, session totals in sidebar, cost history page with charts and breakdowns.
  </action>
  <verify>
1. Start the app: open browser to localhost:8080
2. Check sidebar: you should see "Session: $0.0000" near the bottom, and a "Costs" link
3. Open a document notebook and send a chat message (requires OpenRouter API key in settings)
4. After receiving the response, check:
   a. The sidebar session cost should update (e.g., "Session: $0.0012")
   b. Click "Costs" in sidebar to open the cost tracker page
   c. Verify: session total value box shows the cost
   d. Verify: recent requests table shows the chat request with model, tokens, cost
5. If you have historical data (multiple requests), check the "Cost History" section:
   a. Bar chart should show daily totals
   b. Cost by operation table should show breakdown
6. Run an embedding operation (click "Embed Papers" in a document notebook with PDFs):
   a. Verify embedding costs appear in the cost tracker
   b. Session total should increase
  </verify>
  <done>
- All cost visibility features verified by user
- Session cost updates in real-time in sidebar
- Cost tracker page shows complete breakdown
- Existing app functionality unaffected
  </done>
</task>

</tasks>

<verification>
1. App starts and all R files source without error
2. cost_log table exists and accumulates rows during usage
3. Session cost displays in sidebar and updates reactively
4. Cost tracker page shows session detail, history chart, and operation breakdown
5. All existing functionality (chat, embeddings, search, slides) still works correctly
6. Costs are logged for all 4 operation types: chat, embedding, query_build, slide_generation
</verification>

<success_criteria>
- COST-01: Per-request cost visible after each chat message and embedding operation
- COST-02: Running session cost total visible in sidebar
- COST-03: Cost history and trends visible on dedicated costs page
- All 5 phase success criteria from ROADMAP.md are satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/05-cost-visibility/05-02-SUMMARY.md`
</output>
