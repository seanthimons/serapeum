---
phase: 04-startup-wizard-polish
plan: 02
type: execute
wave: 1
depends_on: []
files_modified: [R/slides.R]
autonomous: true

must_haves:
  truths:
    - "Quarto slide citations render at appropriate font size without overflowing slide boundaries"
    - "Citation styling is self-contained in each generated .qmd file (no external CSS files)"
  artifacts:
    - path: "R/slides.R"
      provides: "Citation CSS injection function and integration with slide generation"
      contains: "inject_citation_css"
  key_links:
    - from: "R/slides.R (inject_citation_css)"
      to: "QMD frontmatter"
      via: "CSS block inserted into revealjs format section"
      pattern: "footnotes.*font-size"
    - from: "R/slides.R (slide generation pipeline)"
      to: "inject_citation_css"
      via: "Function call after inject_theme_to_qmd"
      pattern: "inject_citation_css"
---

<objective>
Fix slide citation sizing so footnotes and references render at appropriate font size without overflowing slide boundaries.

Purpose: Currently LLM-generated slides produce citations that are too large and overflow the slide area (GitHub #51).
Output: Modified R/slides.R with CSS injection for citation styling.
</objective>

<execution_context>
@C:/Users/sxthi/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/sxthi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-startup-wizard-polish/04-RESEARCH.md
@R/slides.R
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add citation CSS injection to slide generation</name>
  <files>R/slides.R</files>
  <action>
Add a new function `inject_citation_css` to R/slides.R and wire it into the slide generation pipeline. Two changes:

**1. New function `inject_citation_css()` (place after `inject_theme_to_qmd` around line 131):**

```r
#' Inject citation CSS overrides into QMD frontmatter
#' @param qmd_content Raw QMD string
#' @return Modified QMD string with citation CSS
inject_citation_css <- function(qmd_content) {
  # CSS to constrain citation/footnote sizing in RevealJS slides
  citation_css <- paste0(
    "\n    css:\n",
    "      - |\n",
    "        .reveal .slides section .footnotes {\n",
    "          font-size: 0.5em !important;\n",
    "          line-height: 1.3;\n",
    "          max-height: 15vh;\n",
    "          overflow-y: auto;\n",
    "        }\n",
    "        .reveal .slides section .footnote-ref {\n",
    "          font-size: 0.7em;\n",
    "          vertical-align: super;\n",
    "        }\n",
    "        .reveal .slides section sup {\n",
    "          font-size: 0.6em;\n",
    "        }\n",
    "        .reveal .slides section .references {\n",
    "          font-size: 0.45em !important;\n",
    "          line-height: 1.2;\n",
    "        }\n"
  )

  # ... injection logic below
}
```

Use the same pattern as `inject_theme_to_qmd` with three cases:
- If `format:\n  revealjs:` exists (expanded format) — insert `citation_css` after `revealjs:` line (but after any existing theme line)
- If `format: revealjs` exists (simple format) — convert to expanded and add css block
- If no format section but frontmatter exists — add full `format:\n  revealjs:` section with css before closing `---`

Use `!important` on font-size rules and high specificity (`.reveal .slides section .footnotes`) to override RevealJS theme defaults (see research pitfall #3).

**2. Wire into slide generation pipeline:**

Find where `inject_theme_to_qmd` is called in the slide generation flow. Read the full file to locate the call site. Add `inject_citation_css()` call immediately after `inject_theme_to_qmd()`. The order matters: theme first, then CSS (so CSS block is placed correctly relative to theme).

If `inject_theme_to_qmd` is called like:
```r
qmd_content <- inject_theme_to_qmd(qmd_content, theme)
```
Add after it:
```r
qmd_content <- inject_citation_css(qmd_content)
```

**Key constraints:**
- Use `!important` on font-size rules — RevealJS themes apply high-specificity selectors that override normal CSS
- Target `.reveal .slides section .footnotes` (full specificity chain) not just `.footnotes`
- Include `.references` class too — some citation styles generate a references section instead of footnotes
- `max-height: 15vh` with `overflow-y: auto` prevents citations from pushing content off-slide
- CSS must be inline in YAML (pipe literal `- |`), NOT a separate .css file — keeps generated slides self-contained
  </action>
  <verify>
Run `"C:\Program Files\R\R-4.5.1\bin\Rscript.exe" -e "source('R/slides.R'); cat(inject_citation_css('---\ntitle: Test\nformat:\n  revealjs:\n    theme: moon\n---\n# Slide 1\n'))"` — output should show CSS block inserted under revealjs section. Also verify the function handles all three frontmatter cases (expanded format, simple format, no format).
  </verify>
  <done>
inject_citation_css function exists in R/slides.R, is called in the slide generation pipeline after theme injection, and produces valid QMD frontmatter with citation CSS. The CSS constrains footnotes to 0.5em, references to 0.45em, with max-height overflow protection.
  </done>
</task>

</tasks>

<verification>
- R/slides.R loads without errors: `source('R/slides.R')`
- inject_citation_css produces valid YAML when given expanded format input
- inject_citation_css produces valid YAML when given simple format input
- inject_citation_css produces valid YAML when given no-format input
- CSS uses !important and high specificity selectors
- Function is called in slide generation pipeline
</verification>

<success_criteria>
Generated Quarto slides include citation CSS that constrains footnote and reference font sizes to prevent overflow. CSS is self-contained in each .qmd file.
</success_criteria>

<output>
After completion, create `.planning/phases/04-startup-wizard-polish/04-02-SUMMARY.md`
</output>
