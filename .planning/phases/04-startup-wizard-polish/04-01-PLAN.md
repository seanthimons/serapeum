---
phase: 04-startup-wizard-polish
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [app.R]
autonomous: false

must_haves:
  truths:
    - "First-time users see a wizard modal offering three discovery paths"
    - "Each wizard path routes to the correct discovery module"
    - "Wizard can be skipped and skip preference persists across browser sessions"
    - "Returning users (who skipped or used wizard before) go directly to notebook list without wizard"
  artifacts:
    - path: "app.R"
      provides: "Wizard modal UI, localStorage JS, routing handlers"
      contains: "wizard_modal"
  key_links:
    - from: "app.R (wizard buttons)"
      to: "current_view() routing"
      via: "observeEvent handlers for wizard_seed_paper, wizard_query_builder, wizard_topic_explorer"
      pattern: "observeEvent\\(input\\$wizard_"
    - from: "app.R (localStorage JS)"
      to: "input$has_seen_wizard"
      via: "Shiny.setInputValue on shiny:connected"
      pattern: "serapeum_skip_wizard"
---

<objective>
Add a startup wizard modal that guides first-time users to one of three discovery paths (seed paper, query builder, topic explorer).

Purpose: New users currently see a static welcome screen with no guidance on which discovery mode to use. The wizard provides a clear entry point.
Output: Modified app.R with wizard modal, localStorage persistence, and routing logic.
</objective>

<execution_context>
@C:/Users/sxthi/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/sxthi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-startup-wizard-polish/04-RESEARCH.md
@app.R
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add wizard modal with localStorage persistence and routing</name>
  <files>app.R</files>
  <action>
Add the startup wizard to app.R with three parts:

**1. JavaScript for localStorage (in UI section, after the theme definition around line 28):**
Add a `tags$head(tags$script(HTML(...)))` block with:
- On `shiny:connected` event (NOT DOMContentLoaded — avoids race condition where Shiny.setInputValue is not ready):
  - Read `localStorage.getItem('serapeum_skip_wizard')`
  - Call `Shiny.setInputValue('has_seen_wizard', true/false, {priority: 'event'})`
- Register custom message handler `setWizardPreference` that calls `localStorage.setItem('serapeum_skip_wizard', 'true')`

**2. Wizard modal function (in server, before the routing observers around line 237):**
Create a `wizard_modal()` helper function returning `modalDialog(...)` with:
- Title: `tagList(icon("compass"), "Welcome to Serapeum")`
- Body: Centered intro text ("How would you like to start exploring research?") followed by `layout_columns(col_widths = c(4, 4, 4), ...)` with three action buttons:
  - `wizard_seed_paper`: icon("seedling"), "Start with a Paper", "Have a paper in mind? Find related work.", class = "btn-outline-success w-100 py-4"
  - `wizard_query_builder`: icon("wand-magic-sparkles"), "Build a Query", "Describe your research interest.", class = "btn-outline-info w-100 py-4"
  - `wizard_topic_explorer`: icon("compass"), "Browse Topics", "Explore research areas.", class = "btn-outline-warning w-100 py-4"
- Footer: `actionLink("skip_wizard", "Don't show this again", class = "text-muted")` and `modalButton("Close")`
- `size = "l"`, `easyClose = TRUE`

**3. Server logic (after wizard_modal function):**

Show wizard on first load:
```r
observe({
  has_seen <- input$has_seen_wizard
  if (!is.null(has_seen) && !has_seen) {
    shiny::onFlushed(function() {
      showModal(wizard_modal())
    }, once = TRUE)
  }
}) |> bindEvent(input$has_seen_wizard, once = TRUE)
```

Note: Use `bindEvent(input$has_seen_wizard, once = TRUE)` to wait for JS to report localStorage status. Use `onFlushed` to delay modal until modules are initialized (avoids pitfall where clicking a wizard button routes to a module that hasn't loaded yet).

Routing handlers (MUST removeModal() BEFORE setting current_view to avoid race condition):
```r
observeEvent(input$wizard_seed_paper, {
  removeModal()
  current_notebook(NULL)
  current_view("discover")
})
observeEvent(input$wizard_query_builder, {
  removeModal()
  current_notebook(NULL)
  current_view("query_builder")
})
observeEvent(input$wizard_topic_explorer, {
  removeModal()
  current_notebook(NULL)
  current_view("topic_explorer")
})
```

Skip handler (persists to localStorage AND closes modal):
```r
observeEvent(input$skip_wizard, {
  session$sendCustomMessage('setWizardPreference', TRUE)
  removeModal()
})
```

Also handle the "Close" modalButton — when user just clicks Close (not Skip), the wizard should reappear next time. No extra code needed since modalButton("Close") just closes without setting localStorage.

**Key constraints:**
- Do NOT modify the existing welcome screen card (lines 474-510). Wizard is a modal overlay, not a replacement.
- Do NOT modify existing sidebar button handlers (lines 237-253). Wizard adds new parallel handlers.
- Place JS in `tags$head()` so it loads before UI renders.
  </action>
  <verify>
Run the app: `"C:\Program Files\R\R-4.5.1\bin\Rscript.exe" -e "shiny::runApp('.', port=3838, launch.browser=FALSE)"` — app should start without errors. Verify in browser console that `localStorage.getItem('serapeum_skip_wizard')` is accessible and the wizard modal appears on first visit.
  </verify>
  <done>
First-time users see wizard modal with three discovery path buttons. Clicking any path button closes modal and routes to correct discovery module. "Don't show this again" persists to localStorage. Returning users with skip preference do not see wizard. Users who just close the modal see it again next session.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify wizard modal behavior</name>
  <files>app.R</files>
  <action>Human verification of wizard modal behavior across all scenarios.</action>
  <what-built>Startup wizard modal with three discovery paths and localStorage persistence</what-built>
  <how-to-verify>
1. Open http://localhost:3838 in a fresh browser (or clear localStorage first via DevTools > Application > Local Storage > delete serapeum_skip_wizard)
2. Wizard modal should appear with three buttons: "Start with a Paper", "Build a Query", "Browse Topics"
3. Click "Start with a Paper" — modal closes, seed discovery module appears
4. Reload page — wizard should appear again (you only navigated, didn't skip)
5. Click "Don't show this again" — modal closes
6. Reload page — wizard should NOT appear (localStorage persists)
7. In DevTools console, verify: `localStorage.getItem('serapeum_skip_wizard')` === "true"
8. Delete the localStorage key and reload — wizard should appear again
  </how-to-verify>
  <verify>Human confirms all 8 verification steps pass</verify>
  <done>Wizard modal works correctly for all user flows</done>
  <resume-signal>Type "approved" or describe issues</resume-signal>
</task>

</tasks>

<verification>
- App starts without errors
- Wizard modal appears for first-time users
- All three routing buttons work correctly
- Skip preference persists via localStorage
- Existing sidebar buttons still work
- Welcome screen still displays when no notebook selected
</verification>

<success_criteria>
First-time users see wizard with three discovery paths. Each path routes correctly. Skip preference persists across sessions. Returning users bypass wizard.
</success_criteria>

<output>
After completion, create `.planning/phases/04-startup-wizard-polish/04-01-SUMMARY.md`
</output>
