---
phase: 23-legacy-code-removal
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - R/_ragnar.R
  - R/db.R
  - R/rag.R
  - R/pdf.R
  - R/mod_document_notebook.R
  - R/mod_search_notebook.R
  - tests/testthat/test-ragnar.R
  - tests/testthat/test-embedding.R
  - .planning/ROADMAP.md
autonomous: true
must_haves:
  truths:
    - "Codebase search for 'ragnar_available' returns zero results in R files"
    - "Codebase search for 'cosine_similarity' returns zero results in R files"
    - "Codebase search for 'use_ragnar' returns zero results in R files"
    - "Codebase search for 'digest::digest' returns zero results in R files (replaced by rlang::hash)"
    - "Codebase search for 'get_embeddings' returns exactly 2 results: definition in api_openrouter.R and usage in _ragnar.R embed closure"
    - "No legacy fallback code paths remain — all RAG operations go through ragnar unconditionally"
  artifacts:
    - path: "R/_ragnar.R"
      provides: "Ragnar integration without ragnar_available() guards or check_ragnar_version()"
      contains: "rlang::hash"
    - path: "R/db.R"
      provides: "Database operations without cosine_similarity, parse_embedding, update_chunk_embedding, or search_chunks"
    - path: "R/rag.R"
      provides: "RAG query without use_ragnar parameter or legacy fallback"
    - path: "R/pdf.R"
      provides: "PDF processing without use_ragnar parameter or chunk_text() fallback"
    - path: "tests/testthat/test-ragnar.R"
      provides: "Unconditional ragnar tests without skip_if_not guards"
    - path: "tests/testthat/test-embedding.R"
      provides: "Embedding tests with legacy search_chunks tests removed"
  key_links:
    - from: "R/mod_document_notebook.R"
      to: "R/rag.R"
      via: "rag_query() call without use_ragnar argument"
      pattern: "rag_query\\(.*\\)(?!.*use_ragnar)"
    - from: "R/mod_search_notebook.R"
      to: "R/rag.R"
      via: "rag_query() call without use_ragnar argument"
      pattern: "rag_query\\(.*\\)(?!.*use_ragnar)"
    - from: "R/_ragnar.R"
      to: "R/api_openrouter.R"
      via: "get_embeddings() in embed_via_openrouter closure (KEPT)"
      pattern: "get_embeddings\\("
---

<objective>
Remove all legacy embedding and retrieval code paths, making ragnar the sole unconditional RAG backend. Replace digest::digest() with rlang::hash() and remove digest dependency.

Purpose: Eliminate dual-codepath complexity, dead helper functions, and conditional branches that are no longer needed now that ragnar is a hard dependency. This is the penultimate phase of the v3.0 Ragnar RAG Overhaul.

Output: Clean codebase with zero legacy RAG references, unconditional ragnar paths, and updated tests.
</objective>

<execution_context>
@C:/Users/sxthi/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/sxthi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/23-legacy-code-removal/23-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Remove all legacy code from production files and replace digest with rlang::hash</name>
  <files>
    R/_ragnar.R
    R/db.R
    R/rag.R
    R/pdf.R
    R/mod_document_notebook.R
    R/mod_search_notebook.R
  </files>
  <action>
Single-sweep removal across 6 production files. Read each file first, then apply all changes. This is a deletion-heavy task — most changes are removing code, not adding it.

**IMPORTANT: `get_embeddings()` in `api_openrouter.R` must NOT be deleted — it is still used by ragnar's embed pipeline in `_ragnar.R`.**

**R/_ragnar.R:**
- Delete `ragnar_available()` function definition entirely (lines ~139-142)
- Delete `check_ragnar_version()` function entirely (~lines 300-368, ~70 lines of dead code never called)
- Replace `digest::digest()` with `rlang::hash()` at the chunk hashing call (~line 920). The call is inside `insert_chunks_to_ragnar`. Change `digest::digest(paste0(...))` to `rlang::hash(paste0(...))`. Note: rlang is already installed as a transitive dependency.
- Remove `ragnar_available()` guards from these internal functions — keep only the non-ragnar condition (e.g., `nrow(chunks) == 0`):
  - `insert_chunks_to_ragnar`: `if (!ragnar_available() || nrow(chunks) == 0)` → `if (nrow(chunks) == 0)`
  - `retrieve_with_ragnar`: remove the guard, keep function body
  - `build_ragnar_index`: remove the guard, keep function body
  - `connect_ragnar_store`: remove the guard, keep function body
  - `get_ragnar_store`: remove the guard, keep function body
  - `chunk_with_ragnar`: remove the guard, keep function body

**R/db.R:**
- Delete `cosine_similarity()` function entirely (~lines 400-414)
- Delete `parse_embedding()` function entirely (~lines 419-454)
- Delete `update_chunk_embedding()` function entirely (~lines 390-394)
- Delete `search_chunks()` function entirely (~lines 462-521) — the legacy cosine-similarity search
- In `search_chunks_hybrid()`: remove the `ragnar_available()` guard from the condition (~line 847). Change `if (ragnar_available() && file.exists(ragnar_store_path))` to `if (file.exists(ragnar_store_path))`
- In `search_chunks_hybrid()`: remove the legacy fallback block (~lines 974-990). The function should return an empty data frame matching the ragnar-path schema when no store exists. The `if (file.exists(ragnar_store_path))` check already handles this — if store doesn't exist, let it fall through to return an empty data frame with the ragnar column schema (id, source_id, source_type, chunk_index, content, page_number, doc_name, abstract_title).
- Update `search_chunks_hybrid()` docstring: remove mention of "Falls back to legacy cosine similarity"

**R/rag.R:**
- Remove `use_ragnar` parameter from `rag_query()` function signature
- Delete the legacy fallback block that calls `get_embeddings()` then `search_chunks()` (~lines 93-121)
- The function body collapses to: call `search_chunks_hybrid()` unconditionally via tryCatch, check result, build context, generate response
- Update docstring: remove `use_ragnar` param doc and "Falls back to legacy" text
- Remove any stale comment about `ragnar_available()` at line 1 if present

**R/pdf.R:**
- Delete `chunk_text()` function entirely (~lines 30-58) — the legacy word-based chunker
- Remove `use_ragnar` parameter from `process_pdf()` function signature
- Remove the `if (use_ragnar && ragnar_available())` conditional block and its else branch
- The function body becomes: extract text, call `chunk_with_ragnar()` directly, add `section_hint` column, return result with `chunking_method = "ragnar"`
- Remove the `chunking_method = "word_based"` return path entirely
- Update docstring: remove `use_ragnar` param doc
- Remove any stale comment about `ragnar_available()` at line 1 if present

**R/mod_document_notebook.R:**
- Delete line 1 comment about `ragnar_available()` if present: `# Note: ragnar_available() is defined in R/_ragnar.R (sourced first alphabetically)`
- Remove `ragnar_available()` from the conditional guard at the upload handler (~line 524). Change `if (ragnar_available() && nrow(result$chunks) > 0 && ...)` to `if (nrow(result$chunks) > 0 && ...)`
- Delete `ragnar_indexed <- FALSE` declaration (~line 520)
- Delete `ragnar_indexed <- TRUE` assignment (~line 543)
- Delete the entire `if (!ragnar_indexed && ...) { ... }` legacy embedding block (~lines 557-594) with the `get_embeddings()` + `update_chunk_embedding()` batch loop
- Remove `use_ragnar = TRUE` from the `rag_query()` call site (~line 738)

**R/mod_search_notebook.R:**
- Delete line 1 comment about `ragnar_available()` if present: `# Note: ragnar_available() is defined in R/_ragnar.R (sourced first alphabetically)`
- Remove `ragnar_available()` from the conditional at the embed handler (~line 1984). Make ragnar indexing unconditional.
- Delete `ragnar_indexed <- FALSE` tracking variable
- Delete the entire `if (!ragnar_indexed) { ... }` legacy embedding fallback block (~lines 2047-2074) with the `get_embeddings()` loop
- Remove `use_ragnar = TRUE` from the `rag_query()` call site (~line 2264)
  </action>
  <verify>
Run these grep checks — all must return zero results:
```bash
grep -rn "ragnar_available" R/ --include="*.R"
grep -rn "cosine_similarity" R/ --include="*.R"
grep -rn "use_ragnar" R/ --include="*.R"
grep -rn "chunk_text" R/ --include="*.R"
grep -rn "check_ragnar_version" R/ --include="*.R"
grep -rn "update_chunk_embedding" R/ --include="*.R"
grep -rn "parse_embedding" R/ --include="*.R"
grep -rn "digest::digest" R/ --include="*.R"
```

These must return exactly 2 results (definition + ragnar embed closure):
```bash
grep -rn "get_embeddings" R/ --include="*.R"
```

This must return exactly 1 result (rlang::hash in _ragnar.R):
```bash
grep -rn "rlang::hash" R/ --include="*.R"
```
  </verify>
  <done>
All 6 production R files are cleaned: no ragnar_available() calls, no use_ragnar parameters, no legacy cosine similarity functions, no chunk_text(), no check_ragnar_version(), digest::digest replaced with rlang::hash. get_embeddings() retained only in api_openrouter.R definition and _ragnar.R embed closure.
  </done>
</task>

<task type="auto">
  <name>Task 2: Clean up test files and amend ROADMAP success criteria</name>
  <files>
    tests/testthat/test-ragnar.R
    tests/testthat/test-embedding.R
    .planning/ROADMAP.md
  </files>
  <action>
**tests/testthat/test-ragnar.R:**
- Delete the test `"ragnar_available returns boolean"` — function no longer exists
- Delete the test `"process_pdf falls back to word-based chunking without ragnar"` — exercises `use_ragnar = FALSE` which is removed
- For remaining tests, remove all `skip_if_not(ragnar_available(), ...)` guards — ragnar is required, these are unconditional now:
  - `"chunk_with_ragnar returns expected structure when ragnar available"` — remove skip guard
  - `"process_pdf uses ragnar when available"` — remove skip guard, remove `use_ragnar = TRUE` argument from `process_pdf()` call
  - `"search_chunks_hybrid returns expected structure"` — remove skip guard
  - `"get_ragnar_store requires API key for new stores"` — remove skip guard
  - `"connect_ragnar_store returns NULL for non-existent store"` — remove skip guard

**tests/testthat/test-embedding.R:**
- Delete test `"search_chunks finds abstract chunks by notebook"` (~lines 54-103) — exercises deleted `search_chunks()` function
- Delete test `"search_chunks filters abstracts by notebook"` (~lines 106-153) — exercises deleted `search_chunks()` function
- Keep these tests (pure DB/formatting, no legacy code):
  - `"abstract chunks are created with correct source_type"` (~lines 15-52)
  - `"build_context formats abstract citations correctly"` (~lines 155-173)
  - `"build_context handles mixed document and abstract sources"` (~lines 175-191)

**ROADMAP.md amendments:**
- Update Phase 23 description line: change "Remove ragnar_available conditionals, cosine similarity fallback, digest dependency" to "Remove ragnar_available conditionals, cosine similarity fallback, replace digest with rlang::hash"
- Update success criteria #3: change "Digest package is removed from dependencies and no code references digest::digest()" to "digest::digest() replaced by rlang::hash() for chunk hashing; no legacy digest usage remains"
- Update success criteria #4: change "Codebase search for \"ragnar_available\", \"cosine\", \"get_embeddings\" returns zero results in R files" to "Codebase search for \"ragnar_available\", \"cosine_similarity\", \"use_ragnar\" returns zero results in R files; get_embeddings has exactly 2 results (definition + ragnar embed closure)"
  </action>
  <verify>
Run test files to confirm no syntax errors:
```bash
"C:\Program Files\R\R-4.5.1\bin\Rscript.exe" -e "testthat::test_file('tests/testthat/test-ragnar.R')"
"C:\Program Files\R\R-4.5.1\bin\Rscript.exe" -e "testthat::test_file('tests/testthat/test-embedding.R')"
```

Verify ROADMAP.md has updated Phase 23 success criteria — grep for "rlang::hash" in ROADMAP.md.

Verify no references to deleted functions in test files:
```bash
grep -rn "ragnar_available\|search_chunks[^_]\|use_ragnar\|chunk_text" tests/ --include="*.R"
```
  </verify>
  <done>
Test files cleaned: legacy tests deleted, skip guards removed, use_ragnar arguments removed. ROADMAP success criteria amended to reflect digest→rlang::hash replacement and corrected grep targets. All remaining tests pass without syntax errors.
  </done>
</task>

</tasks>

<verification>
After both tasks complete, run the full verification protocol:

1. **Zero-result grep checks** (all must return 0 matches in R/ and tests/):
   - `ragnar_available`
   - `cosine_similarity`
   - `use_ragnar`
   - `chunk_text` (as standalone function)
   - `check_ragnar_version`
   - `update_chunk_embedding`
   - `parse_embedding`
   - `digest::digest`

2. **Exact-count grep checks**:
   - `get_embeddings` in R/ → exactly 2 results
   - `rlang::hash` in R/ → exactly 1 result
   - `search_chunks` (without `_hybrid`) in R/ → 0 results

3. **App launch test**: Start the app and verify no startup errors
</verification>

<success_criteria>
- All legacy dual-codepath code removed from 6 production files
- digest::digest() replaced with rlang::hash() in _ragnar.R
- ragnar_available() function definition deleted
- All use_ragnar parameters removed from function signatures
- Legacy tests deleted, skip guards removed from remaining tests
- ROADMAP success criteria amended
- All grep verification checks pass
- Single commit for entire sweep
</success_criteria>

<output>
After completion, create `.planning/phases/23-legacy-code-removal/23-01-SUMMARY.md`
</output>
