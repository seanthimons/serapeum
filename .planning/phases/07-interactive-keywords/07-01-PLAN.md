---
phase: 07-interactive-keywords
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - R/mod_keyword_filter.R
  - R/mod_search_notebook.R
autonomous: true

must_haves:
  truths:
    - "User can click a keyword tag to include it as a search filter"
    - "User can click a keyword tag to exclude it from results"
    - "User sees visual distinction (color/icon) for included, excluded, and neutral tags"
    - "User can filter currently displayed results by keyword tags in real-time"
    - "User can clear keyword filters to return to original results"
  artifacts:
    - path: "R/mod_keyword_filter.R"
      provides: "Keyword filter Shiny module with tri-state tag UI and filtering logic"
      exports: ["mod_keyword_filter_ui", "mod_keyword_filter_server"]
      min_lines: 80
    - path: "R/mod_search_notebook.R"
      provides: "Updated search notebook integrating keyword filter module"
      contains: "mod_keyword_filter"
  key_links:
    - from: "R/mod_keyword_filter.R"
      to: "R/mod_search_notebook.R"
      via: "Shiny module embedding - UI slot and server return value"
      pattern: "mod_keyword_filter_(ui|server)"
    - from: "R/mod_keyword_filter.R"
      to: "papers_data reactive"
      via: "Input reactive providing paper data with keywords column"
      pattern: "papers_data"
    - from: "R/mod_search_notebook.R"
      to: "keyword_filtered_papers"
      via: "Server return from keyword filter module replaces filtered_papers in downstream chain"
      pattern: "keyword_filtered"
---

<objective>
Create an interactive keyword filtering module for search notebooks. Users click keyword tags to cycle through neutral (grey) -> include (green) -> exclude (red) states. Filtered results update in real-time without re-running the search. A "Clear filters" button resets all tags to neutral.

Purpose: Transforms the currently destructive keyword interaction (clicking deletes papers) into a non-destructive, reversible filtering system that lets researchers quickly narrow search results by topic.

Output: New R/mod_keyword_filter.R module + updated R/mod_search_notebook.R integration
</objective>

<execution_context>
@C:/Users/sxthi/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/sxthi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/codebase/CONVENTIONS.md
@R/mod_search_notebook.R
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create mod_keyword_filter.R module</name>
  <files>R/mod_keyword_filter.R</files>
  <action>
Create a new Shiny module `R/mod_keyword_filter.R` following the project's module conventions (roxygen2 docs, snake_case, moduleServer pattern).

**UI function: `mod_keyword_filter_ui(id)`**
- Returns a `div` containing:
  - A summary line: "{N} papers | {M} keywords" (text-muted small)
  - A flex-wrap container of keyword badge `actionLink` elements (rendered via `uiOutput`)
  - A "Clear filters" `actionLink` (only visible when any filter is active)
  - An active filter summary showing included/excluded counts

**Server function: `mod_keyword_filter_server(id, papers_data)`**
- Parameters:
  - `id` - module ID
  - `papers_data` - reactive returning a data.frame with a `keywords` column (JSON-encoded character vectors)
- Internal state:
  - `keyword_states` - a `reactiveValues` list mapping keyword strings to state: "neutral", "include", or "exclude"
  - When `papers_data()` changes (new search results), reset all keyword states to "neutral"
- Keyword aggregation:
  - Parse keywords from `papers_data()$keywords` column using `jsonlite::fromJSON()` (same pattern as existing code at line 388-406 of mod_search_notebook.R)
  - Count occurrences, sort descending, limit to top 30
- Click handling:
  - Each keyword badge is an `actionLink` with ID `ns(paste0("kw_", sanitized_keyword))`
  - On click, cycle state: neutral -> include -> exclude -> neutral
  - Use `observe()` with `lapply()` to set up click handlers for each keyword (same pattern as existing lines 560-578)
- Badge rendering:
  - Neutral: `badge bg-secondary` (grey) - no icon
  - Include: `badge bg-success` (green) - plus icon prefix: `icon("plus", class = "me-1")`
  - Exclude: `badge bg-danger` (red) - minus icon prefix: `icon("minus", class = "me-1")`
  - All badges show: `{keyword} ({count})` with `cursor: pointer` style
- Filtering logic (the key reactive):
  - `filtered_papers` reactive that takes `papers_data()` and applies keyword filters:
    - If ANY keywords are set to "include": paper must have AT LEAST ONE included keyword
    - If ANY keywords are set to "exclude": paper must NOT have ANY excluded keyword
    - Both filters apply simultaneously (AND logic)
    - Parse each paper's keywords with `jsonlite::fromJSON()`, check against include/exclude sets
  - Return the filtered data.frame
- Clear filters:
  - `observeEvent` on clear link resets all entries in `keyword_states` to "neutral"
- **Return value**: Return `reactive(filtered_papers())` from the server function so the parent module can use it

Important: Do NOT use `observeEvent` with dynamically created input IDs in a `renderUI` context without proper invalidation handling. Use `observe()` with `lapply()` and track which observers are active to avoid duplicates (use the `once = TRUE` pattern or track in a reactiveValues as the existing code does).
  </action>
  <verify>
File exists at R/mod_keyword_filter.R. Contains mod_keyword_filter_ui and mod_keyword_filter_server functions. Has roxygen2 documentation. Follows project conventions (snake_case, 2-space indent, double quotes).
  </verify>
  <done>
mod_keyword_filter.R exists with UI rendering tri-state keyword badges (grey/green/red), click cycling through states, filtering logic (include AND exclude), clear button, and returns filtered papers reactive.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate keyword filter into search notebook</name>
  <files>R/mod_search_notebook.R</files>
  <action>
Modify `R/mod_search_notebook.R` to replace the existing keyword panel with the new module. This task REMOVES code (net reduction in lines). Do NOT add new features to this file.

**UI changes (mod_search_notebook_ui):**
- Replace the keyword card content (lines 77-87) with the keyword filter module UI:
  - Keep the `card()` wrapper and `card_header("Keywords")`
  - Replace `card_body` content: swap `uiOutput(ns("keyword_panel"))` with `mod_keyword_filter_ui(ns("keyword_filter"))`
  - Keep `card_footer` with embed_button and exclusion_info (these are unrelated to keyword filtering)

**Server changes (mod_search_notebook_server):**

1. **Remove old keyword code** (this is the main win - removing ~100 lines):
   - Remove `all_keywords` reactive (lines 382-407)
   - Remove `output$keyword_panel` renderUI (lines 434-468)
   - Remove `keyword_observers` reactiveValues (line 550)
   - Remove keyword click observer block (lines 553-578)
   - Remove keyword delete confirmation handler (lines 582-637) - the entire "delete papers by keyword" behavior is being replaced with non-destructive filtering

2. **Add keyword filter module server call** (near the top of the server function, after `paper_refresh` setup around line 176):
   ```r
   # Keyword filter module - returns filtered papers reactive
   keyword_filtered_papers <- mod_keyword_filter_server("keyword_filter", papers_data)
   ```

3. **Update the `filtered_papers` reactive** (currently lines 317-325):
   - Chain keyword filtering AFTER the existing has_abstract filter:
   ```r
   filtered_papers <- reactive({
     papers <- keyword_filtered_papers()
     if (nrow(papers) == 0) return(papers)
     if (isTRUE(input$filter_has_abstract)) {
       papers <- papers[!is.na(papers$abstract) & nchar(papers$abstract) > 0, ]
     }
     papers
   })
   ```
   Note: `keyword_filtered_papers()` already starts from `papers_data()`, so the chain is: papers_data -> keyword_filter -> has_abstract_filter -> filtered_papers. This preserves the existing downstream consumers (papers_with_quality, paper_list, embed check, etc.) unchanged.

4. **Update `papers_need_embedding`** (lines 410-432): This already uses `filtered_papers()` so it will automatically reflect keyword filtering. No change needed.

5. **Verify no broken references**: After removing the old keyword code, grep for any remaining references to `all_keywords`, `keyword_observers`, `confirm_delete_keyword`, or `keyword_panel` and remove/update them.

The net effect should be roughly -100 lines removed, +3 lines added (module call + updated reactive). The file should shrink from ~1,760 to ~1,660 lines.
  </action>
  <verify>
Run the Shiny app with `"C:\Program Files\R\R-4.5.1\bin\Rscript.exe" -e "shiny::runApp('app.R', port=3838)"` and confirm it starts without errors. Verify no R parse errors: `"C:\Program Files\R\R-4.5.1\bin\Rscript.exe" -e "parse('R/mod_keyword_filter.R'); parse('R/mod_search_notebook.R'); cat('OK')"`.
  </verify>
  <done>
Search notebook integrates keyword filter module. Old destructive keyword-delete code removed (~100 lines). filtered_papers chain updated to flow through keyword filter. App starts without errors.
  </done>
</task>

</tasks>

<verification>
1. Parse check: Both R/mod_keyword_filter.R and R/mod_search_notebook.R parse without errors
2. App startup: Shiny app launches without errors on port 3838
3. Keyword badges render in the Keywords card with grey (neutral) styling
4. Clicking a keyword badge cycles: grey -> green (include) -> red (exclude) -> grey
5. When keywords are included (green), only papers with at least one included keyword appear in the paper list
6. When keywords are excluded (red), papers with any excluded keyword are hidden from the paper list
7. "Clear filters" link appears when any filter is active; clicking it resets all to neutral and shows all papers
8. Existing features still work: sort, has_abstract filter, paper selection, embed, chat, exclusions
</verification>

<success_criteria>
- KWRD-01: Clicking a keyword tag sets it to "include" (green badge with plus icon), filtering results to show papers with that keyword
- KWRD-02: Clicking an included keyword cycles to "exclude" (red badge with minus icon), hiding papers with that keyword
- KWRD-03: Three visual states clearly distinguishable: grey/neutral, green+plus/include, red+minus/exclude
- KWRD-04: Paper list updates immediately when keyword state changes, no page reload or search re-run needed
- Bonus: Clear filters button returns to full unfiltered view
- mod_search_notebook.R is SHORTER than before (net code removal)
</success_criteria>

<output>
After completion, create `.planning/phases/07-interactive-keywords/07-01-SUMMARY.md`
</output>
