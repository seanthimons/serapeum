---
phase: 08-journal-quality-controls
plan: 02
type: execute
wave: 2
depends_on: ["08-01"]
files_modified:
  - R/mod_search_notebook.R
autonomous: false

must_haves:
  truths:
    - "Search results display predatory/blocked journal warnings with visual badges"
    - "User can toggle predatory journal filter on/off (default off, showing all with warnings)"
    - "User can block a journal from the paper detail view"
    - "User can view their blocklist and remove journals from it"
    - "Blocklist persists across sessions in local DuckDB database"
  artifacts:
    - path: "R/mod_search_notebook.R"
      provides: "Integrated journal quality controls in search notebook"
      contains: "mod_journal_filter"
  key_links:
    - from: "R/mod_search_notebook.R"
      to: "R/mod_journal_filter.R"
      via: "mod_journal_filter_server call and filtered_papers chain"
      pattern: "mod_journal_filter_server"
    - from: "R/mod_search_notebook.R"
      to: "R/db.R"
      via: "list_blocked_journals for blocklist modal, remove_blocked_journal for unblock"
      pattern: "list_blocked_journals|remove_blocked_journal"
---

<objective>
Integrate the journal quality filter module into the search notebook and add blocklist management UI.

Purpose: Wire the journal filter module into the search notebook's reactive chain (between keyword filter and display), add "Block journal" action to paper detail view, and add a blocklist management modal. This completes all four JRNL requirements.

Output: Updated mod_search_notebook.R with full journal quality controls
</objective>

<execution_context>
@C:/Users/sxthi/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/sxthi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-journal-quality-controls/08-01-SUMMARY.md
@R/mod_search_notebook.R
@R/mod_journal_filter.R
@R/mod_keyword_filter.R
@R/db.R
</context>

<tasks>

<task type="auto">
  <name>Task 1: Integrate journal filter module and add blocklist management</name>
  <files>R/mod_search_notebook.R</files>
  <action>
Modify `R/mod_search_notebook.R` to integrate the journal filter module and add blocklist management. This involves four areas of changes:

**1. UI changes - Add journal filter section:**
In `mod_search_notebook_ui`, add the journal filter UI in the right column alongside the keyword filter card. Add it BELOW the keyword filter card, ABOVE the abstract detail card:
```r
# Journal quality filter panel
card(
  card_header(
    class = "d-flex justify-content-between align-items-center",
    span(icon("shield-halved"), " Journal Quality"),
    actionLink(ns("manage_blocklist"), icon("list"), class = "text-muted", title = "Manage blocklist")
  ),
  card_body(
    mod_journal_filter_ui(ns("journal_filter"))
  )
)
```

**2. Server changes - Wire module into reactive chain:**
In `mod_search_notebook_server`:

a) Initialize the journal filter module AFTER the keyword filter module (around line 178):
```r
journal_filter_result <- mod_journal_filter_server("journal_filter", keyword_filtered_papers, con)
journal_filtered_papers <- journal_filter_result$filtered_papers
```

b) Update the `filtered_papers` reactive (around line 320-328) to chain through journal filter:
Change `papers <- keyword_filtered_papers()` to `papers <- journal_filtered_papers()`
The chain becomes: papers_data -> keyword_filter -> journal_filter -> has_abstract -> filtered_papers

c) REMOVE the old `papers_with_quality` reactive (lines ~331-383). The journal filter module now handles quality annotation. Update any references to `papers_with_quality()` - the paper_list rendering (around line 530) should use `filtered_papers()` instead. Check: the paper_list output currently uses `papers_with_quality()` - change to `filtered_papers()`. The filtered_papers from journal_filter already has is_predatory, is_blocked, is_flagged, quality_flag_text columns.

d) Update paper_list rendering (around line 540) to use quality columns from the journal-annotated data:
- The `is_flagged` check at line 565 should use the column from filtered_papers (now provided by journal filter module)
- The `quality_flags` at line 566 should use `quality_flag_text` column instead
- Update the warning icon section (lines 589-595) to show the flag text from quality_flag_text column

**3. Add "Block this journal" action to abstract detail view:**
In the `output$abstract_detail` renderUI (around line 688), add a "Block journal" button when the paper has a venue:
- After the venue badge display (around line 778), add:
```r
if (!is.na(paper$venue) && nchar(paper$venue) > 0) {
  actionLink(
    ns(paste0("block_journal_", paper$id)),
    span(class = "badge bg-outline-danger small", icon("ban"), " Block journal"),
    title = paste("Block all papers from", paper$venue)
  )
}
```
- Add observer for block_journal clicks:
```r
observe({
  papers <- filtered_papers()
  if (nrow(papers) == 0) return()
  lapply(papers$id, function(paper_id) {
    observeEvent(input[[paste0("block_journal_", paper_id)]], {
      paper <- papers[papers$id == paper_id, ]
      if (nrow(paper) > 0 && !is.na(paper$venue) && nchar(paper$venue) > 0) {
        journal_filter_result$block_journal(paper$venue)
        showNotification(
          paste("Blocked:", paper$venue),
          type = "message", duration = 3
        )
      }
    }, ignoreInit = TRUE)
  })
})
```

**4. Add blocklist management modal:**
Add observer for `input$manage_blocklist` that shows a modal:
```r
observeEvent(input$manage_blocklist, {
  blocked <- list_blocked_journals(con())

  if (nrow(blocked) == 0) {
    body_content <- div(
      class = "text-center text-muted py-4",
      icon("check-circle", class = "fa-2x mb-2"),
      p("No journals blocked yet."),
      p(class = "small", "You can block journals from the paper detail view.")
    )
  } else {
    body_content <- div(
      style = "max-height: 400px; overflow-y: auto;",
      lapply(seq_len(nrow(blocked)), function(i) {
        j <- blocked[i, ]
        div(
          class = "d-flex justify-content-between align-items-center border-bottom py-2",
          div(
            span(class = "fw-semibold", j$journal_name),
            div(class = "text-muted small", paste("Blocked:", format(as.POSIXct(j$added_at), "%Y-%m-%d")))
          ),
          actionButton(
            ns(paste0("unblock_", j$id)),
            icon("trash"),
            class = "btn-sm btn-outline-danger",
            title = "Remove from blocklist"
          )
        )
      })
    )
  }

  showModal(modalDialog(
    title = span(icon("shield-halved"), " Blocked Journals"),
    body_content,
    size = "m",
    easyClose = TRUE,
    footer = modalButton("Close")
  ))
})
```

Add observers for unblock buttons:
```r
observe({
  blocked <- tryCatch(list_blocked_journals(con()), error = function(e) data.frame())
  if (nrow(blocked) == 0) return()

  lapply(blocked$id, function(block_id) {
    observeEvent(input[[paste0("unblock_", block_id)]], {
      remove_blocked_journal(con(), block_id)
      showNotification("Journal unblocked", type = "message", duration = 3)
      removeModal()
      # Trigger blocklist refresh in the journal filter module
      journal_filter_result$block_journal(NULL)  # NULL signals refresh without adding
    }, ignoreInit = TRUE)
  })
})
```
Note: The block_journal function should handle NULL gracefully (just refresh, don't add). Update mod_journal_filter.R if needed to support this - if journal_name is NULL or empty, just increment the refresh trigger without calling add_blocked_journal.

**5. Remove redundant quality code:**
- Remove the old `papers_with_quality` reactive (lines ~331-383) entirely
- The journal filter module's toggle checkbox replaces the need for the edit modal's flag_predatory checkbox. Remove the edit_flag_predatory checkbox from the edit modal (line ~955) since the journal filter card provides this control directly and more accessibly. Keep the quality cache status and refresh link in the edit modal (lines 1075-1136) since that's about data freshness, not filtering.
  </action>
  <verify>
Run: `"C:\Program Files\R\R-4.5.1\bin\Rscript.exe" -e "parse('R/mod_search_notebook.R'); parse('R/mod_journal_filter.R'); cat('All OK')"`
Verify mod_journal_filter_server is called in the server function.
Verify filtered_papers reactive chains through journal filter.
Verify manage_blocklist observer exists.
  </verify>
  <done>
mod_search_notebook.R integrates journal filter module. Reactive chain: papers_data -> keyword_filter -> journal_filter -> has_abstract -> filtered_papers. Paper detail view has "Block journal" action. Blocklist modal shows blocked journals with unblock buttons. Old papers_with_quality reactive removed. All R files parse without errors.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify journal quality controls end-to-end</name>
  <files>R/mod_search_notebook.R, R/mod_journal_filter.R</files>
  <action>
Human verification of the complete journal quality controls system: predatory journal warning badges, filter toggle, block journal action, and blocklist management modal.
  </action>
  <verify>
1. Start the app: `"C:\Program Files\R\R-4.5.1\bin\Rscript.exe" -e "shiny::runApp()"`
2. Open a search notebook with results
3. Verify the "Journal Quality" card appears below the Keywords card
4. If quality data is cached (check Settings > Quality Data):
   a. Verify papers from predatory journals show warning icon (triangle-exclamation)
   b. Verify the filter toggle "Hide flagged journals" is OFF by default
   c. Toggle it ON - flagged papers should disappear from the list
   d. Toggle it OFF - flagged papers reappear with warnings
5. Click on a paper with a venue/journal name
6. In the abstract detail view, verify "Block journal" link appears next to the venue
7. Click "Block journal" - verify notification appears
8. Verify the blocked journal's papers now show as flagged
9. Click the list icon in the Journal Quality card header to open blocklist
10. Verify the blocked journal appears in the modal
11. Click the trash icon to unblock - verify journal is removed
12. Verify papers from that journal are no longer flagged (unless predatory)
13. Close and reopen the app - verify blocklist persists
  </verify>
  <done>
All JRNL requirements verified: JRNL-01 (warning badges), JRNL-02 (filter toggle, default off), JRNL-03 (block journal), JRNL-04 (view/remove from blocklist). Blocklist persists across sessions.
  </done>
</task>

</tasks>

<verification>
1. All R files parse: `"C:\Program Files\R\R-4.5.1\bin\Rscript.exe" -e "parse('R/db.R'); parse('R/mod_journal_filter.R'); parse('R/mod_search_notebook.R'); cat('All OK')"`
2. JRNL-01: Papers from predatory journals show warning badges
3. JRNL-02: Toggle hides/shows predatory papers (default: off = show all with warnings)
4. JRNL-03: "Block journal" in paper detail adds journal to personal blocklist
5. JRNL-04: Blocklist modal shows blocked journals with remove capability
6. Blocklist persists across sessions (stored in DuckDB via migration 004)
</verification>

<success_criteria>
- Journal filter module wired into search notebook reactive chain
- Warning badges visible on papers from predatory/blocked journals
- Filter toggle (default OFF) hides flagged papers when enabled
- Block journal action available in paper detail view
- Blocklist management modal with view/remove functionality
- Blocklist persists in DuckDB across app restarts
- No regression in existing features (keyword filter, sort, embed, chat)
</success_criteria>

<output>
After completion, create `.planning/phases/08-journal-quality-controls/08-02-SUMMARY.md`
</output>
