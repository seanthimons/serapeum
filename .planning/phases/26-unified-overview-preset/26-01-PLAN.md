---
phase: 26-unified-overview-preset
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - R/rag.R
autonomous: true

must_haves:
  truths:
    - "generate_overview_preset() returns a markdown string with ## Summary and ## Key Points sections"
    - "Quick mode produces a single LLM call; Thorough mode produces two separate LLM calls merged into one output"
    - "Concise depth instructs 1-2 paragraphs; Detailed depth instructs 3-4 paragraphs"
    - "Large notebooks (>20 papers or >300k chars) are batched into groups with results concatenated"
    - "Cost is logged per LLM call with category 'overview' (Quick) or 'overview_summary'/'overview_keypoints' (Thorough)"
  artifacts:
    - path: "R/rag.R"
      provides: "generate_overview_preset() function"
      contains: "generate_overview_preset"
  key_links:
    - from: "R/rag.R"
      to: "api_openrouter.R"
      via: "chat_completion() call"
      pattern: "chat_completion\\("
    - from: "R/rag.R"
      to: "db.R"
      via: "dbGetQuery for full-corpus retrieval"
      pattern: "dbGetQuery\\("
---

<objective>
Add the `generate_overview_preset()` function to R/rag.R â€” the backend engine for the unified Overview preset.

Purpose: Provides the core LLM synthesis logic that combines Summary + Key Points into a single output. Supports Concise/Detailed depth, Quick/Thorough mode, and automatic batching for large notebooks.

Output: `generate_overview_preset()` function in R/rag.R, callable from both notebook modules.
</objective>

<execution_context>
@C:/Users/sxthi/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/sxthi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/26-unified-overview-preset/26-RESEARCH.md
@R/rag.R
@R/api_openrouter.R
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add generate_overview_preset() to R/rag.R</name>
  <files>R/rag.R</files>
  <action>
Add `generate_overview_preset()` function after the existing `generate_conclusions_preset()` function in R/rag.R. Follow the pattern established by `generate_conclusions_preset()` for API key extraction, model selection, and cost logging.

**Function signature:**
```r
generate_overview_preset <- function(con, config, notebook_id,
                                     notebook_type = "document",
                                     depth = "concise",
                                     mode = "quick",
                                     session_id = NULL)
```

**Data retrieval (full corpus, NOT RAG top-k):**
- For `notebook_type == "document"`: query chunks joined to documents, ordered by `d.created_at, c.chunk_index`, NO LIMIT
- For `notebook_type == "search"`: query abstracts table directly (title, abstract, year), filter `abstract IS NOT NULL AND LENGTH(abstract) > 0`, ordered by `year DESC`, NO LIMIT

**Batching logic:**
- `BATCH_SIZE`: 10 for document notebooks, 20 for search notebooks
- `CHAR_LIMIT`: 300000
- Use batching when `total_chars > CHAR_LIMIT` OR `nrow(content_df) > BATCH_SIZE * 2`
- Batch using `split(seq_len(nrow(df)), ceiling(seq_len(nrow(df)) / BATCH_SIZE))`
- Concatenate batch results with `"\n\n---\n\n"` separator
- Add `# TODO (future): if batch divergence causes inconsistency, add merge-pass LLM call` comment

**Quick mode (single LLM call):**
- System prompt instructs two-section output: `## Summary` then `## Key Points`
- Summary depth instruction varies: "Write a summary of 1-2 paragraphs" (concise) vs "Write a detailed summary of 3-4 paragraphs" (detailed)
- Key Points must be organized under thematic subheadings (Methodology, Findings, Limitations, Future Directions), not a flat list
- Each subheading: 3-5 bullet points
- Emphasize: "Base all content ONLY on the provided sources. Do not invent findings."
- Log cost with category `"overview"`

**Thorough mode (two separate LLM calls):**
- Call 1: Summary-only prompt. System: "You are a research summarizer." User: sources + depth instruction. Log cost with category `"overview_summary"`.
- Call 2: Key Points-only prompt. System: "You are a research analyst." User: sources + thematic subheading instruction. Log cost with category `"overview_keypoints"`.
- Merge: `paste0("## Summary\n\n", call1_result, "\n\n## Key Points\n\n", call2_result)`
- If batching is also active, each call batches independently (summary batches concatenated, key points batches concatenated, then the two sections combined)

**Source formatting (for user prompt):**
- For search notebooks: format each paper as `[N] Title (Year)\nAbstract: ...`
- For document notebooks: format each chunk as `[Source: filename, Page N]\nContent: ...`
- Wrap in `===== BEGIN SOURCES =====` / `===== END SOURCES =====` delimiters

**Cost logging:**
- Follow `generate_conclusions_preset()` pattern: call `estimate_cost()` then `log_cost()` after each `chat_completion()` call
- Use `"overview"` category for Quick mode, `"overview_summary"` and `"overview_keypoints"` for Thorough mode's two calls

**Error handling:**
- Return early with user-friendly message if no API key, no content found, or API error
- Wrap each `chat_completion()` call in `tryCatch()`
  </action>
  <verify>
1. `grep -c "generate_overview_preset" R/rag.R` returns at least 2 (function def + roxygen)
2. `grep -c "chat_completion" R/rag.R` increases by at least 2 (Quick call + Thorough calls)
3. `grep -c "BATCH_SIZE" R/rag.R` returns at least 1
4. `grep "overview_summary\|overview_keypoints\|\"overview\"" R/rag.R` shows all three cost categories
5. Run `"C:\Program Files\R\R-4.5.1\bin\Rscript.exe" -e "source('R/rag.R'); args(generate_overview_preset)"` confirms the function loads without syntax errors (may fail on missing dependencies but no parse errors)
  </verify>
  <done>
`generate_overview_preset()` exists in R/rag.R with: full-corpus SQL retrieval (no LIMIT), batching for large notebooks, Quick mode (single call) and Thorough mode (two calls), proper cost logging with distinct categories, and source formatting with delimiters.
  </done>
</task>

</tasks>

<verification>
- `generate_overview_preset()` function exists and parses without error
- Function accepts all required parameters: con, config, notebook_id, notebook_type, depth, mode, session_id
- Quick mode uses a single `chat_completion()` call
- Thorough mode uses two `chat_completion()` calls and merges results
- Batching splits content when threshold exceeded
- Cost logged with correct categories
</verification>

<success_criteria>
`generate_overview_preset()` is a fully implemented function in R/rag.R that can be called from notebook module handlers in Plan 02. It retrieves all content from the notebook (not top-k), supports Concise/Detailed depth and Quick/Thorough mode, batches large notebooks, and logs costs.
</success_criteria>

<output>
After completion, create `.planning/phases/26-unified-overview-preset/26-01-SUMMARY.md`
</output>
