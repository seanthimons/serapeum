---
phase: 26-unified-overview-preset
plan: 02
type: execute
wave: 2
depends_on: ["26-01"]
files_modified:
  - R/mod_document_notebook.R
  - R/mod_search_notebook.R
autonomous: true

must_haves:
  truths:
    - "User sees an Overview button in the document notebook preset panel (replacing Summarize and Key Points)"
    - "User sees an Overview button in the search notebook offcanvas chat preset row (alongside Conclusions)"
    - "User clicks Overview, sees a popover with Depth (Concise/Detailed) and Quality (Quick/Thorough) radio options plus a Generate button"
    - "User clicks Generate and receives a combined Summary + Key Points response in the chat panel"
    - "Overview output displays the AI-generated content disclaimer banner"
    - "Popover resets to defaults (Concise + Quick) each time it opens"
  artifacts:
    - path: "R/mod_document_notebook.R"
      provides: "Overview popover button replacing Summarize + Key Points"
      contains: "btn_overview"
    - path: "R/mod_search_notebook.R"
      provides: "Overview popover button in offcanvas preset row"
      contains: "btn_overview"
  key_links:
    - from: "R/mod_document_notebook.R"
      to: "R/rag.R"
      via: "generate_overview_preset() call in btn_overview_generate handler"
      pattern: "generate_overview_preset\\("
    - from: "R/mod_search_notebook.R"
      to: "R/rag.R"
      via: "generate_overview_preset() call in btn_overview_generate handler"
      pattern: "generate_overview_preset\\("
    - from: "R/mod_document_notebook.R"
      to: "is_synthesis check"
      via: "preset_type 'overview' triggers AI disclaimer banner"
      pattern: "overview"
    - from: "R/mod_search_notebook.R"
      to: "is_synthesis check"
      via: "preset_type 'overview' triggers AI disclaimer banner"
      pattern: "overview"
---

<objective>
Wire the Overview button into both notebook modules — replacing Summarize + Key Points buttons with a popover-equipped Overview button, adding server handlers, and updating the AI disclaimer check.

Purpose: Users interact with the Overview feature through both the document notebook and search notebook UIs. This plan connects the UI to the backend from Plan 01.

Output: Working Overview button in both modules with popover options, server handlers calling `generate_overview_preset()`, and AI disclaimer on output.
</objective>

<execution_context>
@C:/Users/sxthi/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/sxthi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/26-unified-overview-preset/26-RESEARCH.md
@.planning/phases/26-unified-overview-preset/26-01-SUMMARY.md
@R/mod_document_notebook.R
@R/mod_search_notebook.R
</context>

<tasks>

<task type="auto">
  <name>Task 1: Replace Summarize + Key Points with Overview popover in document notebook</name>
  <files>R/mod_document_notebook.R</files>
  <action>
**UI changes (in `mod_document_notebook_ui`):**

1. Remove the two `actionButton` lines for `btn_summarize` ("Summarize") and `btn_keypoints` ("Key Points") from the `btn-group` div in the card_header.

2. In their place, add a `bslib::popover()` wrapping an Overview `actionButton` trigger:
```r
popover(
  trigger = actionButton(
    ns("btn_overview"), "Overview",
    class = "btn-sm btn-outline-primary",
    icon = icon("layer-group")
  ),
  title = "Overview Options",
  id = ns("overview_popover"),
  placement = "bottom",
  radioButtons(
    ns("overview_depth"), "Summary Depth",
    choices = c("Concise (1-2 paragraphs)" = "concise",
                "Detailed (3-4 paragraphs)" = "detailed"),
    selected = "concise"
  ),
  radioButtons(
    ns("overview_mode"), "Quality Mode",
    choices = c("Quick (single call)" = "quick",
                "Thorough (two calls)" = "thorough"),
    selected = "quick"
  ),
  actionButton(ns("btn_overview_generate"), "Generate",
               class = "btn-primary btn-sm w-100")
)
```

The Overview button stays in the same `btn-group` div alongside the remaining preset buttons (Study Guide, Outline, Conclusions, Slides).

**Server changes:**

1. Remove the two `observeEvent` lines:
   - `observeEvent(input$btn_summarize, handle_preset("summarize", "Summary"))`
   - `observeEvent(input$btn_keypoints, handle_preset("keypoints", "Key Points"))`

2. Remove `"summarize"` and `"keypoints"` entries from the `presets` list inside `handle_preset()` if it references them — actually `handle_preset()` calls `generate_preset()` which has its own presets list, so just removing the observers is sufficient. The `handle_preset` function itself stays (still used by studyguide, outline).

3. Add new `observeEvent(input$btn_overview_generate, { ... })` handler:
   - Guard with `req(!is_processing())` and `req(has_api_key())`
   - Set `is_processing(TRUE)`
   - Read `input$overview_depth` (default "concise") and `input$overview_mode` (default "quick")
   - Dismiss the popover: `toggle_popover(id = ns("overview_popover"))`  (import `toggle_popover` from bslib if not already available — it is exported from bslib 0.9.0)
   - Build user message label: `paste0("Generate: Overview (", depth_label, ", ", mode_label, ")")`
   - Add user message to `messages()` with `preset_type = "overview"`
   - Call `generate_overview_preset(con(), cfg, nb_id, notebook_type = "document", depth = depth, mode = mode, session_id = session$token)` wrapped in `tryCatch()`
   - Add assistant response to `messages()` with `preset_type = "overview"`
   - Set `is_processing(FALSE)`

4. Update the `is_synthesis` check in the message rendering section (around line 600):
   - Change: `is_synthesis <- !is.null(msg$preset_type) && identical(msg$preset_type, "conclusions")`
   - To: `is_synthesis <- !is.null(msg$preset_type) && msg$preset_type %in% c("conclusions", "overview")`

**IMPORTANT namespacing:** All input IDs inside the popover (`overview_depth`, `overview_mode`, `btn_overview_generate`) MUST use `ns()`. The popover `id` also uses `ns()`. When calling `toggle_popover()`, pass `id = ns("overview_popover")`.
  </action>
  <verify>
1. `grep -c "btn_summarize" R/mod_document_notebook.R` returns 0 (fully removed)
2. `grep -c "btn_keypoints" R/mod_document_notebook.R` returns 0 (fully removed)
3. `grep -c "btn_overview" R/mod_document_notebook.R` returns at least 2 (UI + server)
4. `grep -c "generate_overview_preset" R/mod_document_notebook.R` returns at least 1
5. `grep "overview" R/mod_document_notebook.R | grep "is_synthesis"` shows the updated check
6. `grep -c "popover" R/mod_document_notebook.R` returns at least 1
  </verify>
  <done>
Document notebook shows an "Overview" button with popover options (depth + mode + Generate) in place of Summarize and Key Points. Clicking Generate calls `generate_overview_preset()` and displays the result with AI disclaimer banner. Old Summarize/Key Points buttons and handlers are removed.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add Overview popover to search notebook offcanvas preset row</name>
  <files>R/mod_search_notebook.R</files>
  <action>
**UI changes (in `mod_search_notebook_ui`):**

1. In the offcanvas chat panel, locate the preset buttons row (around line 248-253):
```r
div(
  class = "border-bottom px-3 py-2",
  div(
    class = "btn-group btn-group-sm w-100",
    uiOutput(ns("conclusions_btn_ui"))
  )
)
```

2. Add a second `uiOutput` for the Overview button alongside the existing conclusions button. Change the structure to:
```r
div(
  class = "border-bottom px-3 py-2",
  div(
    class = "btn-group btn-group-sm w-100",
    uiOutput(ns("overview_btn_ui")),
    uiOutput(ns("conclusions_btn_ui"))
  )
)
```

**Server changes:**

1. Add `output$overview_btn_ui <- renderUI({...})` following the pattern of `output$conclusions_btn_ui`:
   - When `rag_available()` is TRUE: render the `popover()` wrapping an Overview `actionButton` (same popover structure as document notebook, with `ns()` on all IDs, `placement = "bottom"`)
   - When `rag_available()` is FALSE: render a disabled button with tooltip "Synthesis unavailable — re-index this notebook first"

2. Add `observeEvent(input$btn_overview_generate, { ... })` handler:
   - Same structure as document notebook handler, but with `notebook_type = "search"`
   - Guard with `req(!is_processing())` and `req(has_api_key())`
   - Read depth/mode, dismiss popover, build label
   - Call `generate_overview_preset(con(), cfg, nb_id, notebook_type = "search", depth = depth, mode = mode, session_id = session$token)`
   - Add user + assistant messages with `preset_type = "overview"`

3. Update the `is_synthesis` check in the search notebook's message rendering (around line 2233):
   - Change: `is_synthesis <- !is.null(msg$preset_type) && identical(msg$preset_type, "conclusions")`
   - To: `is_synthesis <- !is.null(msg$preset_type) && msg$preset_type %in% c("conclusions", "overview")`

**Note:** The search notebook does NOT have Summarize/Key Points buttons to remove — those only exist in the document notebook. The search notebook only had the Conclusions button. Overview is added as a NEW button alongside Conclusions.
  </action>
  <verify>
1. `grep -c "overview_btn_ui" R/mod_search_notebook.R` returns at least 2 (UI + renderUI)
2. `grep -c "btn_overview_generate" R/mod_search_notebook.R` returns at least 2 (renderUI + observeEvent)
3. `grep -c "generate_overview_preset" R/mod_search_notebook.R` returns at least 1
4. `grep "overview" R/mod_search_notebook.R | grep "is_synthesis"` shows the updated check
5. `grep -c "popover" R/mod_search_notebook.R` returns at least 1
  </verify>
  <done>
Search notebook shows an "Overview" button with popover in the offcanvas chat preset row alongside Conclusions. Button is disabled when RAG is unavailable. Clicking Generate calls `generate_overview_preset()` with `notebook_type = "search"` and displays the result with AI disclaimer banner.
  </done>
</task>

</tasks>

<verification>
- Document notebook: Overview popover button visible where Summarize + Key Points used to be
- Document notebook: Summarize and Key Points buttons fully removed (UI + handlers)
- Search notebook: Overview popover button visible in offcanvas preset row alongside Conclusions
- Both modules: Clicking Generate in popover calls `generate_overview_preset()` with correct notebook_type
- Both modules: Overview response renders with AI-generated content disclaimer banner
- Both modules: Popover shows Concise/Detailed depth and Quick/Thorough mode radio options
- Search notebook: Overview button disabled when rag_available() is FALSE
</verification>

<success_criteria>
Users can click Overview in either the document notebook or search notebook, configure depth and quality options in a popover, and receive a combined Summary + Key Points response with the AI disclaimer banner. Summarize and Key Points buttons are fully removed from the document notebook.
</success_criteria>

<output>
After completion, create `.planning/phases/26-unified-overview-preset/26-02-SUMMARY.md`
</output>
