---
phase: 11-doi-storage-migration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - migrations/005_add_doi_column.sql
  - R/utils_doi.R
  - R/db.R
  - R/mod_search_notebook.R
autonomous: true

must_haves:
  truths:
    - "New papers fetched from OpenAlex have their DOI stored in the database"
    - "Existing papers get DOI column added via migration without data loss"
    - "DOIs are stored in normalized bare format (10.xxxx/yyyy, lowercase, no URL prefix)"
    - "Existing papers with NULL DOI get backfilled from OpenAlex in background"
  artifacts:
    - path: "migrations/005_add_doi_column.sql"
      provides: "DOI column addition and index"
      contains: "ALTER TABLE abstracts ADD COLUMN doi"
    - path: "R/utils_doi.R"
      provides: "DOI normalization and citation key generation utilities"
      exports: ["normalize_doi_bare", "is_valid_doi", "generate_citation_key"]
    - path: "R/db.R"
      provides: "Updated create_abstract with doi parameter and backfill_dois function"
      contains: "doi"
    - path: "R/mod_search_notebook.R"
      provides: "Passes doi to create_abstract call"
      contains: "doi = paper$doi"
  key_links:
    - from: "R/mod_search_notebook.R"
      to: "R/db.R::create_abstract"
      via: "doi parameter passed through"
      pattern: "doi = paper\\$doi"
    - from: "R/db.R::create_abstract"
      to: "R/utils_doi.R::normalize_doi_bare"
      via: "DOI normalized before INSERT"
      pattern: "normalize_doi_bare"
    - from: "migrations/005_add_doi_column.sql"
      to: "R/db_migrations.R::run_pending_migrations"
      via: "Auto-discovered by filename pattern"
      pattern: "005_add_doi_column"
---

<objective>
Add DOI storage infrastructure: database migration, normalization utilities, updated insert function, and background backfill for existing papers.

Purpose: Foundation for all v2.0 features (citation export, seeded search, citation network). DOI must be stored consistently before UI can display it.
Output: DOI column in abstracts table, normalization utilities, updated create_abstract(), backfill function.
</objective>

<execution_context>
@C:/Users/sxthi/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/sxthi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-doi-storage-migration/11-RESEARCH.md
@R/db_migrations.R
@R/db.R
@R/api_openalex.R
@R/mod_search_notebook.R
@migrations/004_create_blocked_journals.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: DOI column migration, normalization utilities, and updated create_abstract</name>
  <files>
    migrations/005_add_doi_column.sql
    R/utils_doi.R
    R/db.R
  </files>
  <action>
1. Create `migrations/005_add_doi_column.sql`:
   - `ALTER TABLE abstracts ADD COLUMN doi VARCHAR;`
   - `CREATE INDEX IF NOT EXISTS idx_abstracts_doi ON abstracts(doi);`
   - Follow existing migration file pattern (see 002_create_topics_table.sql for style)

2. Create `R/utils_doi.R` with three exported functions:
   - `normalize_doi_bare(doi)`: Strip URL prefixes (https://doi.org/, https://dx.doi.org/, doi: prefix), trim whitespace, lowercase, validate starts with "10." — return bare DOI or NA_character_ if invalid/NULL/NA/empty. This returns BARE DOI format (just "10.xxxx/yyyy") for storage, NOT the full URL format returned by the existing normalize_doi() in api_openalex.R.
   - `is_valid_doi(doi)`: Validate using Crossref regex pattern `^10\\.\\d{4,9}/[-._;()/:a-z0-9]+$` (case-insensitive)
   - `generate_citation_key(title, year)`: Take first 3 non-article words of title, lowercase, strip special chars, join with underscore, append year. e.g. "Deep Learning for NLP" 2020 -> "deep_learning_nlp_2020"

3. Update `create_abstract()` in `R/db.R` (around line 536):
   - Add `doi = NULL` parameter to function signature
   - Add DOI value conversion: `doi_val <- if (is.null(doi) || is.na(doi) || doi == "") NA_character_ else normalize_doi_bare(doi)`
   - Add `doi` to the INSERT column list and VALUES placeholders (18th column/parameter)
   - Add `doi_val` to the parameter list

IMPORTANT: The existing `normalize_doi()` in `R/api_openalex.R` (line 417) returns a full URL format (https://doi.org/...) for API lookups. The new `normalize_doi_bare()` function in utils_doi.R returns BARE DOI (just "10.xxxx/yyyy") for database storage. These serve different purposes and will not conflict.
  </action>
  <verify>
    - File `migrations/005_add_doi_column.sql` exists with ALTER TABLE and CREATE INDEX statements
    - File `R/utils_doi.R` exists with normalize_doi_bare, is_valid_doi, and generate_citation_key functions
    - `create_abstract()` in R/db.R accepts `doi` parameter and uses normalize_doi_bare() before INSERT
    - No duplicate function name conflicts between utils_doi.R and api_openalex.R
  </verify>
  <done>
    - Migration 005 ready to be applied on next app startup
    - normalize_doi_bare() strips URL prefix, lowercases, validates "10." prefix, returns bare DOI
    - create_abstract() stores normalized bare DOI in database
    - Citation key generation works as fallback for papers without DOI
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire DOI through save path and add background backfill</name>
  <files>
    R/mod_search_notebook.R
    R/db.R
  </files>
  <action>
1. Update the `create_abstract()` call site in `R/mod_search_notebook.R` (around line 1379):
   - Add `doi = paper$doi` to the create_abstract() call
   - The `paper` object here comes from OpenAlex parse results which already include `doi` field (extracted at api_openalex.R:181-186 as bare DOI with https://doi.org/ prefix stripped)

2. Add `backfill_dois()` function to `R/db.R`:
   - Query: `SELECT id, paper_id FROM abstracts WHERE doi IS NULL AND paper_id LIKE 'W%' LIMIT ?` with batch_size parameter (default 50)
   - If no rows, return 0
   - Build pipe-separated OpenAlex filter: `openalex_ids:W123|W456|W789`
   - Call OpenAlex API using existing `build_openalex_request()` pattern to fetch works
   - For each returned work, extract DOI (strip https://doi.org/ prefix), normalize with `normalize_doi_bare()` from utils_doi.R, UPDATE abstracts SET doi = ? WHERE id = ?
   - Return count of papers updated
   - Handle API errors gracefully (log warning, return 0)

3. Add `get_doi_backfill_status()` function to `R/db.R`:
   - Returns list with: total_papers (count of all abstracts), missing_doi (count WHERE doi IS NULL AND paper_id LIKE 'W%'), has_doi (count WHERE doi IS NOT NULL)
   - Used by UI to show backfill progress

4. Source `R/utils_doi.R` — verify it gets sourced. Check if app.R or a global.R sources R/ files. If using `source()` calls, add `source("R/utils_doi.R")`. If Shiny auto-sources R/ directory, no action needed (Shiny sources all R/*.R files alphabetically).
  </action>
  <verify>
    - `create_abstract()` call in mod_search_notebook.R includes `doi = paper$doi`
    - `backfill_dois()` function exists in db.R and uses normalize_doi_bare() from utils_doi.R
    - `get_doi_backfill_status()` function exists in db.R
    - Shiny sources utils_doi.R (check app.R or confirm R/ auto-sourcing)
  </verify>
  <done>
    - New papers from OpenAlex searches have DOI saved to database automatically
    - backfill_dois() can fetch DOIs for existing papers in batches of 50, using normalize_doi_bare() for storage
    - get_doi_backfill_status() reports how many papers need backfill
    - All functions properly sourced at app startup
  </done>
</task>

</tasks>

<verification>
1. Start the app — migration 005 should apply automatically (check console for "[migration] Applied migration 5")
2. Search for papers and save to notebook — new papers should have DOI in database
3. Query: `SELECT id, title, doi FROM abstracts WHERE doi IS NOT NULL LIMIT 5` — should show bare DOIs (10.xxxx/yyyy format)
4. Query: `SELECT COUNT(*) FROM abstracts WHERE doi IS NULL` — should show count of legacy papers needing backfill
</verification>

<success_criteria>
- Migration 005 applies cleanly on existing and fresh databases
- New papers stored with normalized bare DOI
- Backfill function can fetch DOIs for legacy papers
- No naming conflicts between normalize functions (normalize_doi_bare vs normalize_doi)
- Zero data loss for existing records
</success_criteria>

<output>
After completion, create `.planning/phases/11-doi-storage-migration/11-01-SUMMARY.md`
</output>
