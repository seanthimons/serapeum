---
phase: 11-doi-storage-migration
plan: 02
type: execute
wave: 2
depends_on: ["11-01"]
files_modified:
  - R/mod_search_notebook.R
  - R/mod_settings.R
autonomous: false

must_haves:
  truths:
    - "User can see DOI displayed as clickable link in abstract preview for papers that have DOI"
    - "User sees graceful degradation (citation key from title+year) when DOI is unavailable"
    - "User can trigger DOI backfill from settings and see progress"
  artifacts:
    - path: "R/mod_search_notebook.R"
      provides: "DOI display in abstract detail view with clickable link and fallback"
      contains: "doi.org"
    - path: "R/mod_settings.R"
      provides: "Backfill DOI button and progress display"
      contains: "backfill"
  key_links:
    - from: "R/mod_search_notebook.R::abstract_detail"
      to: "abstracts.doi column"
      via: "paper$doi field from SELECT *"
      pattern: "paper\\$doi"
    - from: "R/mod_settings.R"
      to: "R/db.R::backfill_dois"
      via: "Button click triggers backfill function"
      pattern: "backfill_dois"
    - from: "R/mod_search_notebook.R"
      to: "R/utils_doi.R::generate_citation_key"
      via: "Fallback when DOI is NULL"
      pattern: "generate_citation_key"
---

<objective>
Display DOI in abstract preview UI with clickable link and graceful fallback, plus backfill trigger in settings.

Purpose: Addresses GitHub issue #66 (DOI on abstract preview). Users see DOI for citation reference, and can backfill legacy papers.
Output: DOI visible in abstract detail, citation key fallback for legacy papers, backfill button in settings.
</objective>

<execution_context>
@C:/Users/sxthi/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/sxthi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-doi-storage-migration/11-RESEARCH.md
@.planning/phases/11-doi-storage-migration/11-01-SUMMARY.md
@R/mod_search_notebook.R
@R/mod_settings.R
@R/db.R
@R/utils_doi.R
</context>

<tasks>

<task type="auto">
  <name>Task 1: DOI display in abstract preview with graceful degradation</name>
  <files>R/mod_search_notebook.R</files>
  <action>
Update `output$abstract_detail` renderUI in `R/mod_search_notebook.R` (around line 752-833).

Add DOI display AFTER the citation metrics line (line 795) and BEFORE the `hr()` (line 798):

1. Add DOI display block between citation metrics and hr():
   ```r
   # DOI or citation key fallback
   if (!is.null(paper$doi) && !is.na(paper$doi) && nchar(paper$doi) > 0) {
     div(
       class = "mt-2",
       tags$small(class = "text-muted", "DOI: "),
       tags$a(
         href = paste0("https://doi.org/", paper$doi),
         target = "_blank",
         rel = "noopener noreferrer",
         class = "text-primary",
         paper$doi
       )
     )
   } else {
     citation_key <- generate_citation_key(paper$title, paper$year)
     div(
       class = "mt-2",
       tags$small(class = "text-muted", "Citation Key: "),
       tags$code(citation_key),
       tags$small(class = "text-muted ms-2", "(DOI unavailable)")
     )
   }
   ```

2. Place this inside the metadata `div(class = "mb-3", ...)` block, after `format_citation_metrics(...)` on line 795, before the closing `)` of that div and the `hr()`.

IMPORTANT: The `paper$doi` field will be available because `list_abstracts()` uses `SELECT * FROM abstracts` which will include the new doi column after migration 005. No query changes needed.

IMPORTANT: Use `generate_citation_key()` from `R/utils_doi.R` (created in plan 11-01). Verify this function is sourced and available.
  </action>
  <verify>
    - Abstract preview shows clickable DOI link for papers with DOI
    - Abstract preview shows citation key fallback for papers without DOI
    - DOI link opens https://doi.org/{doi} in new tab
    - No R errors when viewing papers with NULL doi
  </verify>
  <done>
    - Papers with DOI show "DOI: 10.xxxx/yyyy" as clickable link in abstract detail
    - Papers without DOI show "Citation Key: deep_learning_nlp_2020 (DOI unavailable)"
    - Links open correct DOI URL in new browser tab
  </done>
</task>

<task type="auto">
  <name>Task 2: Backfill trigger in settings with progress indicator</name>
  <files>R/mod_settings.R</files>
  <action>
Add a "DOI Backfill" section to the settings module. Read `R/mod_settings.R` first to understand its structure.

1. In the settings UI function, add a new card/section for DOI management:
   ```r
   card(
     card_header("DOI Management"),
     card_body(
       uiOutput(ns("doi_status")),
       actionButton(ns("backfill_dois"), "Backfill Missing DOIs",
                    class = "btn btn-outline-primary btn-sm mt-2",
                    icon = icon("rotate"))
     )
   )
   ```

2. In the settings server function, add:
   - `output$doi_status` renderUI: Call `get_doi_backfill_status(con())` to get counts. Display: "X papers with DOI, Y papers missing DOI" using badges or text.
   - `observeEvent(input$backfill_dois, { ... })`: Run backfill in batches with `withProgress()`:
     ```r
     observeEvent(input$backfill_dois, {
       withProgress(message = "Backfilling DOIs...", {
         total_updated <- 0
         repeat {
           updated <- backfill_dois(con(), batch_size = 50)
           total_updated <- total_updated + updated
           incProgress(0.1, detail = paste(total_updated, "papers updated"))
           if (updated < 50) break  # No more papers to backfill
         }
       })
       showNotification(paste("Backfill complete:", total_updated, "DOIs updated"), type = "message")
     })
     ```

3. The `backfill_dois()` function needs access to the OpenAlex API. Check how the settings module accesses API credentials (email, api_key). Pass these to `backfill_dois()` or have `backfill_dois()` read them from the database settings. Adjust the function signature accordingly — the backfill function in db.R may need `email` and `api_key` parameters to call the OpenAlex API.

IMPORTANT: The `backfill_dois()` function in db.R (from plan 11-01) calls the OpenAlex API. It needs the user's email (required by OpenAlex polite pool). Read the email from db settings using `get_db_setting(con, "openalex_email")` or pass it as parameter. Check existing patterns in the codebase for how OpenAlex email is accessed.
  </action>
  <verify>
    - Settings page shows "DOI Management" section with status counts
    - "Backfill Missing DOIs" button triggers backfill with progress indicator
    - After backfill, notification shows count of updated papers
    - Status display updates to reflect new counts after backfill
  </verify>
  <done>
    - Settings shows DOI status (X with DOI, Y missing)
    - Backfill button fetches DOIs from OpenAlex in batches of 50
    - Progress bar shows during backfill operation
    - Success notification confirms completion
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify DOI display and backfill end-to-end</name>
  <action>
    Human verification of the complete DOI feature: display in abstract preview and backfill from settings.
  </action>
  <what-built>DOI display in abstract preview (clickable link or citation key fallback) and backfill trigger in settings</what-built>
  <how-to-verify>
    1. Start the app — check console for "[migration] Applied migration 5: add doi column"
    2. Go to a search notebook, search for papers, save some to notebook
    3. Click on a saved paper — verify DOI appears as clickable link below citation metrics
    4. Click the DOI link — should open https://doi.org/... in new tab
    5. If you have legacy papers (saved before this update), click one — should show "Citation Key: xxx (DOI unavailable)"
    6. Go to Settings — verify "DOI Management" section shows paper counts
    7. Click "Backfill Missing DOIs" — verify progress bar appears and DOIs get filled
    8. Return to a previously-legacy paper — should now show DOI link instead of citation key
  </how-to-verify>
  <verify>All 8 verification steps pass</verify>
  <done>DOI feature works end-to-end for both new and legacy papers</done>
  <resume-signal>Type "approved" or describe issues</resume-signal>
</task>

</tasks>

<verification>
1. Abstract preview displays DOI as clickable link for papers with DOI
2. Abstract preview shows citation key fallback for papers without DOI
3. Settings page shows DOI backfill status and trigger button
4. Backfill successfully fetches DOIs from OpenAlex for legacy papers
5. GitHub issue #66 requirements met
</verification>

<success_criteria>
- DOI visible in abstract preview for newly fetched papers (issue #66)
- Graceful degradation with citation key for legacy papers without DOI
- Backfill runs without blocking app, updates legacy papers
- All four phase success criteria met:
  1. DOI displayed in abstract preview for new papers
  2. Existing database papers get DOI backfilled via settings button
  3. Citation key fallback when DOI unavailable
  4. Migration runs on startup preserving all existing data
</success_criteria>

<output>
After completion, create `.planning/phases/11-doi-storage-migration/11-02-SUMMARY.md`
</output>
