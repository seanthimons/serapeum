---
phase: 22-module-migration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - R/db.R
  - R/_ragnar.R
  - app.R
autonomous: true

must_haves:
  truths:
    - "search_chunks_hybrid() derives per-notebook store path from notebook_id when ragnar_store_path is NULL"
    - "delete_abstract_chunks_from_ragnar() removes chunks from ragnar store by abstract ID origin prefix"
    - "mark_as_ragnar_indexed() sets sentinel embedding value for chunks table"
    - "Legacy shared store data/serapeum.ragnar.duckdb is deleted on app startup"
  artifacts:
    - path: "R/db.R"
      provides: "search_chunks_hybrid with per-notebook path derivation"
      contains: "get_notebook_ragnar_path(notebook_id)"
    - path: "R/_ragnar.R"
      provides: "delete_abstract_chunks_from_ragnar, mark_as_ragnar_indexed helpers"
      contains: "delete_abstract_chunks_from_ragnar"
    - path: "app.R"
      provides: "Legacy shared store deletion on startup"
      contains: "serapeum.ragnar.duckdb"
  key_links:
    - from: "R/db.R"
      to: "R/_ragnar.R"
      via: "get_notebook_ragnar_path call in search_chunks_hybrid"
      pattern: "get_notebook_ragnar_path"
---

<objective>
Wire backend functions for per-notebook ragnar store usage: fix search_chunks_hybrid() path derivation, add chunk deletion and sentinel marking helpers, delete legacy shared store on startup.

Purpose: All downstream RAG callers (rag_query, generate_conclusions_preset) automatically use per-notebook stores without code changes. Helper functions enable search notebook chunk deletion and embedding tracking.

Output: Updated db.R, _ragnar.R with new helpers, app.R with shared store cleanup.
</objective>

<execution_context>
@C:/Users/sxthi/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/sxthi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/22-module-migration/22-RESEARCH.md
@.planning/phases/21-store-lifecycle/21-01-SUMMARY.md
@.planning/phases/20-foundation-connection-safety/20-01-SUMMARY.md

Key references:
- R/db.R lines 836-839: search_chunks_hybrid() signature with hardcoded default
- R/db.R lines 842-843: ragnar_available() + file.exists check before store connect
- R/_ragnar.R: get_notebook_ragnar_path(), insert_chunks_to_ragnar(), build_ragnar_index() already exist
- R/rag.R lines 84-86: rag_query() calls search_chunks_hybrid(con, question, notebook_id, limit=5) — already passes notebook_id
- R/rag.R lines 306-341: generate_conclusions_preset() calls search_chunks_hybrid with notebook_id — already passes notebook_id
- app.R lines 21-25: ragnar directory creation on startup
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix search_chunks_hybrid() path default and add per-notebook derivation</name>
  <files>R/db.R</files>
  <action>
In R/db.R, modify the `search_chunks_hybrid()` function:

1. Change the default value of `ragnar_store_path` from `"data/serapeum.ragnar.duckdb"` to `NULL`.

2. Add path derivation logic at the top of the function body, BEFORE the `ragnar_available()` check:
```r
# Derive store path from notebook_id if not provided (Phase 22: per-notebook stores)
if (is.null(ragnar_store_path) && !is.null(notebook_id)) {
  ragnar_store_path <- get_notebook_ragnar_path(notebook_id)
}
```

3. The existing code at line 842 (`if (ragnar_available() && file.exists(ragnar_store_path))`) will naturally handle the case where ragnar_store_path is still NULL (file.exists(NULL) returns FALSE, so it falls through to legacy path).

4. Update the roxygen2 comment for @param ragnar_store_path to: `Path to ragnar store database (NULL to derive from notebook_id)`

Do NOT change any other part of search_chunks_hybrid(). The notebook_id filtering logic (lines 852-878) and section_filter logic (lines 882-927) remain as-is.

Verify: All existing callers in rag.R already pass notebook_id, so they will automatically get per-notebook paths without any changes to rag.R.
  </action>
  <verify>
Run: `"C:\Program Files\R\R-4.5.1\bin\Rscript.exe" -e "source('R/_ragnar.R'); source('R/db.R'); cat('db.R parses OK\n')"`
Grep for "serapeum.ragnar.duckdb" in R/db.R — should return zero results.
Grep for `ragnar_store_path = NULL` in R/db.R — should find the new default.
  </verify>
  <done>search_chunks_hybrid() has ragnar_store_path=NULL default and derives path from notebook_id via get_notebook_ragnar_path(). No hardcoded shared store path remains in db.R.</done>
</task>

<task type="auto">
  <name>Task 2: Add chunk deletion and sentinel helpers to _ragnar.R, delete shared store in app.R</name>
  <files>R/_ragnar.R, app.R</files>
  <action>
**Part A: Add two new helper functions to R/_ragnar.R** (add in the Store Lifecycle section, after `rebuild_notebook_store`):

1. `delete_abstract_chunks_from_ragnar(notebook_id, abstract_id)`:
   - Get store path via `get_notebook_ragnar_path(notebook_id)`
   - If store file doesn't exist, return invisible(NULL)
   - Connect to ragnar DuckDB directly: `DBI::dbConnect(duckdb::duckdb(), dbdir = store_path)`
   - Use `on.exit(DBI::dbDisconnect(con, shutdown = TRUE), add = TRUE)` for cleanup
   - Build origin prefix: `paste0("abstract:", abstract_id)`
   - Execute: `DBI::dbExecute(con, "DELETE FROM chunks WHERE origin LIKE ?", list(paste0(origin_prefix, "%")))` — use LIKE with % suffix (safer than starts_with which may not exist in all DuckDB versions)
   - Log with `message("[ragnar] Deleted chunks for abstract: ", abstract_id)`
   - Wrap entire body in tryCatch, log errors with `message("[ragnar] Chunk deletion failed for ", abstract_id, ": ", e$message)`
   - Add roxygen2 docs

2. `mark_as_ragnar_indexed(con, source_ids, source_type = "abstract")`:
   - If `length(source_ids) == 0`, return invisible(NULL)
   - Build parameterized query: `placeholders <- paste(rep("?", length(source_ids)), collapse = ", ")`
   - Execute: `DBI::dbExecute(con, sprintf("UPDATE chunks SET embedding = 'ragnar_indexed' WHERE source_id IN (%s) AND source_type = ?", placeholders), c(as.list(source_ids), source_type))`
   - Wrap in tryCatch, log errors
   - Add roxygen2 docs

**Part B: Delete legacy shared store on app startup in app.R**

In app.R, after the ragnar directory creation block (lines 21-25), add:

```r
# Phase 22: Delete legacy shared store (replaced by per-notebook stores)
legacy_store <- file.path("data", "serapeum.ragnar.duckdb")
if (file.exists(legacy_store)) {
  message("[ragnar] Removing legacy shared store: ", legacy_store)
  file.remove(legacy_store)
  # Also remove WAL and tmp files
  for (ext in c(".wal", ".tmp")) {
    f <- paste0(legacy_store, ext)
    if (file.exists(f)) file.remove(f)
  }
}
```
  </action>
  <verify>
Run: `"C:\Program Files\R\R-4.5.1\bin\Rscript.exe" -e "source('R/_ragnar.R'); cat('_ragnar.R parses OK\n')"`
Grep for "delete_abstract_chunks_from_ragnar" in R/_ragnar.R — should find the function.
Grep for "mark_as_ragnar_indexed" in R/_ragnar.R — should find the function.
Grep for "legacy shared store" in app.R — should find the cleanup block.
  </verify>
  <done>Two helper functions exist in _ragnar.R: delete_abstract_chunks_from_ragnar for chunk removal and mark_as_ragnar_indexed for sentinel values. Legacy shared store is deleted on app startup in app.R.</done>
</task>

</tasks>

<verification>
1. Grep entire R/ directory for "serapeum.ragnar.duckdb" — only _ragnar.R should still reference it (in the legacy `get_ragnar_store` and `connect_ragnar_store` functions which will be removed in Phase 23), plus app.R cleanup block
2. R/db.R, R/_ragnar.R, app.R all parse without errors
3. search_chunks_hybrid() default ragnar_store_path is NULL, not the shared store path
</verification>

<success_criteria>
- search_chunks_hybrid() derives per-notebook store path from notebook_id when ragnar_store_path not provided
- Two new helper functions ready for Plan 02/03 consumption
- Legacy shared store deleted on app startup
- All R files parse cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/22-module-migration/22-01-SUMMARY.md`
</output>
