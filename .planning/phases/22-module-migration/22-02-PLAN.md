---
phase: 22-module-migration
plan: 02
type: execute
wave: 2
depends_on: ["22-01"]
files_modified:
  - R/mod_document_notebook.R
autonomous: true

must_haves:
  truths:
    - "User opens notebook with documents but no per-notebook store and sees a migration prompt to re-index"
    - "User declines re-index and RAG controls (chat send button) are greyed out with tooltip"
    - "User accepts re-index and sees blocking progress modal with per-document detail"
    - "User cancels re-index mid-way and partial store is deleted; prompted again next time"
    - "PDF upload writes to per-notebook ragnar store, not shared store"
    - "Empty notebook (no documents) does NOT show migration prompt"
  artifacts:
    - path: "R/mod_document_notebook.R"
      provides: "Migration prompt, rag_ready state, per-notebook store wiring in upload handler"
      contains: "rag_ready"
  key_links:
    - from: "R/mod_document_notebook.R"
      to: "R/_ragnar.R"
      via: "ensure_ragnar_store, get_notebook_ragnar_path, rebuild_notebook_store, delete_notebook_store"
      pattern: "ensure_ragnar_store|get_notebook_ragnar_path"
---

<objective>
Migrate document notebook module to use per-notebook ragnar stores: add migration detection and re-index prompt, rag_ready state for greyed-out controls, rewire PDF upload to use per-notebook store, add cancellation support.

Purpose: Document notebooks achieve true per-notebook isolation. Existing notebooks with content but no store prompt users to re-index. RAG features disabled until store exists.

Output: Updated mod_document_notebook.R with full per-notebook store wiring.
</objective>

<execution_context>
@C:/Users/sxthi/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/sxthi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/22-module-migration/22-RESEARCH.md
@.planning/phases/22-module-migration/22-01-SUMMARY.md
@.planning/phases/21-store-lifecycle/21-02-SUMMARY.md

Key references:
- R/mod_document_notebook.R lines 122-200: Existing Phase 21 store_healthy reactiveVal, integrity check, rebuild handler
- R/mod_document_notebook.R lines 315-384: PDF upload embedding block (currently uses shared store path)
- R/mod_document_notebook.R line 522: rag_query() call (already passes notebook_id to search_chunks_hybrid via rag.R)
- R/mod_document_notebook.R lines 325-344: ragnar store path construction using config → needs replacement
- R/_ragnar.R: ensure_ragnar_store(), rebuild_notebook_store(), delete_notebook_store(), get_notebook_ragnar_path()
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add migration detection, rag_ready state, and re-index UX to mod_document_notebook.R</name>
  <files>R/mod_document_notebook.R</files>
  <action>
Modify `mod_document_notebook.R` to add per-notebook store migration:

**1. Add rag_ready reactiveVal** (near store_healthy on line 122):
```r
rag_ready <- reactiveVal(TRUE)  # FALSE = needs migration, greyed-out controls
reindex_cancelled <- reactiveVal(FALSE)  # Tracks if user cancelled mid-reindex
```

**2. Modify the existing observeEvent(notebook_id(), ...) block (lines 125-157)**

Replace the current logic. The new logic should:
- Reset both `store_healthy(NULL)` and `rag_ready(TRUE)` and `reindex_cancelled(FALSE)` at the start
- Get store_path via `get_notebook_ragnar_path(nb_id)`
- Check if content exists: `docs <- list_documents(con(), nb_id)` and `has_content <- nrow(docs) > 0`
- **If has_content AND no store file**: Show migration modal (see below), set `rag_ready(FALSE)`
- **If no content AND no store**: Set `store_healthy(TRUE)` and `rag_ready(TRUE)` (empty notebook, lazy creation later)
- **If store file exists**: Run existing integrity check (`check_store_integrity`), set `store_healthy(result$ok)`, set `rag_ready(result$ok)`. If not ok, show existing rebuild modal.

Migration modal:
```r
showModal(modalDialog(
  title = "Search Index Setup Required",
  tags$p("This notebook has documents but no search index. Chat and synthesis will be unavailable until you re-index."),
  tags$p(class = "text-muted small", paste(nrow(docs), "document(s) to index.")),
  footer = tagList(
    actionButton(ns("reindex_notebook"), "Re-index Now", class = "btn-primary"),
    modalButton("Later")
  ),
  easyClose = FALSE
))
```

**3. Add re-index handler** (new observeEvent after the existing rebuild_index handler):

```r
observeEvent(input$reindex_notebook, {
  removeModal()
  nb_id <- notebook_id()
  req(nb_id)

  reindex_cancelled(FALSE)

  cfg <- config()
  api_key <- get_setting(cfg, "openrouter", "api_key")
  embed_model <- get_setting(cfg, "defaults", "embedding_model") %||% "openai/text-embedding-3-small"

  # Show blocking progress modal
  showModal(modalDialog(
    title = "Re-indexing Notebook",
    div(
      tags$p(id = ns("reindex_detail"), "Preparing..."),
      div(class = "progress mt-2",
        div(class = "progress-bar progress-bar-striped progress-bar-animated",
            id = ns("reindex_bar"), role = "progressbar",
            style = "width: 0%")
      )
    ),
    footer = actionButton(ns("cancel_reindex"), "Cancel", class = "btn-danger"),
    easyClose = FALSE
  ))

  withProgress(message = "Re-indexing...", value = 0, {
    result <- rebuild_notebook_store(
      notebook_id = nb_id,
      con = con(),
      api_key = api_key,
      embed_model = embed_model,
      progress_callback = function(count, total) {
        incProgress(1/total, detail = paste0("Embedding item ", count, " of ", total))
      }
    )
  })

  removeModal()

  # Check if cancelled during operation
  if (isTRUE(reindex_cancelled())) {
    delete_notebook_store(nb_id)
    rag_ready(FALSE)
    showNotification("Re-indexing cancelled. Partial index removed.", type = "warning")
    return()
  }

  if (result$success) {
    rag_ready(TRUE)
    store_healthy(TRUE)
    # Mark chunks as ragnar-indexed in chunks table
    tryCatch({
      mark_as_ragnar_indexed(con(),
        DBI::dbGetQuery(con(), "SELECT id FROM documents WHERE notebook_id = ?", list(nb_id))$id,
        source_type = "document")
    }, error = function(e) message("[ragnar] Sentinel update failed: ", e$message))
    showNotification(paste("Re-indexed", result$count, "items successfully."), type = "message", duration = 5)
  } else {
    rag_ready(FALSE)
    store_healthy(FALSE)
    showNotification(paste("Re-indexing failed:", result$error), type = "error", duration = NULL)
  }
})
```

**4. Add cancel handler:**
```r
observeEvent(input$cancel_reindex, {
  reindex_cancelled(TRUE)
  removeModal()
})
```

**5. Rewire PDF upload handler** (lines 325-344):

Replace the shared store path construction block:
```r
# OLD (remove):
ragnar_store_path <- file.path(dirname(get_setting(cfg, "app", "db_path") %||% "data/notebooks.duckdb"),
                               "serapeum.ragnar.duckdb")
store <- get_ragnar_store(ragnar_store_path, ...)
```

With per-notebook store:
```r
# Phase 22: Use per-notebook ragnar store
store <- tryCatch(
  ensure_ragnar_store(nb_id, session, api_key, embed_model),
  error = function(e) {
    message("[ragnar] Failed to open per-notebook store: ", e$message)
    NULL
  }
)
```
Where `nb_id <- notebook_id()` is already available in scope (add `nb_id <- notebook_id()` at the start of the upload handler if not already there).

Keep the rest of the upload ragnar block (insert_chunks_to_ragnar, build_ragnar_index) as-is — they already use the `store` variable.

After the ragnar block succeeds (`ragnar_indexed <- TRUE`), add sentinel marking:
```r
if (ragnar_indexed) {
  rag_ready(TRUE)
  store_healthy(TRUE)
}
```

**6. Grey out chat send button when RAG not ready:**

Find the chat input/send UI area. Add a conditional check before `rag_query()` call (around line 522). If `!isTRUE(rag_ready()) || !isTRUE(store_healthy())`, show notification "Chat unavailable — re-index this notebook first" and return early.

Replace the Phase 22 placeholder comment (line 202-203) with:
```r
# Phase 22: RAG operations check both store_healthy and rag_ready
rag_available <- reactive({
  isTRUE(store_healthy()) && isTRUE(rag_ready())
})
```

**Important constraints:**
- Do NOT change the `observeEvent(input$rebuild_index, ...)` handler — it stays for corruption recovery
- Keep `store_healthy` for corruption, `rag_ready` for migration — separate concerns
- The `ragnar_available()` check in the upload handler (line 325) stays — it will be removed in Phase 23 (legacy code removal)
  </action>
  <verify>
Run: `"C:\Program Files\R\R-4.5.1\bin\Rscript.exe" -e "parse('R/mod_document_notebook.R'); cat('mod_document_notebook.R parses OK\n')"`
Grep for "serapeum.ragnar.duckdb" in R/mod_document_notebook.R — should return zero results.
Grep for "rag_ready" in R/mod_document_notebook.R — should find reactiveVal declaration and usage.
Grep for "reindex_notebook" in R/mod_document_notebook.R — should find input binding and handler.
Grep for "ensure_ragnar_store" in R/mod_document_notebook.R — should find call in upload handler.
  </verify>
  <done>Document notebook module detects migration need, shows re-index prompt with progress/cancellation, greys out RAG when unavailable, and PDF uploads go to per-notebook store. No shared store references remain.</done>
</task>

</tasks>

<verification>
1. R/mod_document_notebook.R parses without errors
2. No "serapeum.ragnar.duckdb" references remain
3. rag_ready reactiveVal controls RAG feature availability
4. Migration prompt only shows for notebooks with content but no store
5. Upload handler uses ensure_ragnar_store() with per-notebook path
</verification>

<success_criteria>
- Document notebook with existing documents but no per-notebook store shows migration prompt
- Empty document notebook does not show prompt
- Chat send is blocked when rag_ready is FALSE
- PDF upload creates per-notebook store via ensure_ragnar_store
- Cancel deletes partial store; user prompted again on next open
</success_criteria>

<output>
After completion, create `.planning/phases/22-module-migration/22-02-SUMMARY.md`
</output>
