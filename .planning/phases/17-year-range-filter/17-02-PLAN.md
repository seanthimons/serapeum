---
phase: 17-year-range-filter
plan: 02
type: execute
wave: 2
depends_on: ["17-01"]
files_modified:
  - R/mod_citation_network.R
autonomous: true

must_haves:
  truths:
    - "User can filter citation network nodes by year range using slider"
    - "User clicks Apply Filter button to apply year filter to network (no auto-refresh)"
    - "Papers with unknown years in citation network can be included/excluded via checkbox"
  artifacts:
    - path: "R/mod_citation_network.R"
      provides: "Year range slider, apply filter button, unknown year checkbox in citation network controls"
      contains: "year_filter"
  key_links:
    - from: "R/mod_citation_network.R year_filter slider"
      to: "R/mod_citation_network.R network rendering"
      via: "eventReactive on apply_year_filter button filters current_network_data nodes"
      pattern: "apply_year_filter"
---

<objective>
Add year range filtering to the citation network module with Apply Filter button.

Purpose: Users need to filter citation network nodes by publication year to focus on specific time periods. Unlike the search notebook (which filters on drag), the citation network uses an explicit "Apply Filter" button to prevent janky graph redraws during slider drag (YEAR-05 auto-refresh is explicitly out of scope).

Output: Working year filter in citation network with slider, apply button, and unknown year handling.
</objective>

<execution_context>
@C:/Users/sxthi/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/sxthi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/17-year-range-filter/17-RESEARCH.md
@.planning/phases/17-year-range-filter/17-01-SUMMARY.md
@R/mod_citation_network.R
@R/db.R
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add year filter controls and Apply Filter button to citation network</name>
  <files>R/mod_citation_network.R</files>
  <action>
**In mod_citation_network_ui**, modify the top controls bar. The current `layout_columns` has `col_widths = c(2, 2, 2, 3, 3)` with 5 columns: Direction, Depth, Node Cap, Build button, Save button. Add year filter controls by reorganizing to accommodate the new elements.

Change the layout to `col_widths = c(2, 2, 2, 3, 3)` keeping the same structure but replacing the Save button column (last col_width=3) with a year filter section, and moving Save into the Build button column. Alternatively, add a second row below the controls bar for year filtering. Use the second-row approach to avoid cramming too many controls:

After the existing `layout_columns(...)` closing paren but still inside the `div(class = "citation-network-controls ...")`, add a new div for year filter:

```r
# Year filter row (below main controls)
div(
  class = "mt-2 pt-2 border-top",
  layout_columns(
    col_widths = c(5, 3, 4),

    # Year range slider
    div(
      sliderInput(
        ns("year_filter"),
        tags$span("Year Range",
                  title = "Filter network nodes by publication year. Adjust range then click Apply to update."),
        min = 1900,
        max = 2026,
        value = c(1900, 2026),
        step = 1,
        sep = "",
        ticks = FALSE
      )
    ),

    # Include unknown checkbox
    div(
      class = "pt-4",
      checkboxInput(
        ns("include_unknown_year_network"),
        "Include unknown year",
        value = TRUE
      )
    ),

    # Apply filter button + preview count
    div(
      class = "pt-3",
      actionButton(
        ns("apply_year_filter"),
        "Apply Year Filter",
        class = "btn-outline-primary btn-sm",
        icon = icon("filter")
      ),
      uiOutput(ns("year_filter_preview"))
    )
  )
)
```

**In mod_citation_network_server**, add the following logic:

1. **Dynamic slider bounds from network data** - Add an `observe()` that watches `current_network_data()`. When network data is available, extract year column from nodes, compute min/max (ignoring NA), and call `updateSliderInput(session, "year_filter", min = min_year, max = max_year, value = c(min_year, max_year))`. Use fallback min=1900, max=2026 if all years are NA.

2. **Filter preview** - Add `output$year_filter_preview <- renderUI()` that shows how many nodes will remain after filtering. This should react to `input$year_filter` and `input$include_unknown_year_network` WITHOUT debouncing (it's a lightweight count, not a graph redraw). Access `current_network_data()$nodes`, count how many pass the year filter, display as "N of M nodes" in `small text-muted` styling.

3. **Apply year filter** - Add `observeEvent(input$apply_year_filter, { ... })` that:
   - Gets `range <- input$year_filter`
   - Gets `include_null <- input$include_unknown_year_network`
   - Gets current network data: `net_data <- current_network_data()`
   - Filters nodes: if include_null, keep `is.na(year) | (year >= range[1] & year <= range[2])`; otherwise keep `!is.na(year) & year >= range[1] & year <= range[2]`
   - Filters edges: keep only edges where both `from` and `to` are in filtered node IDs
   - Updates `current_network_data()` with the filtered nodes and edges (preserving metadata)
   - Shows notification: "Year filter applied: N of M nodes shown"

4. **Important: Access the year column correctly.** The nodes data frame in current_network_data uses `paper_year` or `year` column - check the `build_network_data()` function output in the codebase. The visNetwork nodes data frame may store year differently than the raw nodes. Use whatever column name contains the publication year. If the year column is named differently (e.g., `paper_year`), use that name consistently.

5. **Edge case: No network loaded.** The year filter UI should be visible but the Apply button should do nothing if `current_network_data()` is NULL. Use `req(current_network_data())` inside the observeEvent.

**Do NOT:**
- Auto-refresh the network graph when slider moves (YEAR-05 is explicitly out of scope)
- Add debouncing to the citation network slider (the Apply button pattern makes it unnecessary)
- Add a histogram to the citation network (not required, would clutter the controls)
  </action>
  <verify>
1. Run `"C:\Program Files\R\R-4.5.1\bin\Rscript.exe" -e "library(shiny); library(bslib); library(visNetwork); library(viridisLite); source('R/db.R'); source('R/api_openalex.R'); source('R/mod_citation_network.R'); cat('Citation network module loaded OK\n')"` to verify mod_citation_network.R parses
2. Verify `year_filter`, `include_unknown_year_network`, `apply_year_filter`, `year_filter_preview` exist in mod_citation_network.R
3. Verify the Apply button uses `observeEvent(input$apply_year_filter, ...)` pattern (not reactive auto-update)
  </verify>
  <done>
- Citation network controls bar has year range slider, unknown year checkbox, and Apply Year Filter button
- Slider bounds update dynamically when a network is built
- Filter preview shows "N of M nodes" before applying
- Clicking Apply Filter filters nodes by year range and removes orphaned edges
- Papers with unknown year can be included/excluded via checkbox
- Network does NOT auto-refresh on slider drag (Apply button required)
  </done>
</task>

</tasks>

<verification>
- R/mod_citation_network.R loads without error with all dependencies
- Year filter UI elements present in citation network controls
- Apply Filter button triggers node filtering (not slider drag)
- Edge filtering removes edges to/from excluded nodes
- Unknown year checkbox works for citation network nodes
</verification>

<success_criteria>
- Citation network has year range slider in controls area
- User must click "Apply Year Filter" to filter nodes (no auto-refresh)
- Preview shows node count before applying filter
- Filtered network removes nodes outside year range and their edges
- Unknown year papers can be toggled via checkbox
- Slider bounds reflect actual year range from network data
</success_criteria>

<output>
After completion, create `.planning/phases/17-year-range-filter/17-02-SUMMARY.md`
</output>
