---
phase: 17-year-range-filter
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - R/db.R
  - R/mod_search_notebook.R
autonomous: true

must_haves:
  truths:
    - "User can adjust year range slider in search notebook and see filtered results"
    - "User sees histogram showing paper distribution by year below the slider"
    - "Papers with unknown years show indicator and can be included/excluded via checkbox"
    - "Year filter updates are debounced to prevent UI freezes during drag"
  artifacts:
    - path: "R/db.R"
      provides: "get_year_distribution() and get_unknown_year_count() helper functions"
      contains: "get_year_distribution"
    - path: "R/mod_search_notebook.R"
      provides: "Year range slider, histogram, unknown year checkbox in search notebook"
      contains: "year_range"
  key_links:
    - from: "R/mod_search_notebook.R"
      to: "R/db.R"
      via: "get_year_distribution() and get_unknown_year_count() calls"
      pattern: "get_year_distribution|get_unknown_year_count"
    - from: "R/mod_search_notebook.R year_range debounced"
      to: "R/mod_search_notebook.R filtered_papers"
      via: "debounce(reactive, 400) feeds into filter chain"
      pattern: "debounce.*year_range"
---

<objective>
Add year range filtering with histogram preview to the search notebook module.

Purpose: Users need to narrow search results by publication year range. The slider with histogram preview gives visual context about paper distribution, and the debounced reactive prevents UI freezes during drag. This covers requirements YEAR-01, YEAR-02, and YEAR-04 for the search notebook context.

Output: Working year filter in search notebook with histogram, debouncing, and unknown year handling.
</objective>

<execution_context>
@C:/Users/sxthi/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/sxthi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/17-year-range-filter/17-RESEARCH.md
@R/db.R
@R/mod_search_notebook.R
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add year distribution DB helpers and search notebook year filter UI + server logic</name>
  <files>R/db.R, R/mod_search_notebook.R</files>
  <action>
**In R/db.R**, add two new functions near the other query helpers:

1. `get_year_distribution(con, notebook_id)` - Returns data frame with columns `year` (INTEGER) and `count` (INTEGER). Query: `SELECT year, COUNT(*) AS count FROM abstracts WHERE notebook_id = ? AND year IS NOT NULL GROUP BY year ORDER BY year`. Return empty data frame with correct columns if no results.

2. `get_unknown_year_count(con, notebook_id)` - Returns integer count. Query: `SELECT COUNT(*) AS n FROM abstracts WHERE notebook_id = ? AND year IS NULL`. Return `result$n`.

3. `get_year_bounds(con, notebook_id)` - Returns list with `min_year` and `max_year`. Query: `SELECT COALESCE(MIN(year), 2000) AS min_year, COALESCE(MAX(year), 2026) AS max_year FROM abstracts WHERE notebook_id = ? AND year IS NOT NULL`. This avoids hard-coding slider bounds.

**In R/mod_search_notebook.R UI** (`mod_search_notebook_ui`), add a year filter panel inside the left card_body, AFTER the existing filter controls div (the `filter_has_abstract` checkbox around line 96-101) and BEFORE the paper_list_container div (line 102-106):

```r
# Year range filter panel
div(
  class = "mb-2",
  sliderInput(
    ns("year_range"),
    "Publication Year",
    min = 1900,
    max = 2026,
    value = c(1900, 2026),
    step = 1,
    sep = "",
    ticks = FALSE
  ),
  plotOutput(ns("year_histogram"), height = "60px"),
  div(
    class = "d-flex justify-content-between align-items-center",
    checkboxInput(
      ns("include_unknown_year"),
      "Include unknown year",
      value = TRUE
    ),
    textOutput(ns("unknown_year_count"), inline = TRUE) |>
      tagAppendAttributes(class = "text-muted small")
  )
)
```

**In R/mod_search_notebook.R server** (`mod_search_notebook_server`), add the following logic:

1. **Dynamic slider bounds** - Add an `observe()` that watches `papers_data()` (which already reacts to notebook changes and refreshes). When papers_data updates, call `get_year_bounds(con(), nb_id)` and use `updateSliderInput()` to set min, max, and value to the full range from the database.

2. **Debounced year range reactive** - Create `year_range_raw <- reactive({ input$year_range })` then `year_range <- debounce(year_range_raw, 400)`.

3. **Histogram rendering** - Add `output$year_histogram <- renderPlot()` that calls `get_year_distribution(con(), nb_id)`. If zero rows, render empty plot via `ggplot() + theme_void()`. Otherwise render `ggplot(year_counts, aes(x = year, y = count)) + geom_col(fill = "#6366f1", width = 0.8, alpha = 0.7)` with minimal theme (no axis text, no axis title, no grid, no ticks, transparent background, zero margins). Use `bg = "transparent"` in renderPlot to avoid white background.

4. **Unknown year count display** - Add `output$unknown_year_count <- renderText()` that calls `get_unknown_year_count(con(), nb_id)`. Format as "(N unknown)" if count > 0, empty string otherwise.

5. **Year filter in filter chain** - The current chain is: `papers_data -> keyword_filtered -> journal_filtered -> filtered_papers (has_abstract check)`. Insert year filtering INTO the existing `filtered_papers` reactive (around line 405-413). After the `journal_filtered_papers()` call and has_abstract filter, add year range filtering:
   - Get `range <- year_range()` (debounced)
   - Get `include_null <- input$include_unknown_year`
   - If `include_null` is TRUE: keep rows where `is.na(papers$year) | (papers$year >= range[1] & papers$year <= range[2])`
   - If `include_null` is FALSE: keep rows where `!is.na(papers$year) & papers$year >= range[1] & papers$year <= range[2]`
   - Handle edge case where `range` is NULL (slider not yet initialized): skip year filtering.

**Important implementation notes:**
- Use `req(nb_id)` in all server expressions that need notebook_id
- The histogram should react to `paper_refresh()` to update when papers are added/removed (same trigger as papers_data)
- Do NOT use plotly - use plain ggplot2 per research recommendation (simpler, no extra dependency)
- The slider sep="" is critical - years should display as "2024" not "2,024"
  </action>
  <verify>
1. Run `"C:\Program Files\R\R-4.5.1\bin\Rscript.exe" -e "source('R/db.R'); cat('DB helpers loaded OK\n')"` to verify db.R parses
2. Run `"C:\Program Files\R\R-4.5.1\bin\Rscript.exe" -e "library(shiny); library(bslib); library(ggplot2); source('R/db.R'); source('R/api_openalex.R'); source('R/api_openrouter.R'); source('R/_ragnar.R'); source('R/mod_keyword_filter.R'); source('R/mod_journal_filter.R'); source('R/mod_search_notebook.R'); cat('Search notebook module loaded OK\n')"` to verify mod_search_notebook.R parses without errors
3. Verify `get_year_distribution`, `get_unknown_year_count`, `get_year_bounds` exist in db.R
4. Verify `year_range`, `year_histogram`, `include_unknown_year`, `unknown_year_count` exist in mod_search_notebook.R
5. Verify `debounce` is used with year_range reactive
  </verify>
  <done>
- Search notebook UI shows year range slider, histogram plot, unknown year checkbox with count
- Slider bounds update dynamically from database when notebook changes
- Year range reactive is debounced at 400ms
- Histogram renders paper distribution by year using ggplot2
- Unknown year count displays when papers with NULL year exist
- Year filter integrates into existing filter chain (keyword -> journal -> has_abstract -> year)
- Include/exclude unknown year checkbox controls NULL year handling
  </done>
</task>

</tasks>

<verification>
- R/db.R loads without error and contains get_year_distribution, get_unknown_year_count, get_year_bounds functions
- R/mod_search_notebook.R loads without error with all dependencies
- Year filter UI elements are present in the module UI function
- Debounce pattern is used for slider reactivity
- Filter chain includes year range filtering with NULL handling
</verification>

<success_criteria>
- Search notebook displays year range slider with histogram below it
- Slider uses dynamic bounds from database (not hard-coded)
- Dragging slider is smooth (400ms debounce prevents reactive storm)
- Histogram shows paper count distribution by year
- Checkbox controls whether papers with unknown year are included
- Count of unknown-year papers displayed next to checkbox
- Filtered paper list updates based on year range selection
</success_criteria>

<output>
After completion, create `.planning/phases/17-year-range-filter/17-01-SUMMARY.md`
</output>
