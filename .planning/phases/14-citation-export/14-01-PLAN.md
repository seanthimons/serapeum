---
phase: 14-citation-export
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - R/utils_citation.R
  - tests/testthat/test-utils_citation.R
autonomous: true
user_setup: []

must_haves:
  truths:
    - "BibTeX entries have all LaTeX special characters escaped ({, }, \\, %, #, &, _, ^, ~, $)"
    - "Citation keys are unique across a batch of papers (author_year with a/b/c suffix for collisions)"
    - "Papers without DOI get fallback citation keys from title+year"
    - "Diacritics in author names are removed for citation keys (Muller not Mueller)"
    - "BibTeX month field uses unquoted three-letter abbreviations (jan, feb, etc.)"
    - "CSV export includes all available metadata fields with UTF-8 encoding"
  artifacts:
    - path: "R/utils_citation.R"
      provides: "BibTeX and CSV formatting functions"
      exports: ["escape_latex", "format_bibtex_entry", "generate_bibtex_key", "generate_bibtex_batch", "format_csv_export"]
    - path: "tests/testthat/test-utils_citation.R"
      provides: "Unit tests for citation utilities"
      min_lines: 40
  key_links:
    - from: "R/utils_citation.R"
      to: "R/utils_doi.R"
      via: "generate_citation_key function (existing fallback)"
      pattern: "generate_citation_key"
    - from: "R/utils_citation.R"
      to: "stringi"
      via: "stri_trans_general for diacritic removal"
      pattern: "stri_trans_general.*Latin-ASCII"
---

<objective>
Create citation formatting utilities: BibTeX formatter with LaTeX escaping, unique citation key generation with collision detection, and CSV export helper.

Purpose: Provides the core formatting logic that Plan 14-02 will wire to Shiny downloadHandler buttons.
Output: R/utils_citation.R with all export functions, plus unit tests.
</objective>

<execution_context>
@C:/Users/sxthi/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/sxthi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-citation-export/14-RESEARCH.md
@R/utils_doi.R
@R/db.R
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create R/utils_citation.R with BibTeX and CSV formatters</name>
  <files>R/utils_citation.R</files>
  <action>
Create R/utils_citation.R with these functions:

1. **escape_latex(text)** — Escape LaTeX special characters in BibTeX field values.
   Order matters: backslash FIRST, then braces, then %, &, _, ^, ~, $.
   Return NA_character_ for NA/NULL input. Use the exact escaping from the research doc.

2. **extract_first_author_lastname(authors_json)** — Parse the authors JSON string (stored as JSON array of display name strings like "John Smith"), extract the first author, take the last word as the last name. Use stringi::stri_trans_general(name, "Latin-ASCII") to remove diacritics. Return "unknown" if authors_json is NA/NULL/empty or parsing fails.

3. **generate_bibtex_key(authors_json, year, existing_keys = character())** — Generate citation key in format "lastname_year" (all lowercase, alphanumeric only). Check for collisions against existing_keys and append suffix (a, b, c...) if needed. For papers without authors or year, use generate_citation_key() from utils_doi.R as fallback (it uses title+year).

4. **format_bibtex_entry(paper_row, citation_key)** — Takes a single row from list_abstracts() result (data.frame row with columns: title, authors, year, venue, doi, abstract, pdf_url, work_type). Returns a single BibTeX @article{} entry string. Fields:
   - author: Parse JSON authors array, join with " and " (BibTeX author separator). Escape LaTeX chars.
   - title: Escape LaTeX chars. Wrap in double braces {{title}} to preserve capitalization.
   - journal: venue field, escaped. Omit if NA/empty.
   - year: As string in braces.
   - doi: Bare DOI (already stored in bare format from Phase 11). Omit if NA.
   - abstract: Escaped. Omit if NA/empty.
   - url: Only include if doi IS NULL and pdf_url IS NOT NULL (fallback for papers without DOI).
   - month: Omit (OpenAlex doesn't provide month data).
   Note: Do NOT escape the citation key itself. Do NOT put month in braces.

5. **generate_bibtex_batch(papers_df)** — Takes full data.frame from list_abstracts(). Generates unique citation keys for all papers (tracking existing_keys across the batch), then formats each as BibTeX entry. Returns single string with all entries separated by blank lines. Papers without DOI use generate_citation_key(title, year) from utils_doi.R for the key.

6. **format_csv_export(papers_df)** — Takes data.frame from list_abstracts(). Returns a clean data.frame with columns: citation_key, title, authors (display string, not JSON), year, venue, doi, abstract, work_type, oa_status, cited_by_count, fwci, referenced_works_count, pdf_url. Parse the JSON authors field into a semicolon-separated string. Generate citation_key using same logic as BibTeX (call generate_bibtex_batch internally or share the key generation).

Important: stringi should already be installed as a Shiny transitive dependency. If not, add it. Do NOT add RefManageR or any BibTeX library.
  </action>
  <verify>
Run: "C:\Program Files\R\R-4.5.1\bin\Rscript.exe" -e "source('R/utils_citation.R'); source('R/utils_doi.R'); cat(escape_latex('10% of {test} & more_$')); cat('\n'); cat(generate_bibtex_key('[\"Muller, Hans\"]', 2023))"

Expected: Escaped string with \%, \{, \&, \_, \$ and key "muller2023".
  </verify>
  <done>
All 6 functions exist in R/utils_citation.R. escape_latex handles all 9 LaTeX special chars. generate_bibtex_key produces unique keys with collision suffixes. format_bibtex_entry produces valid @article{} entries. format_csv_export returns clean data.frame with parsed authors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add unit tests for citation utilities</name>
  <files>tests/testthat/test-utils_citation.R</files>
  <action>
Create tests/testthat/test-utils_citation.R with tests covering:

1. **escape_latex tests:**
   - All 9 special characters escaped correctly
   - NA input returns NA_character_
   - Normal text passes through unchanged
   - Mixed text with multiple special chars

2. **extract_first_author_lastname tests:**
   - Standard name "John Smith" -> "smith"
   - Accented name with diacritics "Hans Mueller" -> "muller" (via Latin-ASCII)
   - Single name "Madonna" -> "madonna"
   - NA/NULL/empty -> "unknown"
   - Invalid JSON -> "unknown"

3. **generate_bibtex_key tests:**
   - Basic case: '["John Smith"]', 2023 -> "smith2023"
   - Collision: existing_keys = c("smith2023") -> "smith2023a"
   - Double collision: existing_keys = c("smith2023", "smith2023a") -> "smith2023b"
   - NA authors falls back gracefully

4. **format_bibtex_entry tests:**
   - Output starts with @article{
   - Contains escaped title in double braces
   - DOI field present when doi is not NA
   - URL field present when doi IS NA and pdf_url IS NOT NA
   - URL field absent when doi IS present

5. **generate_bibtex_batch tests:**
   - Multiple papers get unique keys (no duplicates)
   - Papers without DOI get title-based fallback keys

6. **format_csv_export tests:**
   - Returns expected column names
   - Authors parsed from JSON to semicolon-separated string
   - citation_key column populated

Source both utils_citation.R and utils_doi.R at the top of the test file (generate_citation_key is in utils_doi.R).
  </action>
  <verify>
Run: "C:\Program Files\R\R-4.5.1\bin\Rscript.exe" -e "testthat::test_file('tests/testthat/test-utils_citation.R')"

All tests pass.
  </verify>
  <done>
All unit tests pass. Coverage includes: LaTeX escaping edge cases, citation key collision handling, BibTeX entry formatting, CSV export column structure, and fallback behavior for papers without DOI.
  </done>
</task>

</tasks>

<verification>
1. `"C:\Program Files\R\R-4.5.1\bin\Rscript.exe" -e "testthat::test_file('tests/testthat/test-utils_citation.R')"` — all tests pass
2. `"C:\Program Files\R\R-4.5.1\bin\Rscript.exe" -e "source('R/utils_citation.R'); source('R/utils_doi.R'); papers <- data.frame(title='Test Paper', authors='[\"John Smith\"]', year=2023, venue='J Test', doi='10.1234/test', abstract='An abstract.', pdf_url=NA, work_type='article', oa_status='gold', cited_by_count=5, fwci=1.2, referenced_works_count=10, stringsAsFactors=FALSE); cat(generate_bibtex_batch(papers))"` — produces valid BibTeX output
</verification>

<success_criteria>
- R/utils_citation.R contains all 6 functions
- LaTeX escaping handles all 9 special characters
- Citation keys are unique within a batch (collision suffix works)
- Papers without DOI get title+year fallback keys
- Unit tests all pass
- No new library dependencies added (uses stringi which is already available)
</success_criteria>

<output>
After completion, create `.planning/phases/14-citation-export/14-01-SUMMARY.md`
</output>
