---
phase: 14-citation-export
plan: 02
type: execute
wave: 2
depends_on: ["14-01"]
files_modified:
  - R/mod_search_notebook.R
autonomous: false

must_haves:
  truths:
    - "User can download search results as BibTeX file from the search notebook"
    - "User can download search results as CSV file from the search notebook"
    - "Downloaded BibTeX file has .bib extension and UTF-8 encoding"
    - "Downloaded CSV file has .csv extension and UTF-8 encoding"
    - "Export buttons are visible in the search notebook UI near the paper list"
    - "Export works with papers that have special characters in titles/authors"
  artifacts:
    - path: "R/mod_search_notebook.R"
      provides: "Download buttons and downloadHandler server logic for BibTeX and CSV export"
      contains: "downloadHandler"
  key_links:
    - from: "R/mod_search_notebook.R"
      to: "R/utils_citation.R"
      via: "generate_bibtex_batch and format_csv_export calls"
      pattern: "generate_bibtex_batch|format_csv_export"
    - from: "R/mod_search_notebook.R"
      to: "R/db.R"
      via: "filtered_papers() reactive provides paper data"
      pattern: "filtered_papers"
---

<objective>
Wire BibTeX and CSV export buttons into the search notebook module UI, connecting downloadHandler to the citation formatters from Plan 14-01.

Purpose: Users can download their search results as .bib or .csv files directly from the search notebook interface.
Output: Updated R/mod_search_notebook.R with export download functionality.
</objective>

<execution_context>
@C:/Users/sxthi/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/sxthi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-citation-export/14-RESEARCH.md
@.planning/phases/14-citation-export/14-01-SUMMARY.md
@R/mod_search_notebook.R
@R/utils_citation.R
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add export download buttons and handlers to search notebook</name>
  <files>R/mod_search_notebook.R</files>
  <action>
Modify R/mod_search_notebook.R to add citation export functionality:

**UI changes (in mod_search_notebook_ui):**

Add an export dropdown/buttons in the left panel card header, next to the existing "Edit Search" and "Refresh" buttons. Use a Bootstrap dropdown button group:

```r
# Add to the d-flex gap-2 div in the Papers card header, BEFORE the edit/refresh buttons:
div(
  class = "btn-group btn-group-sm",
  tags$button(
    class = "btn btn-outline-primary dropdown-toggle",
    `data-bs-toggle` = "dropdown",
    icon("download"), " Export"
  ),
  tags$ul(
    class = "dropdown-menu",
    tags$li(downloadLink(ns("download_bibtex"), class = "dropdown-item", icon("file-code"), " BibTeX (.bib)")),
    tags$li(downloadLink(ns("download_csv"), class = "dropdown-item", icon("file-csv"), " CSV (.csv)"))
  )
)
```

Note: Use `downloadLink` (not `downloadButton`) inside dropdown items so they render as menu items, not standalone buttons. Both `downloadLink` and `downloadButton` are standard Shiny functions.

**Server changes (in mod_search_notebook_server):**

Add two downloadHandler outputs that use the `filtered_papers()` reactive (same data the user sees in the paper list):

```r
output$download_bibtex <- downloadHandler(
  filename = function() {
    paste0("citations-", Sys.Date(), ".bib")
  },
  content = function(file) {
    papers <- filtered_papers()
    if (nrow(papers) == 0) {
      writeLines("% No papers to export", file)
      return()
    }
    bibtex_content <- generate_bibtex_batch(papers)
    # Write with UTF-8 encoding, add BOM for compatibility
    con_file <- file(file, "wb")
    writeBin(charToRaw("\xEF\xBB\xBF"), con_file)  # UTF-8 BOM
    writeLines(bibtex_content, con_file, useBytes = TRUE)
    close(con_file)
  }
)

output$download_csv <- downloadHandler(
  filename = function() {
    paste0("citations-", Sys.Date(), ".csv")
  },
  content = function(file) {
    papers <- filtered_papers()
    if (nrow(papers) == 0) {
      write.csv(data.frame(note = "No papers to export"), file, row.names = FALSE)
      return()
    }
    export_df <- format_csv_export(papers)
    write.csv(export_df, file, fileEncoding = "UTF-8", row.names = FALSE)
  }
)
```

Key details:
- Export the FILTERED papers (what user currently sees), not all papers in notebook
- BibTeX file gets UTF-8 BOM for Zotero/Mendeley compatibility
- CSV file uses write.csv with fileEncoding="UTF-8"
- Empty state: write a comment/note rather than failing
- No need to source utils_citation.R explicitly — Shiny sources all R/ files automatically
  </action>
  <verify>
Run the Shiny app: `"C:\Program Files\R\R-4.5.1\bin\Rscript.exe" -e "shiny::runApp('.', port=3838, launch.browser=FALSE)"` and verify the Export dropdown appears in the search notebook Papers card header.
  </verify>
  <done>
Export dropdown with BibTeX and CSV options visible in search notebook. Both download links wired to downloadHandler using filtered_papers() data.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify citation export downloads work correctly</name>
  <what-built>Citation export functionality: Export dropdown in search notebook with BibTeX (.bib) and CSV (.csv) download options. Downloads use filtered papers (respects keyword/journal/abstract filters).</what-built>
  <how-to-verify>
    1. Open the app at http://localhost:3838
    2. Navigate to a search notebook with papers loaded
    3. Verify "Export" dropdown button appears in the Papers card header
    4. Click Export -> BibTeX (.bib) — should download a .bib file
    5. Open the .bib file in a text editor — verify @article entries with escaped special chars, unique citation keys
    6. Click Export -> CSV (.csv) — should download a .csv file
    7. Open the .csv file — verify columns: citation_key, title, authors (readable names, not JSON), year, venue, doi, etc.
    8. (Optional) Import the .bib file into Zotero/Mendeley to verify it parses correctly
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues</resume-signal>
</task>

</tasks>

<verification>
1. Export dropdown visible in search notebook UI
2. BibTeX download produces valid .bib file with @article entries
3. CSV download produces .csv with all metadata columns and readable author names
4. Both exports respect current filters (keyword, journal, abstract filters)
5. Papers without DOI included in export with fallback citation keys
6. Special characters in titles/authors properly escaped in BibTeX
</verification>

<success_criteria>
- Export dropdown with BibTeX and CSV options visible in search notebook
- BibTeX file downloads with .bib extension, contains @article entries, UTF-8 encoded
- CSV file downloads with .csv extension, contains all metadata columns, UTF-8 encoded
- Citation keys are unique across the exported batch
- Papers with special characters (accents, symbols) export correctly
- Papers without DOI export with fallback citation keys
</success_criteria>

<output>
After completion, create `.planning/phases/14-citation-export/14-02-SUMMARY.md`
</output>
