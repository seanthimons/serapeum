---
phase: 01-seed-paper-discovery
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - R/mod_search_notebook.R
  - R/db.R
  - R/rag.R
  - R/_ragnar.R
  - tests/testthat/test-embedding.R
autonomous: true

must_haves:
  truths:
    - "Embed Papers button in search notebooks creates ragnar index entries for abstracts"
    - "RAG chat in search notebooks returns relevant results from embedded abstracts"
    - "Legacy fallback path embeds abstract chunks and retrieves them by cosine similarity"
    - "Both ragnar and legacy paths work for abstract-sourced chunks"
  artifacts:
    - path: "R/mod_search_notebook.R"
      provides: "Fixed embedding logic for abstracts"
      contains: "source_type.*abstract"
    - path: "R/db.R"
      provides: "search_chunks_hybrid correctly filters and returns abstract results"
      contains: "search_chunks_hybrid"
    - path: "R/rag.R"
      provides: "RAG query correctly handles abstract chunks in context building"
      contains: "build_context"
    - path: "tests/testthat/test-embedding.R"
      provides: "Tests proving abstract embedding and retrieval work"
  key_links:
    - from: "R/mod_search_notebook.R (embed_papers handler)"
      to: "R/_ragnar.R (insert_chunks_to_ragnar)"
      via: "ragnar indexing of abstract chunks"
      pattern: "insert_chunks_to_ragnar.*abstract"
    - from: "R/db.R (search_chunks_hybrid)"
      to: "R/_ragnar.R (retrieve_with_ragnar)"
      via: "notebook-scoped hybrid search returning abstract results"
      pattern: "abstract_id.*notebook_abstracts"
    - from: "R/rag.R (rag_query)"
      to: "R/db.R (search_chunks_hybrid)"
      via: "RAG pipeline querying abstracts via hybrid search"
      pattern: "search_chunks_hybrid"
---

<objective>
Fix abstract embedding bug (#55) so "Embed Papers" button in search notebooks correctly embeds abstracts and RAG chat returns relevant results.

Purpose: This is a critical bug that blocks all search notebook chat functionality. Without this fix, users cannot use RAG chat with papers found via search -- the core interaction loop. Must be fixed before any new discovery features.

Output: Working abstract embedding pipeline (ragnar + legacy fallback) with tests proving both paths work.
</objective>

<execution_context>
@C:/Users/sxthi/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/sxthi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-seed-paper-discovery/01-RESEARCH.md
@R/mod_search_notebook.R
@R/db.R
@R/rag.R
@R/_ragnar.R
@R/api_openrouter.R
</context>

<tasks>

<task type="auto">
  <name>Task 1: Diagnose and fix abstract embedding pipeline</name>
  <files>R/mod_search_notebook.R, R/db.R, R/_ragnar.R, R/rag.R</files>
  <action>
Investigate and fix the abstract embedding bug (#55). The bug manifests as: "Embed Papers" button appears to work but RAG chat says "no relevant context found" for embedded papers.

**Investigation steps (read code carefully before changing anything):**

1. **Trace the embed flow in mod_search_notebook.R (lines 1474-1583):**
   - The ragnar path (lines 1505-1547) queries abstracts by ID, creates chunks with `origin = "abstract:{id}"`, and calls `insert_chunks_to_ragnar()`. Verify this actually inserts and that `build_ragnar_index()` is called after all inserts.
   - The legacy fallback (lines 1549-1576) queries the `chunks` table for `source_id IN (paper_ids) AND embedding IS NULL`. Check: are `paper_ids` the abstract table IDs? They come from `papers_with_abstract$id` which is the `abstracts.id` column. Chunks are created at line 1460 with `create_chunk(con(), abstract_id, "abstract", 0, paper$abstract)` where `abstract_id` is the return of `create_abstract()`. So yes, `source_id` in chunks matches `abstracts.id`. This path should work.

2. **Trace the retrieval flow in rag.R (rag_query, lines 62-144):**
   - `search_chunks_hybrid()` is called first. If it fails or returns empty, falls back to legacy `search_chunks()`.
   - Check: Does `search_chunks_hybrid` in db.R actually return abstract results correctly?

3. **Key suspect: search_chunks_hybrid in db.R (lines 709-807):**
   - At line 738-741, it extracts `abstract_id` from origin string `"abstract:{id}"` using `sub("^abstract:", "", origin)`. This returns a string.
   - At line 741, it checks `abstract_id %in% notebook_abstracts$id`. But `notebook_abstracts$id` comes from a DuckDB query -- **verify the type**. If `abstracts.id` is a UUID string (from `uuid::UUIDgenerate()`), both sides are strings and this should match. If there's a type mismatch (e.g., one is factor), this would silently return no results.
   - Also check: after ragnar search, does it correctly map `"text"` column to `"content"` column? (line 782-783 handles this, but verify.)

4. **Likely fixes needed:**
   - In `search_chunks_hybrid`: Ensure `abstract_id` string comparison works by coercing both sides to character: `as.character(abstract_id) %in% as.character(notebook_abstracts$id)`
   - In `retrieve_with_ragnar` (_ragnar.R line 241): The `abstract_title` is hardcoded to `"[Abstract]"` -- this means `build_context` in rag.R will show `[Abstract]` instead of the actual paper title. While `search_chunks_hybrid` later looks up real titles (lines 752-776), verify this lookup actually works.
   - Check if `retrieve_with_ragnar` returns a `content` column or `text` column. The ragnar package returns `text`. The `search_chunks_hybrid` function renames it at line 782. But `rag_query` passes results to `build_context` which expects a `content` column. Verify this rename happens before `build_context` is called.

5. **Apply fixes and verify the full round-trip:**
   - Create abstract -> create chunk -> embed (ragnar or legacy) -> query via RAG chat -> get relevant results with proper citation labels

**Important constraints:**
- Do NOT expand mod_search_notebook.R with new features. Only fix the embedding bug.
- Do NOT change the deferred embedding pattern (user must click "Embed Papers" button).
- Test both ragnar and legacy paths. The legacy path is the fallback when ragnar is unavailable.
- Use `message("[embedding-fix]")` prefix for any debug logging added.
  </action>
  <verify>
Run existing tests to ensure no regressions:
```
"C:\Program Files\R\R-4.5.1\bin\Rscript.exe" -e "testthat::test_dir('tests/testthat')"
```
All existing tests must pass.
  </verify>
  <done>
The embedding pipeline correctly handles abstract chunks in both ragnar and legacy paths. Type mismatches are resolved. Column naming is consistent through the retrieval chain. RAG chat can find and cite embedded abstract content.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add embedding round-trip tests</name>
  <files>tests/testthat/test-embedding.R</files>
  <action>
Create a test file that verifies the abstract embedding and retrieval pipeline works end-to-end. These tests should validate the fixes from Task 1.

**Test cases to implement:**

1. **test "abstract chunks are created with correct source_type"**
   - Create a test notebook (type = "search")
   - Create an abstract with `create_abstract()`
   - Create a chunk with `create_chunk(con, abstract_id, "abstract", 0, "test abstract text")`
   - Query chunks table: verify `source_type = 'abstract'` and `source_id = abstract_id`

2. **test "search_chunks finds abstract chunks by notebook"**
   - Create notebook, abstract, and chunk with a known embedding string
   - Update the chunk's embedding to a fake embedding vector (comma-separated numbers)
   - Call `search_chunks(con, query_embedding, notebook_id)` with a matching fake query embedding
   - Verify: result has rows, `source_type == 'abstract'`, `abstract_title` is not NA

3. **test "search_chunks_hybrid filters abstracts by notebook"**
   - This test should verify the notebook filtering logic in `search_chunks_hybrid`
   - Create two notebooks with different abstracts
   - Verify that querying notebook A only returns notebook A's abstracts
   - Note: This test may need to mock ragnar or test only the legacy path if ragnar is not available in test environment. Use `skip_if(!ragnar_available(), "ragnar not installed")` for ragnar-specific tests.

4. **test "build_context formats abstract citations correctly"**
   - Create a data frame mimicking search results with `abstract_title`, `content`, `page_number`, `doc_name = NA`
   - Call `build_context()` and verify output contains the abstract title in citation format `[Paper Title]`

**Test setup pattern (follow existing test-db.R):**
```r
test_that("description", {
  db_path <- tempfile(fileext = ".duckdb")
  con <- get_db_connection(db_path)
  on.exit({
    close_db_connection(con)
    unlink(db_path)
  })
  # ... test body
})
```

Use `testthat::expect_*` assertions. Follow existing naming conventions from test-db.R and test-db-migrations.R.
  </action>
  <verify>
```
"C:\Program Files\R\R-4.5.1\bin\Rscript.exe" -e "testthat::test_file('tests/testthat/test-embedding.R')"
```
All new tests pass. Then run full suite:
```
"C:\Program Files\R\R-4.5.1\bin\Rscript.exe" -e "testthat::test_dir('tests/testthat')"
```
No regressions.
  </verify>
  <done>
At least 4 test cases pass covering: chunk creation with abstract source_type, legacy search finding abstract chunks, notebook-scoped filtering, and context formatting with abstract citations.
  </done>
</task>

</tasks>

<verification>
1. All existing tests pass (no regressions from embedding fix)
2. New embedding tests pass (at least 4 test cases)
3. Manual verification path (for later checkpoint): Start app -> create search notebook -> search for papers -> click "Embed Papers" -> ask a question in chat -> get relevant answer citing paper titles
</verification>

<success_criteria>
- "Embed Papers" button creates searchable index entries for abstract chunks
- RAG chat returns relevant results from embedded abstracts with proper paper title citations
- Both ragnar and legacy embedding/retrieval paths handle abstracts correctly
- Test suite covers the full abstract embedding round-trip
- No regressions in existing functionality
</success_criteria>

<output>
After completion, create `.planning/phases/01-seed-paper-discovery/01-01-SUMMARY.md`
</output>
