---
phase: 01-seed-paper-discovery
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - R/api_openalex.R
  - R/mod_seed_discovery.R
  - app.R
autonomous: false

must_haves:
  truths:
    - "User can enter a DOI or paper title and see the paper's metadata"
    - "User can fetch papers that cite, are cited by, or are related to the seed paper"
    - "Related papers populate a search notebook where existing filtering and quality checks apply"
  artifacts:
    - path: "R/mod_seed_discovery.R"
      provides: "Seed paper discovery module UI and server"
      exports: ["mod_seed_discovery_ui", "mod_seed_discovery_server"]
      min_lines: 100
    - path: "R/api_openalex.R"
      provides: "Citation API functions and DOI normalization"
      contains: "get_citing_papers|normalize_doi"
    - path: "app.R"
      provides: "Discovery module wired into main app with notebook creation"
      contains: "mod_seed_discovery"
  key_links:
    - from: "R/mod_seed_discovery.R"
      to: "R/api_openalex.R"
      via: "DOI lookup and citation fetching"
      pattern: "get_paper|get_citing_papers|get_cited_papers|get_related_papers"
    - from: "R/mod_seed_discovery.R"
      to: "app.R"
      via: "Producer-consumer reactive: discovery_request consumed by app.R to create search notebook"
      pattern: "discovery_request|create_notebook"
    - from: "app.R"
      to: "R/mod_search_notebook.R"
      via: "Created notebook opens in existing search notebook module"
      pattern: "current_notebook|current_view"
---

<objective>
Build seed paper discovery: user enters a DOI/title, sees paper metadata, fetches citation relationships, and results populate a search notebook.

Purpose: This is the first discovery mode -- starting from a known paper to find related work. It validates the producer-consumer architecture where discovery modules output to search notebooks. This pattern will be reused by Phase 2 (query builder) and Phase 3 (topic explorer).

Output: Working mod_seed_discovery.R module, extended api_openalex.R with citation functions, and app.R wiring.
</objective>

<execution_context>
@C:/Users/sxthi/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/sxthi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-seed-paper-discovery/01-RESEARCH.md
@.planning/phases/01-seed-paper-discovery/01-01-SUMMARY.md
@R/api_openalex.R
@R/mod_search_notebook.R
@R/mod_document_notebook.R
@app.R
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add citation API functions and DOI normalization to api_openalex.R</name>
  <files>R/api_openalex.R</files>
  <action>
Add the following functions to R/api_openalex.R:

**1. `normalize_doi(input)`**
- Accepts DOI in various formats: plain DOI (`10.xxxx/yyyy`), with prefix (`doi:10.xxxx/yyyy`), HTTP/HTTPS URLs (`http://doi.org/...`, `https://dx.doi.org/...`), or full OpenAlex URLs
- Strip `doi:` prefix (case-insensitive)
- Replace `dx.doi.org` with `doi.org`
- Replace `http://` with `https://`
- Extract DOI from URL path if URL provided
- Validate format: must start with `10.\d{4,}/\S+` after normalization
- Return `https://doi.org/{doi}` format, or NULL if invalid
- Also handle OpenAlex Work IDs: if input starts with `W` followed by digits, return as-is (for internal use)

**2. `get_citing_papers(paper_id, email, api_key, per_page = 25)`**
- Fetch papers that cite the given work using OpenAlex `cites:{paper_id}` filter
- `paper_id` should be OpenAlex ID format (e.g., `W2741809807`). Add `W` prefix if missing.
- Use existing `build_openalex_request("works", email, api_key)` pattern
- Add `filter = paste0("cites:", paper_id)` and `per_page` query params
- Parse results with existing `parse_openalex_work()`
- Return list of parsed works, or empty list on error
- Include total count from `body$meta$count` as attribute: `attr(results, "total_count") <- body$meta$count`

**3. `get_cited_papers(paper_id, email, api_key, per_page = 25)`**
- Same pattern as above but with `cited_by:{paper_id}` filter (papers cited BY the given work = outgoing references)

**4. `get_related_papers(paper_id, email, api_key, per_page = 25)`**
- Same pattern but with `related_to:{paper_id}` filter (algorithmically related works)

**Error handling:** Use tryCatch with descriptive error messages. On API error, return empty list (not NULL) so callers can safely check `length(results)`.

**Important:** The existing `get_paper()` function already fetches a single paper by ID/DOI. Verify it works with the normalized DOI URL format from `normalize_doi()`. It currently does `paste0("https://openalex.org/", paper_id)` which won't work for DOI URLs. Update `get_paper()` to handle DOI URLs: if the input starts with `https://doi.org/`, use it directly as a filter parameter instead of appending to the OpenAlex base URL. The correct OpenAlex API call for DOI lookup is: `GET https://api.openalex.org/works/https://doi.org/10.xxxx/yyyy`
  </action>
  <verify>
```
"C:\Program Files\R\R-4.5.1\bin\Rscript.exe" -e "testthat::test_dir('tests/testthat')"
```
No regressions. Optionally test DOI normalization manually:
```
"C:\Program Files\R\R-4.5.1\bin\Rscript.exe" -e "source('R/api_openalex.R'); cat(normalize_doi('10.7717/peerj.4375'), '\n'); cat(normalize_doi('doi:10.7717/peerj.4375'), '\n'); cat(normalize_doi('https://dx.doi.org/10.7717/peerj.4375'), '\n')"
```
All three should output `https://doi.org/10.7717/peerj.4375`.
  </verify>
  <done>
- `normalize_doi()` handles all common DOI formats and returns consistent `https://doi.org/` format
- `get_citing_papers()`, `get_cited_papers()`, `get_related_papers()` fetch citation relationships via OpenAlex filters
- `get_paper()` works with DOI URLs from `normalize_doi()`
- Total count available as attribute on results
  </done>
</task>

<task type="auto">
  <name>Task 2: Create seed paper discovery module and wire into app</name>
  <files>R/mod_seed_discovery.R, app.R</files>
  <action>
**Part A: Create R/mod_seed_discovery.R**

Build a new Shiny module following existing conventions (see mod_document_notebook.R for patterns). This module is a "producer" -- it outputs a discovery request that app.R consumes to create a search notebook.

**UI (`mod_seed_discovery_ui`):**
- Use `bslib::card()` layout consistent with existing modules
- Card header: "Discover from a Paper"
- DOI input: `textInput(ns("doi_input"), "Enter DOI or DOI URL", placeholder = "10.1234/abcd or https://doi.org/10.1234/abcd")`
- Lookup button: `actionButton(ns("lookup_btn"), "Look Up", class = "btn-primary")`
- Paper preview area: `uiOutput(ns("paper_preview"))` -- shows title, authors (first 3 + "et al."), year, abstract snippet (first 200 chars), venue
- Citation controls area: `uiOutput(ns("citation_controls"))` -- appears after successful lookup
  - Show citation counts from seed paper metadata: "Cited by: N papers | References: M papers"
  - Radio buttons for citation type: "Papers citing this work" (cites), "Papers cited by this work" (cited_by), "Related papers" (related_to)
  - Fetch button: `actionButton(ns("fetch_btn"), "Create Notebook with Results", class = "btn-success")`
- Error/loading states: Show notification on invalid DOI, show progress during lookup

**Server (`mod_seed_discovery_server(id, con, config)`):**
- Parameters: `id`, `con` (reactive db connection), `config` (reactive config)
- Internal state:
  - `seed_paper <- reactiveVal(NULL)` -- stores looked-up paper
  - `discovery_request <- reactiveVal(NULL)` -- stores the request for app.R
- On lookup button click:
  1. Normalize DOI with `normalize_doi(input$doi_input)`
  2. Show error notification if NULL (invalid format)
  3. Get email and api_key from config
  4. Call `get_paper(doi, email, api_key)` -- handle error with notification
  5. Set `seed_paper(paper)` on success
- Paper preview renderUI: Display seed paper metadata when `seed_paper()` is not NULL
- Citation controls renderUI: Display radio buttons and fetch button when `seed_paper()` is not NULL
  - Use `seed_paper()$cited_by_count` and `seed_paper()$referenced_works_count` for counts
- On fetch button click:
  1. Get seed paper's OpenAlex ID: `seed_paper()$paper_id`
  2. Get selected citation type: `input$citation_type`
  3. Set `discovery_request()` with: `list(seed_paper = seed_paper(), citation_type = input$citation_type, notebook_name = paste(label, seed_paper()$title))`
  4. Labels: cites = "Citing:", cited_by = "Cited by:", related_to = "Related to:"
- Return: `discovery_request` reactive (the producer output)

**Part B: Wire into app.R**

1. **Add discovery UI to sidebar:** Add a new button below the existing notebook buttons:
```r
actionButton("discover_paper", "Discover from Paper",
             class = "btn-outline-success",
             icon = icon("seedling"))
```

2. **Add discovery view to main content routing:** In the `output$main_content` renderUI (find the conditional that checks `current_view()`), add a new case for `"discover"`:
```r
} else if (view == "discover") {
  mod_seed_discovery_ui("seed_discovery")
}
```

3. **Wire the sidebar button:**
```r
observeEvent(input$discover_paper, {
  current_view("discover")
})
```

4. **Initialize module server:**
```r
discovery_request <- mod_seed_discovery_server("seed_discovery", reactive(con), config_file_r)
```
Note: `con` is the raw connection in app.R, wrap in `reactive()`. `config_file_r` is already a reactive.

5. **Consume discovery request to create search notebook:**
```r
observeEvent(discovery_request(), {
  req <- discovery_request()
  if (is.null(req)) return()

  # Build filter for the citation query
  citation_filter <- paste0(req$citation_type, ":", req$seed_paper$paper_id)

  # Create notebook with citation filter
  filters <- list(
    citation_filter = citation_filter,
    citation_type = req$citation_type,
    seed_paper_id = req$seed_paper$paper_id
  )

  nb_id <- create_notebook(con, req$notebook_name, "search",
                           search_query = NULL,
                           search_filters = filters)

  # Fetch citation results and populate notebook
  email <- get_setting(config_file, "openalex", "email")
  api_key <- get_setting(config_file, "openalex", "api_key")

  withProgress(message = "Fetching related papers...", {
    papers <- switch(req$citation_type,
      cites = get_citing_papers(req$seed_paper$paper_id, email, api_key),
      cited_by = get_cited_papers(req$seed_paper$paper_id, email, api_key),
      related_to = get_related_papers(req$seed_paper$paper_id, email, api_key)
    )

    if (length(papers) > 0) {
      for (paper in papers) {
        # Check for duplicate
        existing <- dbGetQuery(con, "SELECT id FROM abstracts WHERE notebook_id = ? AND paper_id = ?",
                               list(nb_id, paper$paper_id))
        if (nrow(existing) > 0) next

        abstract_id <- create_abstract(
          con, nb_id, paper$paper_id, paper$title,
          paper$authors, paper$abstract,
          paper$year, paper$venue, paper$pdf_url,
          keywords = paper$keywords,
          work_type = paper$work_type,
          work_type_crossref = paper$work_type_crossref,
          oa_status = paper$oa_status,
          is_oa = paper$is_oa,
          cited_by_count = paper$cited_by_count,
          referenced_works_count = paper$referenced_works_count,
          fwci = paper$fwci
        )

        if (!is.na(paper$abstract) && nchar(paper$abstract) > 0) {
          create_chunk(con, abstract_id, "abstract", 0, paper$abstract)
        }
      }
    }

    incProgress(1.0)
  })

  # Navigate to the new notebook
  notebook_refresh(notebook_refresh() + 1)
  current_notebook(nb_id)
  current_view("notebook")

  showNotification(
    paste("Created notebook with", length(papers), "papers"),
    type = "message"
  )
})
```

**Important constraints:**
- Do NOT modify mod_search_notebook.R. The search notebook module already handles displaying abstracts, filtering, embedding, and chat. The new notebook created here will be consumed by the existing module.
- Follow existing code style: 2-space indent, double quotes, snake_case, roxygen2 comments.
- Use `ns()` for all input/output IDs in the module.
- The `config` parameter should accept a reactive (consistent with how modules receive config in the codebase -- check mod_document_notebook.R and mod_search_notebook.R for the pattern).
  </action>
  <verify>
```
"C:\Program Files\R\R-4.5.1\bin\Rscript.exe" -e "testthat::test_dir('tests/testthat')"
```
No regressions. Then verify the app loads without errors:
```
"C:\Program Files\R\R-4.5.1\bin\Rscript.exe" -e "source('R/config.R'); source('R/db.R'); for (f in list.files('R', pattern = '\\.R$', full.names = TRUE)) source(f); cat('All R files source without error\n')"
```
  </verify>
  <done>
- mod_seed_discovery.R exists with UI showing DOI input, paper preview, and citation controls
- api_openalex.R has normalize_doi, get_citing_papers, get_cited_papers, get_related_papers
- app.R has "Discover from Paper" button in sidebar, discovery view in main content, producer-consumer wiring
- Citation results populate a search notebook that opens with existing filtering/embedding/chat capabilities
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify complete seed paper discovery flow</name>
  <what-built>
Complete seed paper discovery flow: DOI lookup, paper preview, citation fetching, and notebook creation with results that support filtering, embedding, and RAG chat.
  </what-built>
  <how-to-verify>
1. Start the app: Run `shiny::runApp()` in the Serapeum directory
2. Click "Discover from Paper" in the sidebar
3. Enter a DOI (e.g., `10.7717/peerj.4375`) and click "Look Up"
4. Verify: Paper title, authors, year, and abstract snippet are displayed
5. Verify: Citation counts are shown (e.g., "Cited by: N papers")
6. Select "Papers citing this work" and click "Create Notebook with Results"
7. Verify: A new search notebook is created and opened with papers
8. Verify: Papers have titles, authors, years, and abstracts visible
9. Click "Embed Papers" to embed the abstracts
10. Ask a question in the chat about one of the paper topics
11. Verify: RAG chat returns a relevant answer citing paper titles (not just "[Abstract]")
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues found</resume-signal>
</task>

</tasks>

<verification>
1. All existing tests pass (no regressions)
2. New embedding tests from 01-01 still pass
3. `normalize_doi()` handles all DOI format variants
4. Discovery module renders without errors
5. Citation results populate search notebook correctly
6. Full flow works: discover -> embed -> chat with citations
</verification>

<success_criteria>
- User can enter a DOI and see paper metadata (title, authors, year, abstract)
- User can choose citation direction (citing, cited by, related) and fetch results
- Results appear in a search notebook where existing filtering, quality checks, embedding, and RAG chat work
- Producer-consumer pattern validated: discovery module outputs, app.R creates notebook, search notebook module displays
</success_criteria>

<output>
After completion, create `.planning/phases/01-seed-paper-discovery/01-02-SUMMARY.md`
</output>
