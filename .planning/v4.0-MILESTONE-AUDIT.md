---
milestone: v4.0
audited: 2026-02-19
status: gaps_found
scores:
  requirements: 13/15
  phases: 3/4
  integration: 11/12
  flows: 3/4
gaps:
  requirements:
    - "SYNTH-01: Unified Overview preset — Phase 26 never executed"
    - "SYNTH-02: Literature Review Table — config accessor bug prevents function from reaching LLM call"
  integration:
    - "generate_lit_review_table uses config$api_key (flat access) instead of get_setting(config, 'openrouter', 'api_key') — always returns 'API key not configured'"
  flows:
    - "Search → Import → Lit Review: broken at generate_lit_review_table config extraction"
tech_debt:
  - phase: 25-stabilize
    items:
      - "Secondary ragnar leak: ensure_ragnar_store() in mod_search_notebook.R L2061 — store opened for indexing but never explicitly closed"
      - "Pre-existing test failures: 13 tests fail due to missing schema columns (section_hint, doi) in test fixtures"
  - phase: 28-literature-review-table
    items:
      - "config$api_key flat accessor must be replaced with get_setting() to match all other rag.R functions"
---

# v4.0 Stability + Synthesis — Milestone Audit

**Audited:** 2026-02-19
**Status:** gaps_found
**Milestone Goal:** Stabilize the codebase after rapid v1.0–v3.0 shipping, then deliver the highest-value AI synthesis outputs leveraging v3.0's ragnar infrastructure.

## Requirements Coverage

| Requirement | Phase | Status | Notes |
|-------------|-------|--------|-------|
| BUGF-01 | 25 | SATISFIED | Seed paper inserted + pinned to row 1 |
| BUGF-02 | 25 | SATISFIED | Observer dedup prevents repeated modals |
| BUGF-03 | 25 | SATISFIED | Live pricing at startup via once=TRUE observer |
| BUGF-04 | 25 | SATISFIED | newly_added counter shows correct count |
| DEBT-01 | 25 | SATISFIED | own_store + on.exit in search_chunks_hybrid |
| DEBT-02 | 25 | SATISFIED | section_hint encoded with column presence guard |
| DEBT-03 | 25 | SATISFIED | with_ragnar_store + register_ragnar_cleanup deleted |
| UIPX-01 | 25 | SATISFIED | PR 112 observer dedup applied |
| UIPX-02 | 25 | SATISFIED | PR 115 collapsible keywords merged |
| UIPX-03 | 25 | SATISFIED | MutationObserver tooltip containment |
| UIPX-04 | 25 | SATISFIED | Theme-aware #e8e8ee / #1e1e2e background |
| UIPX-05 | 25 | SATISFIED | layout_columns(col_widths = c(6, 6)) |
| SYNTH-01 | 26 | **UNSATISFIED** | Phase 26 never executed — no Unified Overview preset |
| SYNTH-02 | 28 | **PARTIAL** | Code exists but config accessor bug prevents execution |
| SYNTH-03 | 27 | SATISFIED | Research Questions with PICO framing |

**Score:** 13/15 requirements satisfied

## Phase Verification Summary

| Phase | Status | Score | Notes |
|-------|--------|-------|-------|
| 25: Stabilize | passed | 10/10 | All bugs fixed, tech debt resolved |
| 26: Unified Overview | **NOT EXECUTED** | — | Phase directory does not exist |
| 27: Research Questions | passed | 3/3 | Standalone function, correctly wired |
| 28: Literature Review Table | passed | 7/7 | Code verified but integration test found config bug |

**Score:** 3/4 phases verified (1 not executed)

## Cross-Phase Integration

| Connection | Status |
|------------|--------|
| Phase 25 connection fix → Phase 27 search_chunks_hybrid | CONNECTED |
| Phase 25 connection fix → Phase 28 (direct SQL, no ragnar) | N/A (no dependency) |
| Phase 28 migration 008 → create_document metadata params | CONNECTED |
| Phase 28 import workflow → create_document metadata | CONNECTED |
| Phase 28 generate_lit_review_table → documents table metadata | CONNECTED |
| Phase 28 generate_lit_review_table → config extraction | **BROKEN** |
| Phase 27 disclaimer check (search notebook) | CONNECTED |
| Phase 28 disclaimer check (document notebook) | CONNECTED |
| Phase 28 CSS (.lit-review-scroll) vs .chat-markdown | No conflict |
| Phase 28 DOI injection → docs with doi column | CONNECTED |
| Phase 27 + 28 cost logging categories | CONNECTED |
| Phase 25 pricing observer → cost estimates | CONNECTED |

**Score:** 11/12 connections verified

## E2E Flows

| Flow | Status | Break Point |
|------|--------|-------------|
| Search → Research Questions | COMPLETE | — |
| Search → Import → Lit Review | **BROKEN** | config$api_key returns NULL instead of key |
| Stabilize → Synthesis (connection safety) | COMPLETE | — |
| Cost tracking (both new presets) | COMPLETE (pending lit review fix) | — |

**Score:** 3/4 flows complete

## Critical Gap: Config Accessor Bug

**File:** `R/rag.R` lines 621–625
**Impact:** `generate_lit_review_table` always returns "API key not configured" even when key is set

**Root cause:** Function uses `config$api_key` (flat access) but `effective_config()` returns a nested structure where the key lives at `config$openrouter$api_key`. All other rag.R functions use `get_setting(config, "openrouter", "api_key")`.

**Fix:** Replace lines 621–625 with `get_setting()` accessor matching the pattern in `generate_research_questions`, `generate_conclusions_preset`, and `rag_query`.

## Tech Debt

### Phase 25
- Secondary ragnar leak: `ensure_ragnar_store()` in mod_search_notebook.R L2061 opens a store for indexing that is never explicitly closed
- 13 pre-existing test failures from missing schema columns in test fixtures

### Phase 28
- Config accessor bug (blocking — must fix for feature to work)

## Human Verification Pending

From phase verifications, these items need manual visual testing:
1. Citation network tooltip containment (Phase 25)
2. Citation network dark theme background (Phase 25)
3. Settings two-column layout balance (Phase 25)
4. Lit Review table visual rendering in chat (Phase 28)
5. DOI link clickability (Phase 28)
6. AI disclaimer presence on lit review output (Phase 28)
7. Dark theme frozen column appearance (Phase 28)
8. Research Questions end-to-end UI flow (Phase 27)

---
*Audited: 2026-02-19*
*Auditor: Claude (gsd-audit-milestone)*
